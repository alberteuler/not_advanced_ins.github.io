<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","version":"8.5.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta name="description" content="更不更新看心情">
<meta property="og:type" content="website">
<meta property="og:title" content="不先进摸鱼研究所">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="不先进摸鱼研究所">
<meta property="og:description" content="更不更新看心情">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Albert -W">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>不先进摸鱼研究所</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">不先进摸鱼研究所</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">在hexo上的分站</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a></li>
        <li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Albert -W"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Albert -W</p>
  <div class="site-description" itemprop="description">更不更新看心情</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">61</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="mailto:jackwjiong@126.com" title="E-Mail → mailto:jackwjiong@126.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



          </div>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/13/%E5%B9%B6%E8%A1%8C%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1-%E5%A4%A7%E7%BA%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Albert -W">
      <meta itemprop="description" content="更不更新看心情">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不先进摸鱼研究所">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/13/%E5%B9%B6%E8%A1%8C%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1-%E5%A4%A7%E7%BA%B2/" class="post-title-link" itemprop="url">并行程序设计-大纲</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-09-13 20:01:15 / Modified: 21:25:41" itemprop="dateCreated datePublished" datetime="2021-09-13T20:01:15+08:00">2021-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B9%B6%E8%A1%8C/" itemprop="url" rel="index"><span itemprop="name">并行</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="大致脉络"><a href="#大致脉络" class="headerlink" title="大致脉络"></a>大致脉络</h1><p>这本书的所有代码都位于以下连接:<br><a target="_blank" rel="noopener" href="https://parallelprogrammingbook.org/">https://parallelprogrammingbook.org/</a><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">绪论</span><br><span class="line"> |</span><br><span class="line"> ├-理论背景—————┬- PRAM</span><br><span class="line"> |             ├-Amdahl和Gustafson定理</span><br><span class="line"> ├-多线程       └Foster</span><br><span class="line"> |</span><br><span class="line"> ├-并行库----┬-OpenMP</span><br><span class="line"> |          ├-Cuda</span><br><span class="line"> |          └-MPI</span><br><span class="line"> └-统一并行</span><br></pre></td></tr></table></figure></p>
<h1 id="理论背景"><a href="#理论背景" class="headerlink" title="理论背景"></a>理论背景</h1><h2 id="PRAM"><a href="#PRAM" class="headerlink" title="PRAM"></a>PRAM</h2><h2 id="并行计算定律"><a href="#并行计算定律" class="headerlink" title="并行计算定律"></a>并行计算定律</h2><h2 id="Foster"><a href="#Foster" class="headerlink" title="Foster"></a>Foster</h2><h1 id="现代体系结构"><a href="#现代体系结构" class="headerlink" title="现代体系结构"></a>现代体系结构</h1><h2 id="存储层次"><a href="#存储层次" class="headerlink" title="存储层次"></a>存储层次</h2><h2 id="并行性的层次"><a href="#并行性的层次" class="headerlink" title="并行性的层次"></a>并行性的层次</h2><h1 id="多线程编程"><a href="#多线程编程" class="headerlink" title="多线程编程"></a>多线程编程</h1><h1 id="OpenMP"><a href="#OpenMP" class="headerlink" title="OpenMP"></a>OpenMP</h1><h1 id="MPI"><a href="#MPI" class="headerlink" title="MPI"></a>MPI</h1><h1 id="CUDA-统一计算设备架构"><a href="#CUDA-统一计算设备架构" class="headerlink" title="CUDA-统一计算设备架构"></a>CUDA-统一计算设备架构</h1>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/05/VSCode-Depoly/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Albert -W">
      <meta itemprop="description" content="更不更新看心情">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不先进摸鱼研究所">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/05/VSCode-Depoly/" class="post-title-link" itemprop="url">VSCode的C++环境搭建</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-09-05 21:04:32 / Modified: 21:42:27" itemprop="dateCreated datePublished" datetime="2021-09-05T21:04:32+08:00">2021-09-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">实用工具</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="一个项目文件夹的结构"><a href="#一个项目文件夹的结构" class="headerlink" title="一个项目文件夹的结构"></a>一个项目文件夹的结构</h1><p><img src="https://z3.ax1x.com/2021/09/05/hWLMNT.png" alt="image"></p>
<h1 id="配置-vscode-文件夹中的配置文件"><a href="#配置-vscode-文件夹中的配置文件" class="headerlink" title="配置.vscode/文件夹中的配置文件"></a>配置.vscode/文件夹中的配置文件</h1><h2 id="launch-json"><a href="#launch-json" class="headerlink" title="launch.json"></a>launch.json</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Use IntelliSense to learn about possible attributes.</span></span><br><span class="line">    <span class="comment">// Hover to view descriptions of existing attributes.</span></span><br><span class="line">    <span class="comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.2.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Launch Debug&quot;</span>, <span class="comment">//名称</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;cppdbg&quot;</span>, <span class="comment">//调试类型，除使用msvc进行调试外，均为该类型</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;program&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;/build/$&#123;workspaceFolderBasename&#125;&quot;</span>, <span class="comment">//指定C/C++程序位置</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span>: [], <span class="comment">//指定运行参数</span></span><br><span class="line">            <span class="attr">&quot;stopAtEntry&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span>, <span class="comment">//指定工作目录</span></span><br><span class="line">            <span class="attr">&quot;preLaunchTask&quot;</span>: <span class="string">&quot;build&quot;</span>, <span class="comment">//在调试前会先调用build_debug这个task编译构建程序</span></span><br><span class="line">            <span class="attr">&quot;environment&quot;</span>: [],</span><br><span class="line">            <span class="attr">&quot;externalConsole&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;osx&quot;</span>: &#123; <span class="comment">//macOS的特定配置</span></span><br><span class="line">                <span class="comment">// &quot;miDebuggerPath&quot;: &quot;/Applications/Xcode.app/Contents/ Developer/usr/bin/lldb-mi&quot;, //修改使用的lldb-mi，一般不需要修改</span></span><br><span class="line">                <span class="attr">&quot;MIMode&quot;</span>: <span class="string">&quot;lldb&quot;</span> <span class="comment">//指定使用lldb进行调试</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;linux&quot;</span>: &#123; <span class="comment">//linux的特定配置</span></span><br><span class="line">                <span class="attr">&quot;MIMode&quot;</span>: <span class="string">&quot;gdb&quot;</span>, <span class="comment">//指定使用gdb调试</span></span><br><span class="line">                <span class="attr">&quot;setupCommands&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Enable pretty-printing for gdb&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;-enable-pretty-printing&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;ignoreFailures&quot;</span>: <span class="literal">true</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;windows&quot;</span>: &#123; <span class="comment">//windows的特定配置</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;cppvsdbg&quot;</span>, <span class="comment">//指定使用msvc进行调试</span></span><br><span class="line">                <span class="attr">&quot;program&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;/build/$&#123;workspaceFolderBasename&#125;.exe&quot;</span>, <span class="comment">//指定C/C++程序位置</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="tasks-json"><a href="#tasks-json" class="headerlink" title="tasks.json"></a>tasks.json</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// See https://go.microsoft.com/fwlink/?LinkId=733558</span></span><br><span class="line">    <span class="comment">// for the documentation about the tasks.json format</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;2.0.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;tasks&quot;</span>: [</span><br><span class="line">        &#123; <span class="comment">// 在根文件夹中执行创建文件夹build的命令</span></span><br><span class="line">            <span class="comment">// 除windows系统外执行的命令为`mkdir -p build`</span></span><br><span class="line">            <span class="comment">// windows系统是在powershell中执行命令`mkdir -Force build`</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span>: <span class="string">&quot;build_dir&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;mkdir&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;shell&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;args&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;-p&quot;</span>,</span><br><span class="line">                <span class="string">&quot;build&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;windows&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;shell&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;executable&quot;</span>: <span class="string">&quot;powershell.exe&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;args&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;-Force&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;build&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123; <span class="comment">// 在build文件夹中调用cmake进行项目配置</span></span><br><span class="line">            <span class="comment">// 除windows系统外执行的命令为`cmake -DCMAKE_BUILD_TYPE=&lt;Debug|Release|RelWithDebInfo|MinSizeRel&gt; ../`</span></span><br><span class="line">            <span class="comment">// windows系统是在visual stuido的环境中执行命令`cmake -DCMAKE_BUILD_TYPE=&lt;Debug|Release|RelWithDebInfo|MinSizeRel&gt;  ../ -G &quot;CodeBlocks - NMake Makefiles&quot;`</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span>: <span class="string">&quot;cmake&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;shell&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;cmake&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;args&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;-DCMAKE_BUILD_TYPE=$&#123;input:CMAKE_BUILD_TYPE&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;-DCMAKE_EXPORT_COMPILE_COMMANDS=ON&quot;</span>, <span class="comment">// 生成compile_commands.json 供c/c++扩展提示使用</span></span><br><span class="line">                <span class="string">&quot;../&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;cwd&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;/build&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;windows&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;args&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;-DCMAKE_BUILD_TYPE=$&#123;input:CMAKE_BUILD_TYPE&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;-DCMAKE_EXPORT_COMPILE_COMMANDS=ON&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;../&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;-G&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;\&quot;CodeBlocks - NMake Makefiles\&quot;&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;shell&quot;</span>: &#123;</span><br><span class="line">                        <span class="comment">// &quot;executable&quot;: &quot;C:\\Program Files (x86)\\Microsoft Visual Studio 12.0\\VC\\vcvarsall.bat&quot;,</span></span><br><span class="line">                        <span class="comment">// 需要根据安装的vs版本调用vs工具命令提示符</span></span><br><span class="line">                        <span class="attr">&quot;executable&quot;</span>: <span class="string">&quot;E:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Community\\VC\\Auxiliary\\Build\\vcvarsall.bat&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;args&quot;</span>: [</span><br><span class="line">                            <span class="string">&quot;$&#123;input:PLATFORM&#125;&quot;</span>, <span class="comment">//指定平台</span></span><br><span class="line">                            <span class="string">&quot;-vcvars_ver=$&#123;input:vcvars_ver&#125;&quot;</span>, <span class="comment">//指定vc环境版本</span></span><br><span class="line">                            <span class="string">&quot;&amp;&amp;&quot;</span></span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;build_dir&quot;</span> <span class="comment">// 在task `build_dir` 后执行该task</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123; <span class="comment">// 在build文件夹中调用cmake编译构建debug程序</span></span><br><span class="line">            <span class="comment">// 执行的命令为`cmake --build ./ --target all --`</span></span><br><span class="line">            <span class="comment">//  windows系统如上需要在visual stuido的环境中执行命令</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span>: <span class="string">&quot;build&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;group&quot;</span>: <span class="string">&quot;build&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;shell&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;cmake&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;args&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;--build&quot;</span>,</span><br><span class="line">                <span class="string">&quot;./&quot;</span>,</span><br><span class="line">                <span class="string">&quot;--target&quot;</span>,</span><br><span class="line">                <span class="string">&quot;all&quot;</span>,</span><br><span class="line">                <span class="string">&quot;--&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;cwd&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;/build&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;problemMatcher&quot;</span>: <span class="string">&quot;$gcc&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;windows&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;shell&quot;</span>: &#123;</span><br><span class="line">                        <span class="comment">// &quot;executable&quot;: &quot;C:\\Program Files (x86)\\Microsoft Visual Studio 12.0\\VC\\vcvarsall.bat&quot;,</span></span><br><span class="line">                        <span class="attr">&quot;executable&quot;</span>: <span class="string">&quot;E:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Community\\VC\\Auxiliary\\Build\\vcvarsall.bat&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;args&quot;</span>: [</span><br><span class="line">                            <span class="string">&quot;$&#123;input:PLATFORM&#125;&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;-vcvars_ver=$&#123;input:vcvars_ver&#125;&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;&amp;&amp;&quot;</span></span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;problemMatcher&quot;</span>: <span class="string">&quot;$msCompile&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;dependsOn&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;cmake&quot;</span> <span class="comment">// 在task `cmake` 后执行该task</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;inputs&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;CMAKE_BUILD_TYPE&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;pickString&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;What CMAKE_BUILD_TYPE do you want to create?&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;options&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;Debug&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Release&quot;</span>,</span><br><span class="line">                <span class="string">&quot;RelWithDebInfo&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MinSizeRel&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;default&quot;</span>: <span class="string">&quot;Debug&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;PLATFORM&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;pickString&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;What PLATFORM do you want to create?&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;options&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;x86&quot;</span>,</span><br><span class="line">                <span class="string">&quot;amd64&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arm&quot;</span>,</span><br><span class="line">                <span class="string">&quot;x86_arm&quot;</span>,</span><br><span class="line">                <span class="string">&quot;x86_amd64&quot;</span>,</span><br><span class="line">                <span class="string">&quot;amd64_x86&quot;</span>,</span><br><span class="line">                <span class="string">&quot;amd64_arm&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;default&quot;</span>: <span class="string">&quot;amd64&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;vcvars_ver&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;pickString&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;What vcvars_ver do you want to create?&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;options&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;14.2&quot;</span>, <span class="comment">// 2019</span></span><br><span class="line">                <span class="string">&quot;14.1&quot;</span>, <span class="comment">// 2017</span></span><br><span class="line">                <span class="string">&quot;14.0&quot;</span>  <span class="comment">// 2015</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;default&quot;</span>: <span class="string">&quot;14.2&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="编写CMakeLists"><a href="#编写CMakeLists" class="headerlink" title="编写CMakeLists"></a>编写CMakeLists</h2><p>这是一个比较困难的部分。例如像上面的文件,其CMakeLists如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION <span class="number">3.0</span><span class="number">.0</span>)</span><br><span class="line">project(LRU VERSION <span class="number">0.1</span><span class="number">.0</span>)</span><br><span class="line"></span><br><span class="line">include(CTest)</span><br><span class="line">enable_testing()</span><br><span class="line"></span><br><span class="line"><span class="comment">#设定对等关系。在这里只需要列出cpp文件即可。</span></span><br><span class="line"><span class="comment">#set(&lt;varname&gt;</span></span><br><span class="line"><span class="comment">#    &lt;sourcefilelists&gt;)</span></span><br><span class="line"><span class="built_in">set</span>(SRCS </span><br><span class="line">    main.cpp</span><br><span class="line">    cache.cpp)</span><br><span class="line"><span class="comment">#注意SRCS要加$号</span></span><br><span class="line">add_executable(LRU $&#123;SRCS&#125;)</span><br><span class="line"><span class="built_in">set</span>(CPACK_PROJECT_NAME $&#123;PROJECT_NAME&#125;)</span><br><span class="line"><span class="built_in">set</span>(CPACK_PROJECT_VERSION $&#123;PROJECT_VERSION&#125;)</span><br><span class="line">include(CPack)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h1><p>一般可以采用windows或者linux下进行运行。这里需要补充一下远程在linux系统上进行编译的步骤。<br>在控制台中进入到项目的build文件夹中，然后输入：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake ../</span><br></pre></td></tr></table></figure><br>即可生成makefile。控制台信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">-- Build files have been written to: /mnt/f/项目/MeltedMirror/SmallToys/LRU/build</span><br></pre></td></tr></table></figure>
<p>接着输入<code>make</code>即可。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/29/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E7%9A%84%E6%89%80%E6%9C%89%E6%BA%90%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Albert -W">
      <meta itemprop="description" content="更不更新看心情">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不先进摸鱼研究所">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/29/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E7%9A%84%E6%89%80%E6%9C%89%E6%BA%90%E7%A0%81/" class="post-title-link" itemprop="url">网络编程的所有源码</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-08-29 23:08:12 / Modified: 23:08:57" itemprop="dateCreated datePublished" datetime="2021-08-29T23:08:12+08:00">2021-08-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">网络编程</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Socket网络编程"><a href="#Socket网络编程" class="headerlink" title="Socket网络编程"></a>Socket网络编程</h1><h2 id="TCP客户-服务器模型"><a href="#TCP客户-服务器模型" class="headerlink" title="TCP客户/服务器模型"></a>TCP客户/服务器模型</h2><h3 id="回射客户-服务器模型"><a href="#回射客户-服务器模型" class="headerlink" title="回射客户/服务器模型"></a>回射客户/服务器模型</h3><p><strong>echosrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_service</span><span class="params">(<span class="keyword">int</span> conn)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//接收</span></span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">read</span>(conn, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">write</span>(conn, recvbuf, ret);</span><br><span class="line">	&#125; 	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">pid_t</span> pid; </span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ip=%s port=%d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">		</span><br><span class="line">		pid = fork();</span><br><span class="line">		<span class="keyword">if</span>(pid == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//子进程不需要处理监听 </span></span><br><span class="line">			<span class="built_in">close</span>(listenfd);</span><br><span class="line">			<span class="built_in">do_service</span>(conn);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="comment">//父进程不需要处理连接 </span></span><br><span class="line">			<span class="built_in">close</span>(conn);</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>echocli.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">connect</span>(sock, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">fgets</span>(sendbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf), stdin) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">write</span>(sock, sendbuf, <span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">		<span class="built_in">read</span>(sock, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf)); </span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="点对点聊天程序实现"><a href="#点对点聊天程序实现" class="headerlink" title="点对点聊天程序实现"></a>点对点聊天程序实现</h3><p><strong>p2pcrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;recv a sig = %d\n&quot;</span>, sig);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>((conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;ip = %s  port = %d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	pid = fork();</span><br><span class="line">	<span class="keyword">if</span>(pid == <span class="number">-1</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//子进程用于发送数据</span></span><br><span class="line">		<span class="built_in">signal</span>(SIGUSR1, handler); </span><br><span class="line">		<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">		<span class="keyword">while</span>(<span class="built_in">fgets</span>(sendbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf), stdin) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">write</span>(conn, sendbuf, <span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">			<span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf));</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;child close\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//父进程用于接收数据 </span></span><br><span class="line">		<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">		<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">			<span class="keyword">int</span> ret = <span class="built_in">read</span>(conn, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">			<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">				<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;peer close\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		&#125; 	</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;parent close\n&quot;</span>);</span><br><span class="line">		<span class="built_in">kill</span>(pid, SIGUSR1);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_SUCCESS);		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">close</span>(conn);</span><br><span class="line">	<span class="built_in">close</span>(listenfd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>p2pcli.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;recv a sig = %d\n&quot;</span>, sig);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">connect</span>(sock, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	pid = fork();</span><br><span class="line">	<span class="keyword">if</span>(pid == <span class="number">-1</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//子进程用于接收数据 </span></span><br><span class="line">		<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">		<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">			<span class="keyword">int</span> ret = <span class="built_in">read</span>(sock, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">			<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">				<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;peer close\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;	</span><br><span class="line">			<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;child close\n&quot;</span>);</span><br><span class="line">		<span class="built_in">close</span>(sock);	</span><br><span class="line">		<span class="built_in">kill</span>(<span class="built_in">getppid</span>(), SIGUSR1);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//父进程用于发送数据 </span></span><br><span class="line">		<span class="built_in">signal</span>(SIGUSR1, handler);</span><br><span class="line">		<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;; </span><br><span class="line">		<span class="keyword">while</span>(<span class="built_in">fgets</span>(sendbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf), stdin) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">write</span>(sock, sendbuf, <span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">			<span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf)); </span><br><span class="line">		&#125; 	</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;parent close\n&quot;</span>);</span><br><span class="line">		<span class="built_in">close</span>(sock);</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="改进回射客户-服务器模型"><a href="#改进回射客户-服务器模型" class="headerlink" title="改进回射客户/服务器模型"></a>改进回射客户/服务器模型</h3><p><strong>封装定长接收readn函数、定长发送writen函数、自定义协议解决TCP的粘包问题</strong></p>
<p><strong>echosrv1.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> len;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_service</span><span class="params">(<span class="keyword">int</span> conn)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//接收</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet</span> <span class="title">recvbuf</span>;</span></span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">readn</span>(conn, &amp;recvbuf.len, <span class="number">4</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret &lt; <span class="number">4</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		n = <span class="built_in">ntohl</span>(recvbuf.len);</span><br><span class="line">		ret = <span class="built_in">readn</span>(conn, recvbuf.buf, n);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret &lt; n) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf.buf, stdout);</span><br><span class="line">		<span class="built_in">writen</span>(conn, &amp;recvbuf, <span class="number">4</span> + n);</span><br><span class="line">	&#125; 	</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">pid_t</span> pid; </span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ip=%s port=%d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">		</span><br><span class="line">		pid = fork();</span><br><span class="line">		<span class="keyword">if</span>(pid == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//子进程不需要处理监听 </span></span><br><span class="line">			<span class="built_in">close</span>(listenfd);</span><br><span class="line">			<span class="built_in">do_service</span>(conn);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="comment">//父进程不需要处理连接 </span></span><br><span class="line">			<span class="built_in">close</span>(conn);</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>echocli1.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> len;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">connect</span>(sock, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet</span> <span class="title">sendbuf</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet</span> <span class="title">recvbuf</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf));</span><br><span class="line">	<span class="built_in">memset</span>(&amp;recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">fgets</span>(sendbuf.buf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf.buf), stdin) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		n = <span class="built_in">strlen</span>(sendbuf.buf);</span><br><span class="line">		sendbuf.len = <span class="built_in">htonl</span>(n);</span><br><span class="line">		<span class="built_in">writen</span>(sock, &amp;sendbuf, <span class="number">4</span> + n);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">readn</span>(sock, &amp;recvbuf.len, <span class="number">4</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret &lt; <span class="number">4</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		n = <span class="built_in">ntohl</span>(recvbuf.len);</span><br><span class="line">		ret = <span class="built_in">readn</span>(sock, recvbuf.buf, n);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret &lt; n) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf.buf, stdout);</span><br><span class="line">		<span class="built_in">memset</span>(&amp;sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf));</span><br><span class="line">		<span class="built_in">memset</span>(&amp;recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>利用readline函数解决TCP粘包问题</strong></p>
<p><strong>echosrv2.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recv_peek</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span> </span>&#123;<span class="comment">//接收数据后不将数据从缓冲区移除 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">recv</span>(sockfd, buf, len, MSG_PEEK);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readline</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span> </span>&#123;<span class="comment">//只能用于套接口 </span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">	<span class="keyword">int</span> nleft = maxline;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		ret = <span class="built_in">recv_peek</span>(sockfd, bufp, nleft);</span><br><span class="line">		<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)<span class="comment">//不用再进行中断判断，因为recv_peek函数内部已经进行了 </span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>)<span class="comment">//对方关闭</span></span><br><span class="line">			<span class="keyword">return</span> ret; </span><br><span class="line">		nread = ret;</span><br><span class="line">		<span class="keyword">int</span> i;<span class="comment">//判断已接收到的缓冲区中是否有\n </span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(bufp[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">				ret = <span class="built_in">readn</span>(sockfd, bufp, i + <span class="number">1</span>);<span class="comment">//将数据从缓冲区移除 </span></span><br><span class="line">				<span class="keyword">if</span>(ret != i + <span class="number">1</span>) </span><br><span class="line">					<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(nread &gt; nleft)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		</span><br><span class="line">		nleft -= nread;</span><br><span class="line">		ret = <span class="built_in">readn</span>(sockfd, bufp, nread);<span class="comment">//还没遇到\n的数据也从缓冲区移除</span></span><br><span class="line">		<span class="keyword">if</span>(ret != nread) </span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			</span><br><span class="line">		bufp += nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_srv</span><span class="params">(<span class="keyword">int</span> conn)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//接收</span></span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">readline</span>(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">writen</span>(conn, recvbuf, <span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">	&#125; 	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">pid_t</span> pid; </span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ip=%s port=%d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">		</span><br><span class="line">		pid = fork();</span><br><span class="line">		<span class="keyword">if</span>(pid == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//子进程不需要处理监听 </span></span><br><span class="line">			<span class="built_in">close</span>(listenfd);</span><br><span class="line">			<span class="built_in">echo_srv</span>(conn);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="comment">//父进程不需要处理连接 </span></span><br><span class="line">			<span class="built_in">close</span>(conn);</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>echocli2.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recv_peek</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span> </span>&#123;<span class="comment">//接收数据后不将数据从缓冲区移除 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">recv</span>(sockfd, buf, len, MSG_PEEK);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readline</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span> </span>&#123;<span class="comment">//只能用于套接口 </span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">	<span class="keyword">int</span> nleft = maxline;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		ret = <span class="built_in">recv_peek</span>(sockfd, bufp, nleft);</span><br><span class="line">		<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)<span class="comment">//不用再进行中断判断，因为recv_peek函数内部已经进行了 </span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>)<span class="comment">//对方关闭</span></span><br><span class="line">			<span class="keyword">return</span> ret; </span><br><span class="line">		nread = ret;</span><br><span class="line">		<span class="keyword">int</span> i;<span class="comment">//判断已接收到的缓冲区中是否有\n </span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(bufp[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">				ret = <span class="built_in">readn</span>(sockfd, bufp, i + <span class="number">1</span>);<span class="comment">//将数据从缓冲区移除 </span></span><br><span class="line">				<span class="keyword">if</span>(ret != i + <span class="number">1</span>) </span><br><span class="line">					<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(nread &gt; nleft)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		</span><br><span class="line">		nleft -= nread;</span><br><span class="line">		ret = <span class="built_in">readn</span>(sockfd, bufp, nread);<span class="comment">//还没遇到\n的数据也从缓冲区移除</span></span><br><span class="line">		<span class="keyword">if</span>(ret != nread) </span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			</span><br><span class="line">		bufp += nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_cli</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">fgets</span>(sendbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf), stdin) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">writen</span>(sock, sendbuf, <span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">readline</span>(sock, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf));</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>); </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">connect</span>(sock, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">localaddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> addrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(localaddr);</span><br><span class="line">	<span class="keyword">if</span>((<span class="built_in">getsockname</span>(sock, (struct sockaddr*)&amp;localaddr, &amp;addrlen)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;getsockname&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;ip = %s  port = %d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(localaddr.sin_addr), <span class="built_in">ntohs</span>(localaddr.sin_port));</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">echo_cli</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h2 id="获取本机ip地址"><a href="#获取本机ip地址" class="headerlink" title="获取本机ip地址"></a>获取本机ip地址</h2><p><strong>gethost.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">struct hostent &#123;</span></span><br><span class="line"><span class="comment">	char  *h_name;</span></span><br><span class="line"><span class="comment">	char **h_aliases;</span></span><br><span class="line"><span class="comment">	int    h_addrtype;</span></span><br><span class="line"><span class="comment">	int    h_length;</span></span><br><span class="line"><span class="comment">	char **h_addr_list;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getlocalip</span><span class="params">(<span class="keyword">char</span> *ip)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> host[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="comment">//获取本机主机名 </span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">gethostname</span>(host, <span class="built_in"><span class="keyword">sizeof</span></span>(host)) &lt; <span class="number">0</span>) </span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">hp</span>;</span></span><br><span class="line">	<span class="keyword">if</span>((hp = <span class="built_in">gethostbyname</span>(host)) == <span class="literal">NULL</span>) </span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="built_in">strcpy</span>(ip, <span class="built_in">inet_ntoa</span>(*(struct in_addr*)hp-&gt;h_addr));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> host[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="comment">//获取本机主机名 </span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">gethostname</span>(host, <span class="built_in"><span class="keyword">sizeof</span></span>(host)) &lt; <span class="number">0</span>) </span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;gethostname&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//获取主机中所有ip</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">hp</span>;</span></span><br><span class="line">	<span class="keyword">if</span>((hp = <span class="built_in">gethostbyname</span>(host)) == <span class="literal">NULL</span>) </span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;gethostbyname&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(hp-&gt;h_addr_list[i] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, <span class="built_in">inet_ntoa</span>(*(struct in_addr*)hp-&gt;h_addr_list[i]));</span><br><span class="line">		++i;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">char</span> ip[<span class="number">100</span>];</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">getlocalip</span>(ip) &lt; <span class="number">0</span>) </span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;getlocalip&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;localip = %s\n&quot;</span>, ip);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="多个文件描述符-I-O-的管理"><a href="#多个文件描述符-I-O-的管理" class="headerlink" title="多个文件描述符(I/O)的管理"></a>多个文件描述符(I/O)的管理</h2><h3 id="select函数实现单进程下多个客户端并发"><a href="#select函数实现单进程下多个客户端并发" class="headerlink" title="select函数实现单进程下多个客户端并发"></a>select函数实现单进程下多个客户端并发</h3><p><strong>echosrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recv_peek</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span> </span>&#123;<span class="comment">//接收数据后不将数据从缓冲区移除 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">recv</span>(sockfd, buf, len, MSG_PEEK);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readline</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span> </span>&#123;<span class="comment">//只能用于套接口 </span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">	<span class="keyword">int</span> nleft = maxline;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		ret = <span class="built_in">recv_peek</span>(sockfd, bufp, nleft);</span><br><span class="line">		<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)<span class="comment">//不用再进行中断判断，因为recv_peek函数内部已经进行了 </span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>)<span class="comment">//对方关闭</span></span><br><span class="line">			<span class="keyword">return</span> ret; </span><br><span class="line">		nread = ret;</span><br><span class="line">		<span class="keyword">int</span> i;<span class="comment">//判断已接收到的缓冲区中是否有\n </span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(bufp[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">				ret = <span class="built_in">readn</span>(sockfd, bufp, i + <span class="number">1</span>);<span class="comment">//将数据从缓冲区移除 </span></span><br><span class="line">				<span class="keyword">if</span>(ret != i + <span class="number">1</span>) </span><br><span class="line">					<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(nread &gt; nleft)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		</span><br><span class="line">		nleft -= nread;</span><br><span class="line">		ret = <span class="built_in">readn</span>(sockfd, bufp, nread);<span class="comment">//还没遇到\n的数据也从缓冲区移除</span></span><br><span class="line">		<span class="keyword">if</span>(ret != nread) </span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			</span><br><span class="line">		bufp += nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_srv</span><span class="params">(<span class="keyword">int</span> conn)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//接收</span></span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">readline</span>(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">writen</span>(conn, recvbuf, <span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">	&#125; 	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_sigchld</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//捕获子进程的初始状态</span></span><br><span class="line">	<span class="comment">//wait(NULL); </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">waitpid</span>(<span class="number">-1</span>, <span class="literal">NULL</span>, WNOHANG) &gt; <span class="number">0</span>);<span class="comment">//可以等待所有子进程，大于0表示等待到了一个子进程 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//signal(SIGCHLD, SIG_IGN);</span></span><br><span class="line">	<span class="built_in">signal</span>(SIGCHLD, handle_sigchld);</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen;</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> i; </span><br><span class="line">	<span class="keyword">int</span> client[FD_SETSIZE];<span class="comment">//保存多个客户端连接信息</span></span><br><span class="line">	<span class="keyword">int</span> maxi = <span class="number">0</span>;<span class="comment">//最大的不空闲的位置 </span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; FD_SETSIZE; ++i)</span><br><span class="line">		client[i] = <span class="number">-1</span>;<span class="comment">//-1表示空闲的 </span></span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">int</span> nready;<span class="comment">//检测到的事件个数 </span></span><br><span class="line">	<span class="keyword">int</span> maxfd = listenfd; </span><br><span class="line">	fd_set rset;</span><br><span class="line">	fd_set allset;</span><br><span class="line">	<span class="built_in">FD_ZERO</span>(&amp;rset);</span><br><span class="line">	<span class="built_in">FD_ZERO</span>(&amp;allset);</span><br><span class="line">	<span class="built_in">FD_SET</span>(listenfd, &amp;allset);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		rset = allset;</span><br><span class="line">		nready = <span class="built_in">select</span>(maxfd + <span class="number">1</span>, &amp;rset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">-1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;select&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">0</span>)<span class="comment">//超时，现在timeout设置为NULL，故不可能发生</span></span><br><span class="line">			<span class="keyword">continue</span>; </span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(listenfd, &amp;rset)) &#123;</span><br><span class="line">			peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);<span class="comment">//必须设置一个初始值 </span></span><br><span class="line">			conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen);</span><br><span class="line">			<span class="keyword">if</span>(conn == <span class="number">-1</span>)</span><br><span class="line">				<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line">			<span class="comment">//保存到某个空闲位置 </span></span><br><span class="line">			<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; FD_SETSIZE; ++i) &#123;</span><br><span class="line">				<span class="keyword">if</span>(client[i] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">					client[i] = conn;</span><br><span class="line">					<span class="keyword">if</span>(i &gt; maxi)</span><br><span class="line">						maxi = i;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;		</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="keyword">if</span>(i == FD_SETSIZE) &#123;</span><br><span class="line">				<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;too mang clients\n&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ip=%s port=%d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">			</span><br><span class="line">			<span class="built_in">FD_SET</span>(conn, &amp;allset);</span><br><span class="line">			<span class="keyword">if</span>(conn &gt; maxfd)</span><br><span class="line">				maxfd = conn;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(--nready &lt;= <span class="number">0</span>)<span class="comment">//检测到的事件已经处理完了，应继续监听，没必要处理下面的代码 </span></span><br><span class="line">				<span class="keyword">continue</span>;	</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//已连接套接口产生了数据</span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt;= maxi; ++i) &#123;</span><br><span class="line">			conn = client[i];</span><br><span class="line">			<span class="keyword">if</span>(conn == <span class="number">-1</span>)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(conn, &amp;rset)) &#123;</span><br><span class="line">				<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">				<span class="keyword">int</span> ret = <span class="built_in">readline</span>(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">				<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">					<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">				<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">					<span class="built_in">FD_CLR</span>(conn, &amp;allset);</span><br><span class="line">					client[i] = <span class="number">-1</span>;</span><br><span class="line">                    <span class="built_in">close</span>(conn);</span><br><span class="line">				&#125; </span><br><span class="line">				</span><br><span class="line">				<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">				<span class="built_in">writen</span>(conn, recvbuf, <span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">if</span>(--nready &lt;= <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;	</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>echocli.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recv_peek</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span> </span>&#123;<span class="comment">//接收数据后不将数据从缓冲区移除 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">recv</span>(sockfd, buf, len, MSG_PEEK);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readline</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span> </span>&#123;<span class="comment">//只能用于套接口 </span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">	<span class="keyword">int</span> nleft = maxline;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		ret = <span class="built_in">recv_peek</span>(sockfd, bufp, nleft);</span><br><span class="line">		<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)<span class="comment">//不用再进行中断判断，因为recv_peek函数内部已经进行了 </span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>)<span class="comment">//对方关闭</span></span><br><span class="line">			<span class="keyword">return</span> ret; </span><br><span class="line">		nread = ret;</span><br><span class="line">		<span class="keyword">int</span> i;<span class="comment">//判断已接收到的缓冲区中是否有\n </span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(bufp[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">				ret = <span class="built_in">readn</span>(sockfd, bufp, i + <span class="number">1</span>);<span class="comment">//将数据从缓冲区移除 </span></span><br><span class="line">				<span class="keyword">if</span>(ret != i + <span class="number">1</span>) </span><br><span class="line">					<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(nread &gt; nleft)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		</span><br><span class="line">		nleft -= nread;</span><br><span class="line">		ret = <span class="built_in">readn</span>(sockfd, bufp, nread);<span class="comment">//还没遇到\n的数据也从缓冲区移除</span></span><br><span class="line">		<span class="keyword">if</span>(ret != nread) </span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			</span><br><span class="line">		bufp += nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_cli</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">	fd_set rset;</span><br><span class="line">	<span class="built_in">FD_ZERO</span>(&amp;rset);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//循环检测是否产生了可读事件</span></span><br><span class="line">	<span class="keyword">int</span> nready;</span><br><span class="line">	<span class="keyword">int</span> maxfd;</span><br><span class="line">	<span class="keyword">int</span> fd_stdin = <span class="built_in">fileno</span>(stdin);<span class="comment">//标准输入的文件描述符 </span></span><br><span class="line">	<span class="keyword">if</span>(fd_stdin &gt; sock)</span><br><span class="line">		maxfd = fd_stdin;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		maxfd = sock;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> stdineof = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(stdineof == <span class="number">0</span>) </span><br><span class="line">            <span class="built_in">FD_SET</span>(fd_stdin, &amp;rset);</span><br><span class="line">		<span class="built_in">FD_SET</span>(sock, &amp;rset);</span><br><span class="line">		nready = <span class="built_in">select</span>(maxfd + <span class="number">1</span>, &amp;rset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;select&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(sock, &amp;rset)) &#123;</span><br><span class="line">			<span class="keyword">int</span> ret = <span class="built_in">readline</span>(sock, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">			<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">				<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;server close\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125; </span><br><span class="line">			</span><br><span class="line">			<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">			<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));	</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(fd_stdin, &amp;rset)) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">fgets</span>(sendbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf), stdin) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                stdineof = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="built_in">writen</span>(sock, sendbuf, <span class="built_in">strlen</span>(sendbuf));	</span><br><span class="line">			<span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">connect</span>(sock, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">localaddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> addrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(localaddr);</span><br><span class="line">	<span class="keyword">if</span>((<span class="built_in">getsockname</span>(sock, (struct sockaddr*)&amp;localaddr, &amp;addrlen)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;getsockname&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;ip = %s  port = %d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(localaddr.sin_addr), <span class="built_in">ntohs</span>(localaddr.sin_port));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">echo_cli</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="poll函数实现单进程下多个客户端并发"><a href="#poll函数实现单进程下多个客户端并发" class="headerlink" title="poll函数实现单进程下多个客户端并发"></a>poll函数实现单进程下多个客户端并发</h3><p><strong>pollsrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recv_peek</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span> </span>&#123;<span class="comment">//接收数据后不将数据从缓冲区移除 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">recv</span>(sockfd, buf, len, MSG_PEEK);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readline</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span> </span>&#123;<span class="comment">//只能用于套接口 </span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">	<span class="keyword">int</span> nleft = maxline;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		ret = <span class="built_in">recv_peek</span>(sockfd, bufp, nleft);</span><br><span class="line">		<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)<span class="comment">//不用再进行中断判断，因为recv_peek函数内部已经进行了 </span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>)<span class="comment">//对方关闭</span></span><br><span class="line">			<span class="keyword">return</span> ret; </span><br><span class="line">		nread = ret;</span><br><span class="line">		<span class="keyword">int</span> i;<span class="comment">//判断已接收到的缓冲区中是否有\n </span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(bufp[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">				ret = <span class="built_in">readn</span>(sockfd, bufp, i + <span class="number">1</span>);<span class="comment">//将数据从缓冲区移除 </span></span><br><span class="line">				<span class="keyword">if</span>(ret != i + <span class="number">1</span>) </span><br><span class="line">					<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(nread &gt; nleft)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		</span><br><span class="line">		nleft -= nread;</span><br><span class="line">		ret = <span class="built_in">readn</span>(sockfd, bufp, nread);<span class="comment">//还没遇到\n的数据也从缓冲区移除</span></span><br><span class="line">		<span class="keyword">if</span>(ret != nread) </span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			</span><br><span class="line">		bufp += nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_srv</span><span class="params">(<span class="keyword">int</span> conn)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//接收</span></span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">readline</span>(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">writen</span>(conn, recvbuf, <span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">	&#125; 	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_sigchld</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//捕获子进程的初始状态</span></span><br><span class="line">	<span class="comment">//wait(NULL); </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">waitpid</span>(<span class="number">-1</span>, <span class="literal">NULL</span>, WNOHANG) &gt; <span class="number">0</span>);<span class="comment">//可以等待所有子进程，大于0表示等待到了一个子进程 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_sigpipe</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;recv a sig = %d\n&quot;</span>, sig);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//signal(SIGPIPE, SIG_IGN);</span></span><br><span class="line">	<span class="built_in">signal</span>(SIGPIPE, handle_sigpipe);</span><br><span class="line">	<span class="comment">//signal(SIGCHLD, SIG_IGN);</span></span><br><span class="line">	<span class="built_in">signal</span>(SIGCHLD, handle_sigchld);</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen;</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	struct pollfd &#123;</span></span><br><span class="line"><span class="comment">		int   fd;//文件描述符</span></span><br><span class="line"><span class="comment">		short events;//请求事件/感兴趣事件 </span></span><br><span class="line"><span class="comment">		short revents;//返回事件 </span></span><br><span class="line"><span class="comment">	&#125;;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> i; </span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">client</span>[2048];</span><span class="comment">//保存多个客户端连接信息</span></span><br><span class="line">	<span class="keyword">int</span> maxi = <span class="number">0</span>;<span class="comment">//最大的不空闲的位置 </span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">2048</span>; ++i)</span><br><span class="line">		client[i].fd = <span class="number">-1</span>;<span class="comment">//-1表示空闲的 </span></span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">int</span> nready;<span class="comment">//检测到的事件个数 </span></span><br><span class="line">	client[<span class="number">0</span>].fd = listenfd;</span><br><span class="line">	client[<span class="number">0</span>].events = POLLIN;<span class="comment">//对可读事件感兴趣 </span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		nready = <span class="built_in">poll</span>(client, maxi + <span class="number">1</span>, <span class="number">-1</span>); </span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">-1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">0</span>)<span class="comment">//超时，现在timeout设置为NULL，故不可能发生</span></span><br><span class="line">			<span class="keyword">continue</span>; </span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(client[<span class="number">0</span>].revents &amp; POLLIN) &#123;</span><br><span class="line">			peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);<span class="comment">//必须设置一个初始值 </span></span><br><span class="line">			conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen);</span><br><span class="line">			<span class="keyword">if</span>(conn == <span class="number">-1</span>)</span><br><span class="line">				<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line">			<span class="comment">//保存到某个空闲位置 </span></span><br><span class="line">			<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">2048</span>; ++i) &#123;</span><br><span class="line">				<span class="keyword">if</span>(client[i].fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">					client[i].fd = conn;</span><br><span class="line">					<span class="keyword">if</span>(i &gt; maxi)</span><br><span class="line">						maxi = i;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;		</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="keyword">if</span>(i == <span class="number">2048</span>) &#123;</span><br><span class="line">				<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;too mang clients\n&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ip=%s port=%d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">			</span><br><span class="line">			client[i].events = POLLIN; </span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(--nready &lt;= <span class="number">0</span>)<span class="comment">//检测到的事件已经处理完了，应继续监听，没必要处理下面的代码 </span></span><br><span class="line">				<span class="keyword">continue</span>;	</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//已连接套接口产生了数据</span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">1</span>; i &lt;= maxi; ++i) &#123;</span><br><span class="line">			conn = client[i].fd;</span><br><span class="line">			<span class="keyword">if</span>(conn == <span class="number">-1</span>)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">if</span>(client[i].events &amp; POLLIN) &#123;</span><br><span class="line">				<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">				<span class="keyword">int</span> ret = <span class="built_in">readline</span>(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">				<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">					<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">				<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">					client[i].fd = <span class="number">-1</span>;</span><br><span class="line">					<span class="built_in">close</span>(conn);</span><br><span class="line">				&#125; </span><br><span class="line">				</span><br><span class="line">				<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">				<span class="built_in">writen</span>(conn, recvbuf, <span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">if</span>(--nready &lt;= <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;	</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="epoll函数实现单进程下多个客户端并发"><a href="#epoll函数实现单进程下多个客户端并发" class="headerlink" title="epoll函数实现单进程下多个客户端并发"></a>epoll函数实现单进程下多个客户端并发</h3><p><strong>epollsrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> std::vector&lt;struct epoll_event&gt; EventList;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">activate_nonblock</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> flags = <span class="built_in">fcntl</span>(fd, F_GETFL);</span><br><span class="line">	<span class="keyword">if</span>(flags == <span class="number">-1</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;fcntl&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	flags |= O_NONBLOCK;</span><br><span class="line">	ret = <span class="built_in">fcntl</span>(fd, F_SETFL, flags);</span><br><span class="line">	<span class="keyword">if</span>(ret == <span class="number">-1</span>) </span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;fcntl&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recv_peek</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span> </span>&#123;<span class="comment">//接收数据后不将数据从缓冲区移除 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">recv</span>(sockfd, buf, len, MSG_PEEK);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readline</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span> </span>&#123;<span class="comment">//只能用于套接口 </span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">	<span class="keyword">int</span> nleft = maxline;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		ret = <span class="built_in">recv_peek</span>(sockfd, bufp, nleft);</span><br><span class="line">		<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)<span class="comment">//不用再进行中断判断，因为recv_peek函数内部已经进行了 </span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>)<span class="comment">//对方关闭</span></span><br><span class="line">			<span class="keyword">return</span> ret; </span><br><span class="line">		nread = ret;</span><br><span class="line">		<span class="keyword">int</span> i;<span class="comment">//判断已接收到的缓冲区中是否有\n </span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(bufp[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">				ret = <span class="built_in">readn</span>(sockfd, bufp, i + <span class="number">1</span>);<span class="comment">//将数据从缓冲区移除 </span></span><br><span class="line">				<span class="keyword">if</span>(ret != i + <span class="number">1</span>) </span><br><span class="line">					<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(nread &gt; nleft)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		</span><br><span class="line">		nleft -= nread;</span><br><span class="line">		ret = <span class="built_in">readn</span>(sockfd, bufp, nread);<span class="comment">//还没遇到\n的数据也从缓冲区移除</span></span><br><span class="line">		<span class="keyword">if</span>(ret != nread) </span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			</span><br><span class="line">		bufp += nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_srv</span><span class="params">(<span class="keyword">int</span> conn)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//接收</span></span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">readline</span>(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">writen</span>(conn, recvbuf, <span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">	&#125; 	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_sigchld</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//捕获子进程的初始状态</span></span><br><span class="line">	<span class="comment">//wait(NULL); </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">waitpid</span>(<span class="number">-1</span>, <span class="literal">NULL</span>, WNOHANG) &gt; <span class="number">0</span>);<span class="comment">//可以等待所有子进程，大于0表示等待到了一个子进程 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_sigpipe</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;recv a sig = %d\n&quot;</span>, sig);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">signal</span>(SIGPIPE, handle_sigpipe);</span><br><span class="line">	<span class="built_in">signal</span>(SIGCHLD, handle_sigchld);</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	std::vector&lt;<span class="keyword">int</span>&gt; clients;</span><br><span class="line">	<span class="keyword">int</span> epollfd;</span><br><span class="line">	<span class="comment">//创建一个epoll实例，EPOLL_CLOEXEC表示当进程被替换时文件描述符会关闭</span></span><br><span class="line">	epollfd = <span class="built_in">epoll_create1</span>(EPOLL_CLOEXEC); </span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	typedef union epoll_data &#123;</span></span><br><span class="line"><span class="comment">		void         *ptr;</span></span><br><span class="line"><span class="comment">		int          fd;</span></span><br><span class="line"><span class="comment">		__uint32_t   u32;</span></span><br><span class="line"><span class="comment">		__uint64_t   u64;</span></span><br><span class="line"><span class="comment">	&#125; epoll_data_t;//大小为8个字节 </span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	struct epoll_event &#123;</span></span><br><span class="line"><span class="comment">		__uint32_t   events;//Epoll事件 </span></span><br><span class="line"><span class="comment">		epoll_data_t data;//用户数据变量 ，数据类型为共用体 </span></span><br><span class="line"><span class="comment">	&#125;;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">event</span>;</span></span><br><span class="line">	event.data.fd = listenfd;</span><br><span class="line">	event.events = EPOLLIN | EPOLLET;<span class="comment">//EPOLLET表示边沿方式触发 </span></span><br><span class="line">	<span class="comment">//将感兴趣的文件描述符加入epoll进行管理 </span></span><br><span class="line">	<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, listenfd, &amp;event);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接</span></span><br><span class="line">	<span class="function">EventList <span class="title">events</span><span class="params">(<span class="number">16</span>)</span></span>;	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen;</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	<span class="keyword">int</span> i; </span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">int</span> nready;<span class="comment">//检测到的事件个数 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		nready = <span class="built_in">epoll_wait</span>(epollfd, &amp;*events.<span class="built_in">begin</span>(), <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(events.<span class="built_in">size</span>()), <span class="number">-1</span>);</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">-1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;poll_wait&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">0</span>)<span class="comment">//超时，现在timeout设置为NULL，故不可能发生</span></span><br><span class="line">			<span class="keyword">continue</span>; </span><br><span class="line">			</span><br><span class="line">		<span class="keyword">if</span>((<span class="keyword">size_t</span>)nready == events.<span class="built_in">size</span>())</span><br><span class="line">			events.<span class="built_in">resize</span>(events.<span class="built_in">size</span>() * <span class="number">2</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//遍历返回的事件</span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nready; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(events[i].data.fd == listenfd) &#123;</span><br><span class="line">				peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);<span class="comment">//必须设置一个初始值 </span></span><br><span class="line">				conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen);</span><br><span class="line">				<span class="keyword">if</span>(conn == <span class="number">-1</span>)</span><br><span class="line">					<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line"></span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;ip=%s port=%d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;count = %d\n&quot;</span>, ++count);</span><br><span class="line">				clients.<span class="built_in">push_back</span>(conn);</span><br><span class="line">				</span><br><span class="line">				<span class="built_in">activate_nonblock</span>(conn);</span><br><span class="line">				</span><br><span class="line">				event.data.fd = conn;</span><br><span class="line">				event.events = EPOLLIN | EPOLLET;</span><br><span class="line">				<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, conn, &amp;event);				</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(events[i].events &amp; EPOLLIN) &#123;</span><br><span class="line">				conn = events[i].data.fd;</span><br><span class="line">				<span class="keyword">if</span>(conn &lt; <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">				<span class="keyword">int</span> ret = <span class="built_in">readline</span>(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">				<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">					<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">				<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">					<span class="built_in">close</span>(conn);</span><br><span class="line">					event = events[i];</span><br><span class="line">					<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_DEL, conn, &amp;event);</span><br><span class="line">					clients.<span class="built_in">erase</span>(std::<span class="built_in">remove</span>(clients.<span class="built_in">begin</span>(), clients.<span class="built_in">end</span>(), conn), clients.<span class="built_in">end</span>());</span><br><span class="line">				&#125; </span><br><span class="line">				</span><br><span class="line">				<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">				<span class="built_in">writen</span>(conn, recvbuf, <span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h2 id="UDP客户-服务器模型"><a href="#UDP客户-服务器模型" class="headerlink" title="UDP客户/服务器模型"></a>UDP客户/服务器模型</h2><p><strong>echosrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_in</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_srv</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen;</span><br><span class="line">	<span class="keyword">int</span> n;<span class="comment">//接收到的字节数 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		n = <span class="built_in">recvfrom</span>(sock, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf), <span class="number">0</span>, (struct sockaddr*)&amp;peeraddr, &amp;peerlen);</span><br><span class="line">		<span class="keyword">if</span>(n == <span class="number">-1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;recvfrom&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(n &gt; <span class="number">0</span>) &#123;<span class="comment">//回射回去 </span></span><br><span class="line">			<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">			<span class="built_in">sendto</span>(sock, recvbuf, n, <span class="number">0</span>, (struct sockaddr*)&amp;peeraddr, peerlen);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_DGRAM, <span class="number">0</span>)) &lt; <span class="number">0</span>)<span class="comment">//SOCK_DGRAM代表UDP</span></span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	<span class="comment">//初始化地址</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span>  <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(sock, (struct sockaddr*)&amp; servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">echo_srv</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>echocli.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_in</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_cli</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span>  <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">fgets</span>(sendbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf), stdin) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">sendto</span>(sock, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">		<span class="built_in">recvfrom</span>(sock, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf));</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_DGRAM, <span class="number">0</span>)) &lt; <span class="number">0</span>)<span class="comment">//SOCK_DGRAM代表UDP</span></span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">echo_cli</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="UDP聊天室实现"><a href="#UDP聊天室实现" class="headerlink" title="UDP聊天室实现"></a>UDP聊天室实现</h3><p><strong>chatsrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pub.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line">USER_LIST client_list;<span class="comment">//聊天室成员列表 </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_login</span><span class="params">(MESSAGE&amp; msg, <span class="keyword">int</span> sock, struct sockaddr_in *cliaddr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_logout</span><span class="params">(MESSAGE&amp; msg, <span class="keyword">int</span> sock, struct sockaddr_in *cliaddr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_sendlist</span><span class="params">(<span class="keyword">int</span> sock, struct sockaddr_in *cliaddr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chat_srv</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">cliaddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> clilen;</span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">	MESSAGE msg;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(msg));</span><br><span class="line">		clilen = <span class="built_in"><span class="keyword">sizeof</span></span>(cliaddr);</span><br><span class="line">		n = <span class="built_in">recvfrom</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)&amp;cliaddr,&amp;clilen);</span><br><span class="line">		<span class="keyword">if</span>(n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;recvfrom&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> cmd = <span class="built_in">ntohl</span>(msg.cmd);</span><br><span class="line">		<span class="built_in"><span class="keyword">switch</span></span>(cmd) &#123;</span><br><span class="line">		<span class="keyword">case</span> C2S_LOGIN:</span><br><span class="line">			<span class="built_in">do_login</span>(msg, sock, &amp;cliaddr);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> C2S_LOGOUT:</span><br><span class="line">			<span class="built_in">do_logout</span>(msg, sock, &amp;cliaddr);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> C2S_ONLINE_USER:</span><br><span class="line">			<span class="built_in">do_sendlist</span>(sock, &amp;cliaddr);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_login</span><span class="params">(MESSAGE&amp; msg, <span class="keyword">int</span> sock, struct sockaddr_in *cliaddr)</span> </span>&#123;</span><br><span class="line">	USER_INFO user;</span><br><span class="line">	<span class="built_in">strcpy</span>(user.username, msg.body);</span><br><span class="line">	user.ip = cliaddr-&gt;sin_addr.s_addr;</span><br><span class="line">	user.port = cliaddr-&gt;sin_port;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//查找用户</span></span><br><span class="line">	USER_LIST::iterator it;</span><br><span class="line">	<span class="keyword">for</span>(it = client_list.<span class="built_in">begin</span>(); it != client_list.<span class="built_in">end</span>(); ++it) </span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">strcmp</span>(it-&gt;username, msg.body) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(it == client_list.<span class="built_in">end</span>()) &#123;<span class="comment">//没找到用户 </span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;has a user login : %s &lt;-&gt; %s:%d\n&quot;</span>, msg.body, <span class="built_in">inet_ntoa</span>(cliaddr-&gt;sin_addr), cliaddr-&gt;sin_port);</span><br><span class="line">		client_list.<span class="built_in">push_back</span>(user); </span><br><span class="line">		</span><br><span class="line">		<span class="comment">//登录成功应答</span></span><br><span class="line">		MESSAGE reply_msg;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;reply_msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(reply_msg));</span><br><span class="line">		reply_msg.cmd = <span class="built_in">htonl</span>(S2C_LOGIN_OK);</span><br><span class="line">		<span class="built_in">sendto</span>(sock, &amp;reply_msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)cliaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*cliaddr));</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> count = <span class="built_in">htonl</span>((<span class="keyword">int</span>)client_list.<span class="built_in">size</span>());</span><br><span class="line">		<span class="comment">//发送在线人数</span></span><br><span class="line">		<span class="built_in">sendto</span>(sock, &amp;count, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>), <span class="number">0</span>, (struct sockaddr*)cliaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*cliaddr));</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//发送在线列表 </span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;sending user list informatio to:%s &lt;-&gt; %s:%d\n&quot;</span>,msg.body, <span class="built_in">inet_ntoa</span>(cliaddr-&gt;sin_addr), cliaddr-&gt;sin_port);</span><br><span class="line">	 	<span class="keyword">for</span>(it = client_list.<span class="built_in">begin</span>(); it != client_list.<span class="built_in">end</span>(); ++it) </span><br><span class="line">			<span class="built_in">sendto</span>(sock, &amp;*it, <span class="built_in"><span class="keyword">sizeof</span></span>(USER_INFO), <span class="number">0</span>, (struct sockaddr*)cliaddr,<span class="built_in"><span class="keyword">sizeof</span></span>(*cliaddr));</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//向其他用户通知有新用户登录</span></span><br><span class="line">		<span class="keyword">for</span>(it = client_list.<span class="built_in">begin</span>(); it != client_list.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">strcmp</span>(it-&gt;username, msg.body) == <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">			<span class="built_in">memset</span>(&amp;peeraddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr));</span><br><span class="line">			peeraddr.sin_family = AF_INET;</span><br><span class="line">			peeraddr.sin_port = it-&gt;port;</span><br><span class="line">			peeraddr.sin_addr.s_addr = it-&gt;ip;</span><br><span class="line">			</span><br><span class="line">			msg.cmd = <span class="built_in">htonl</span>(S2C_SOMEONE_LOGIN);</span><br><span class="line">			<span class="built_in">memcpy</span>(msg.body, &amp;user, <span class="built_in"><span class="keyword">sizeof</span></span>(user));</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">sendto</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)&amp;peeraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr)) &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;sendto&quot;</span>);</span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;<span class="comment">//找到用户 </span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;user %s has already logined\n&quot;</span>, msg.body);</span><br><span class="line">		</span><br><span class="line">		MESSAGE reply_msg;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;reply_msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(reply_msg));</span><br><span class="line">		reply_msg.cmd = <span class="built_in">htonl</span>(S2C_ALREADY_LOGINED);</span><br><span class="line">		<span class="built_in">sendto</span>(sock, &amp;reply_msg, <span class="built_in"><span class="keyword">sizeof</span></span>(reply_msg), <span class="number">0</span>, (struct sockaddr*)cliaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*cliaddr));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_logout</span><span class="params">(MESSAGE&amp; msg, <span class="keyword">int</span> sock, struct sockaddr_in *cliaddr)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;has a user logout : %s &lt;-&gt; %s:%d\n&quot;</span>, msg.body, <span class="built_in">inet_ntoa</span>(cliaddr-&gt;sin_addr), <span class="built_in">ntohs</span>(cliaddr-&gt;sin_port));</span><br><span class="line">	</span><br><span class="line">	USER_LIST::iterator it;</span><br><span class="line">	<span class="keyword">for</span>(it = client_list.<span class="built_in">begin</span>(); it != client_list.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">strcmp</span>(it-&gt;username, msg.body) == <span class="number">0</span>) &#123;</span><br><span class="line">			it = client_list.<span class="built_in">erase</span>(it); </span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125; </span><br><span class="line">			</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">		<span class="built_in">memset</span>(&amp;peeraddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr));</span><br><span class="line">		peeraddr.sin_family      = AF_INET;</span><br><span class="line">		peeraddr.sin_port        = it-&gt;port;</span><br><span class="line">		peeraddr.sin_addr.s_addr = it-&gt;ip;</span><br><span class="line">		</span><br><span class="line">		msg.cmd = <span class="built_in">htonl</span>(S2C_SOMEONE_LOGOUT);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">sendto</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)&amp;peeraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr)) &lt; <span class="number">0</span>) </span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;sendto&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_sendlist</span><span class="params">(<span class="keyword">int</span> sock, struct sockaddr_in *cliaddr)</span> </span>&#123;</span><br><span class="line">	MESSAGE msg;</span><br><span class="line">	msg.cmd = <span class="built_in">htonl</span>(S2C_ONLINE_USER);</span><br><span class="line">	<span class="built_in">sendto</span>(sock, (<span class="keyword">const</span> <span class="keyword">char</span>*)&amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)cliaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*cliaddr));</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> count = <span class="built_in">htonl</span>((<span class="keyword">int</span>)client_list.<span class="built_in">size</span>());</span><br><span class="line">	<span class="comment">//发送在线用户数</span></span><br><span class="line">	<span class="built_in">sendto</span>(sock, (<span class="keyword">const</span> <span class="keyword">char</span>*)&amp;count, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>), <span class="number">0</span>, (struct sockaddr*)cliaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*cliaddr));</span><br><span class="line">	<span class="comment">//发送在线用户列表</span></span><br><span class="line">	<span class="keyword">for</span>(USER_LIST::iterator it = client_list.<span class="built_in">begin</span>(); it != client_list.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">		<span class="built_in">sendto</span>(sock,&amp;*it, <span class="built_in"><span class="keyword">sizeof</span></span>(USER_INFO), <span class="number">0</span>, (struct sockaddr*)cliaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*cliaddr));</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_DGRAM, <span class="number">0</span>)) &lt; <span class="number">0</span>)<span class="comment">//SOCK_DGRAM代表UDP</span></span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="class"><span class="keyword">struct</span>  <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(sock, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">chat_srv</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>chatcli.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pub.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> username[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">USER_LIST client_list;<span class="comment">//聊天室成员列表</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_someone_login</span><span class="params">(MESSAGE&amp; msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_someone_logout</span><span class="params">(MESSAGE&amp; msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_getlist</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_chat</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">parse_cmd</span><span class="params">(<span class="keyword">char</span>* cmdline, <span class="keyword">int</span> sock, struct sockaddr_in *servaddr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">sendmsgto</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">char</span>* username, <span class="keyword">char</span>* msg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">parse_cmd</span><span class="params">(<span class="keyword">char</span>* cmdline, <span class="keyword">int</span> sock, struct sockaddr_in *servaddr)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> cmd[<span class="number">10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> *p;</span><br><span class="line">	p = <span class="built_in">strchr</span>(cmdline, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(p != <span class="literal">NULL</span>)</span><br><span class="line">		*p = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">strcpy</span>(cmd, cmdline);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd, <span class="string">&quot;exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">		MESSAGE msg;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(msg));</span><br><span class="line">		msg.cmd = <span class="built_in">htonl</span>(C2S_LOGOUT);</span><br><span class="line">		<span class="built_in">strcpy</span>(msg.body, username);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">sendto</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;sendto&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;user %s has logout server\n&quot;</span>, username);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd, <span class="string">&quot;send&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">char</span> peername[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">		<span class="keyword">char</span> msg[MSG_LEN] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/* send  user  msg */</span></span><br><span class="line">		<span class="comment">/*       p     p2  */</span></span><br><span class="line">		<span class="keyword">while</span>(*p++ == <span class="string">&#x27; &#x27;</span>) ;</span><br><span class="line">		<span class="keyword">char</span> *p2;</span><br><span class="line">		p2 = <span class="built_in">strchr</span>(p, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">		<span class="keyword">if</span>(p2 == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;bad command\n&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;\nCommands are:\n&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;send username msg\n&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;list\n&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		*p2 = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">		<span class="built_in">strcpy</span>(peername, p);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span>(*p2++ == <span class="string">&#x27; &#x27;</span>) ;</span><br><span class="line">		<span class="built_in">strcpy</span>(msg, p2);</span><br><span class="line">		<span class="built_in">sendmsgto</span>(sock, peername, msg);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd, <span class="string">&quot;list&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">		MESSAGE msg;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(msg));</span><br><span class="line">		msg.cmd = <span class="built_in">htonl</span>(C2S_ONLINE_USER);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">sendto</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;sendto&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;bad command\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\nCommands are:\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;send username msg\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;list\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">sendmsgto</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">char</span>* name, <span class="keyword">char</span>* msg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">strcmp</span>(name, username) == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t send message to self\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	USER_LIST::iterator it;</span><br><span class="line">	<span class="keyword">for</span>(it = client_list.<span class="built_in">begin</span>(); it != client_list.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">strcmp</span>(it-&gt;username, name) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(it == client_list.<span class="built_in">end</span>()) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;user %s has not logined server\n&quot;</span>, name);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	MESSAGE m;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;m, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(m));</span><br><span class="line">	m.cmd = <span class="built_in">htonl</span>(C2C_CHAT);</span><br><span class="line">	</span><br><span class="line">	CHAT_MSG cm;</span><br><span class="line">	<span class="built_in">strcpy</span>(cm.username, username);</span><br><span class="line">	<span class="built_in">strcpy</span>(cm.msg, msg);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">memcpy</span>(m.body, &amp;cm, <span class="built_in"><span class="keyword">sizeof</span></span>(cm));</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;peeraddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr));</span><br><span class="line">	peeraddr.sin_family      = AF_INET;</span><br><span class="line">	peeraddr.sin_addr.s_addr = it-&gt;ip;</span><br><span class="line">	peeraddr.sin_port        = it-&gt;port;</span><br><span class="line">	</span><br><span class="line">	in_addr tmp;</span><br><span class="line">	tmp.s_addr = it-&gt;ip;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;sending message [%s] to user [%s] &lt;-&gt; %s:%d\n&quot;</span>, msg, name, <span class="built_in">inet_ntoa</span>(tmp), it-&gt;port);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">sendto</span>(sock, (<span class="keyword">const</span> <span class="keyword">char</span>*)&amp;m, <span class="built_in"><span class="keyword">sizeof</span></span>(m), <span class="number">0</span>, (struct sockaddr*)&amp;peeraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr));</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_getlist</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> count;</span><br><span class="line">	<span class="built_in">recvfrom</span>(sock, &amp;count, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;has %d users logined server\n&quot;</span>, <span class="built_in">ntohl</span>(count));</span><br><span class="line">	client_list.<span class="built_in">clear</span>();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> n = <span class="built_in">ntohl</span>(count);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">		USER_INFO user;</span><br><span class="line">		<span class="built_in">recvfrom</span>(sock, &amp;user, <span class="built_in"><span class="keyword">sizeof</span></span>(USER_INFO), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		in_addr tmp;</span><br><span class="line">		tmp.s_addr = user.ip;</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s &lt;-&gt; %s:%d\n&quot;</span>, user.username, <span class="built_in">inet_ntoa</span>(tmp), <span class="built_in">ntohs</span>(user.port));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_someone_login</span><span class="params">(MESSAGE&amp; msg)</span> </span>&#123;</span><br><span class="line">	USER_INFO *user = (USER_INFO*)msg.body;</span><br><span class="line">	in_addr tmp;</span><br><span class="line">	tmp.s_addr = user-&gt;ip;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s &lt;-&gt; %s:%d has logined server\n&quot;</span>, user-&gt;username, <span class="built_in">inet_ntoa</span>(tmp), user-&gt;port);</span><br><span class="line">	client_list.<span class="built_in">push_back</span>(*user);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_someone_logout</span><span class="params">(MESSAGE&amp; msg)</span> </span>&#123;</span><br><span class="line">	USER_LIST::iterator it;</span><br><span class="line">	<span class="keyword">for</span>(it = client_list.<span class="built_in">begin</span>(); it != client_list.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">strcmp</span>(it-&gt;username, msg.body) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(it != client_list.<span class="built_in">end</span>())</span><br><span class="line">		client_list.<span class="built_in">erase</span>(it);</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;user %s has logout server\n&quot;</span>, msg.body);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_chat</span><span class="params">(<span class="keyword">const</span> MESSAGE&amp; msg)</span> </span>&#123;</span><br><span class="line">	CHAT_MSG *cm = (CHAT_MSG*)msg.body;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;recv a msg [%s] from [%s]\n&quot;</span>, cm-&gt;msg, cm-&gt;username);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chat_cli</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span>  <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen;</span><br><span class="line">	</span><br><span class="line">	MESSAGE msg;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(username, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(username));</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;please input your name:&quot;</span>);</span><br><span class="line">		<span class="built_in">fflush</span>(stdout);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, username);</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(msg));</span><br><span class="line">		msg.cmd = <span class="built_in">htonl</span>(C2S_LOGIN);</span><br><span class="line">		<span class="built_in">strcpy</span>(msg.body, username);</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">sendto</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(msg));</span><br><span class="line">		<span class="built_in">recvfrom</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">int</span> cmd = <span class="built_in">ntohl</span>(msg.cmd);</span><br><span class="line">		<span class="keyword">if</span>(cmd == S2C_ALREADY_LOGINED) </span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;user %s already logined server, please use another username\n&quot;</span>, username);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(cmd == S2C_LOGIN_OK) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;user %s already server\n&quot;</span>, username);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> count;</span><br><span class="line">	<span class="built_in">recvfrom</span>(sock, &amp;count, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> n = <span class="built_in">ntohl</span>(count);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;has %d user logined server\n&quot;</span>, n);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">		USER_INFO user;</span><br><span class="line">		<span class="built_in">recvfrom</span>(sock, &amp;user, <span class="built_in"><span class="keyword">sizeof</span></span>(USER_INFO), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		client_list.<span class="built_in">push_back</span>(user);</span><br><span class="line">		in_addr tmp;</span><br><span class="line">		tmp.s_addr = user.ip;</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d %s &lt;-&gt; %s:%d\n&quot;</span>, i, user.username, <span class="built_in">inet_ntoa</span>(tmp), <span class="built_in">ntohs</span>(user.port));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\nCommands are:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;send username msg\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;list\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	fd_set rset;</span><br><span class="line">	<span class="built_in">FD_ZERO</span>(&amp;rset);</span><br><span class="line">	<span class="keyword">int</span> nready;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">FD_SET</span>(STDIN_FILENO, &amp;rset);</span><br><span class="line">		<span class="built_in">FD_SET</span>(sock, &amp;rset);</span><br><span class="line">		nready = <span class="built_in">select</span>(sock + <span class="number">1</span>, &amp;rset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;select&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(sock, &amp;rset)) &#123;</span><br><span class="line">			peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);</span><br><span class="line">			<span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(msg));</span><br><span class="line">			<span class="built_in">recvfrom</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)&amp;peeraddr, &amp;peerlen);</span><br><span class="line">			<span class="keyword">int</span> cmd = <span class="built_in">ntohl</span>(msg.cmd);</span><br><span class="line">			<span class="built_in"><span class="keyword">switch</span></span>(cmd) &#123;</span><br><span class="line">			<span class="keyword">case</span> S2C_SOMEONE_LOGIN:</span><br><span class="line">				<span class="built_in">do_someone_login</span>(msg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> S2C_SOMEONE_LOGOUT:</span><br><span class="line">				<span class="built_in">do_someone_logout</span>(msg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> S2C_ONLINE_USER:</span><br><span class="line">				<span class="built_in">do_getlist</span>(sock);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> C2C_CHAT:</span><br><span class="line">				<span class="built_in">do_chat</span>(msg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			defalut:</span><br><span class="line">				<span class="keyword">break</span>;	</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(STDIN_FILENO, &amp;rset)) &#123;</span><br><span class="line">			<span class="keyword">char</span> cmdline[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">fgets</span>(cmdline, <span class="built_in"><span class="keyword">sizeof</span></span>(cmdline), stdin) == <span class="literal">NULL</span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">				</span><br><span class="line">			<span class="keyword">if</span>(cmdline[<span class="number">0</span>] == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			cmdline[<span class="built_in">strlen</span>(cmdline) - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">			<span class="built_in">parse_cmd</span>(cmdline, sock, &amp;servaddr);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(msg));</span><br><span class="line">	msg.cmd = <span class="built_in">htonl</span>(C2S_LOGOUT);</span><br><span class="line">	<span class="built_in">strcpy</span>(msg.body, username);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">sendto</span>(sock, (<span class="keyword">const</span> <span class="keyword">char</span>*)&amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_DGRAM, <span class="number">0</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">chat_cli</span>(sock);</span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h2><p><strong>thread.cpp</strong></p>
<p><strong>编译语句为：g++ thread.cpp -o thread -lpthread</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">thread_routine</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; ++i) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;B&quot;</span>);</span><br><span class="line">		<span class="built_in">fflush</span>(stdout);</span><br><span class="line">		<span class="built_in">usleep</span>(<span class="number">20</span>);</span><br><span class="line">		<span class="keyword">if</span>(i == <span class="number">3</span>)</span><br><span class="line">			<span class="built_in">pthread_exit</span>(<span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>*&gt;(<span class="string">&quot;ABC&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">pthread_t</span> tid;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">if</span>((ret = <span class="built_in">pthread_create</span>(&amp;tid, <span class="literal">NULL</span>, thread_routine, <span class="literal">NULL</span>)) != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;pthread_create:%s\n&quot;</span>, <span class="built_in">strerror</span>(ret));</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; ++i) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">		<span class="built_in">fflush</span>(stdout);</span><br><span class="line">		<span class="built_in">usleep</span>(<span class="number">20</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> *value;</span><br><span class="line">	<span class="keyword">if</span>((ret = <span class="built_in">pthread_join</span>(tid, &amp;value) != <span class="number">0</span>)) &#123;<span class="comment">//等待其他线程完成 </span></span><br><span class="line">		<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;pthread_join:%s\n&quot;</span>, <span class="built_in">strerror</span>(ret));</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\nreturn msg = %s\n&quot;</span>, (<span class="keyword">char</span>*)value);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多线程下的回射客户-服务器模型"><a href="#多线程下的回射客户-服务器模型" class="headerlink" title="多线程下的回射客户/服务器模型"></a>多线程下的回射客户/服务器模型</h3><p><strong>echosrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_service</span><span class="params">(<span class="keyword">int</span> conn)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//接收</span></span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">read</span>(conn, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">write</span>(conn, recvbuf, ret);</span><br><span class="line">	&#125; 	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">thread_routine</span><span class="params">(<span class="keyword">void</span>* arg)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">pthread_detach</span>(<span class="built_in">pthread_self</span>());</span><br><span class="line">	<span class="keyword">int</span> conn = (<span class="keyword">int</span>)arg;</span><br><span class="line">	<span class="built_in">do_service</span>(conn);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;exiting thread……\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ip=%s port=%d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">pthread_t</span> tid;</span><br><span class="line">		<span class="keyword">int</span> ret;</span><br><span class="line">		<span class="keyword">int</span> *p = <span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>));</span><br><span class="line">		*p = conn;</span><br><span class="line">		<span class="keyword">if</span>((ret = <span class="built_in">pthread_create</span>(&amp;tid, <span class="literal">NULL</span>, thread_routine, p)) != <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;pthread_create:%s\n&quot;</span>, <span class="built_in">strerror</span>(ret));</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>echocli.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">connect</span>(sock, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">fgets</span>(sendbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf), stdin) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">write</span>(sock, sendbuf, <span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">		<span class="built_in">read</span>(sock, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf)); </span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="信号量-互斥锁实现生产者-消费者模型"><a href="#信号量-互斥锁实现生产者-消费者模型" class="headerlink" title="信号量+互斥锁实现生产者-消费者模型"></a>信号量+互斥锁实现生产者-消费者模型</h3><p><strong>pctest.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONSUMERS_COUNT 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRODUCERS_COUNT 5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFSIZE 10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_buffer[BUFFSIZE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> in = <span class="number">0</span>;<span class="comment">//从0号位置开始存放 </span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> out = <span class="number">0</span>;<span class="comment">//从0号位置开始取走</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> produce_id = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> consumer_id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">sem_t</span> g_sem_full;</span><br><span class="line"><span class="keyword">sem_t</span> g_sem_empty;</span><br><span class="line"><span class="keyword">pthread_mutex_t</span> g_mutex;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_t</span> g_thread[CONSUMERS_COUNT + PRODUCERS_COUNT];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">consume</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> num = (<span class="keyword">long</span>)arg;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d wait buffer not empty\n&quot;</span>, num);</span><br><span class="line">		<span class="built_in">sem_wait</span>(&amp;g_sem_empty);</span><br><span class="line">		<span class="built_in">pthread_mutex_lock</span>(&amp;g_mutex);</span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; BUFFSIZE; ++i) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%02d &quot;</span>, i);</span><br><span class="line">			<span class="keyword">if</span>(g_buffer[i] == <span class="number">-1</span>)</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, <span class="string">&quot;null&quot;</span>);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, g_buffer[i]);</span><br><span class="line">			<span class="keyword">if</span>(i == out)</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;\t&lt;--consume&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> consume_id = g_buffer[out];</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d begin consume product %d\n&quot;</span>, num, consume_id);</span><br><span class="line">		g_buffer[out] = <span class="number">-1</span>;	</span><br><span class="line">		out = (out + <span class="number">1</span>) % BUFFSIZE;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d end consume product %d\n&quot;</span>, num, consume_id);</span><br><span class="line">		<span class="built_in">pthread_mutex_unlock</span>(&amp;g_mutex);</span><br><span class="line">		<span class="built_in">sem_post</span>(&amp;g_sem_full);	</span><br><span class="line">		<span class="built_in">sleep</span>(<span class="number">5</span>);	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">produce</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> num = (<span class="keyword">long</span>)arg;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d wait buffer not full\n&quot;</span>, num);</span><br><span class="line">		<span class="built_in">sem_wait</span>(&amp;g_sem_full);</span><br><span class="line">		<span class="built_in">pthread_mutex_lock</span>(&amp;g_mutex);</span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; BUFFSIZE; ++i) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%02d &quot;</span>, i);</span><br><span class="line">			<span class="keyword">if</span>(g_buffer[i] == <span class="number">-1</span>)</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, <span class="string">&quot;null&quot;</span>);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, g_buffer[i]);</span><br><span class="line">			<span class="keyword">if</span>(i == in)</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;\t&lt;--produce&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d begin produce product %d\n&quot;</span>, num, produce_id);</span><br><span class="line">		g_buffer[in] = produce_id;	</span><br><span class="line">		in = (in + <span class="number">1</span>) % BUFFSIZE;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d end produce product %d\n&quot;</span>, num, produce_id++);</span><br><span class="line">		<span class="built_in">pthread_mutex_unlock</span>(&amp;g_mutex);</span><br><span class="line">		<span class="built_in">sem_post</span>(&amp;g_sem_empty);	</span><br><span class="line">		<span class="built_in">sleep</span>(<span class="number">1</span>);	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; BUFFSIZE; ++i)</span><br><span class="line">		g_buffer[i] = <span class="number">-1</span>;</span><br><span class="line">	<span class="built_in">sem_init</span>(&amp;g_sem_full, <span class="number">0</span>, BUFFSIZE);</span><br><span class="line">	<span class="built_in">sem_init</span>(&amp;g_sem_empty, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">pthread_mutex_init</span>(&amp;g_mutex, <span class="literal">NULL</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; CONSUMERS_COUNT; ++i)</span><br><span class="line">		<span class="built_in">pthread_create</span>(&amp;g_thread[i], <span class="literal">NULL</span>, consume, (<span class="keyword">void</span>*)(<span class="keyword">long</span>)i);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; PRODUCERS_COUNT; ++i)</span><br><span class="line">		<span class="built_in">pthread_create</span>(&amp;g_thread[CONSUMERS_COUNT + i], <span class="literal">NULL</span>, produce, (<span class="keyword">void</span>*)(<span class="keyword">long</span>)i);	</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; CONSUMERS_COUNT + PRODUCERS_COUNT; ++i)</span><br><span class="line">		<span class="built_in">pthread_join</span>(g_thread[i], <span class="literal">NULL</span>);	</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">sem_destroy</span>(&amp;g_sem_full);</span><br><span class="line">	<span class="built_in">sem_destroy</span>(&amp;g_sem_empty);</span><br><span class="line">	<span class="built_in">pthread_mutex_destroy</span>(&amp;g_mutex);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="条件变量-互斥锁实现生产者-消费者模型"><a href="#条件变量-互斥锁实现生产者-消费者模型" class="headerlink" title="条件变量+互斥锁实现生产者-消费者模型"></a>条件变量+互斥锁实现生产者-消费者模型</h3><p><strong>pctest.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONSUMERS_COUNT 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRODUCERS_COUNT 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_mutex_t</span> g_mutex;</span><br><span class="line"><span class="keyword">pthread_cond_t</span> g_cond;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_t</span> g_thread[CONSUMERS_COUNT + PRODUCERS_COUNT];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> nready = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">consume</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> num = (<span class="keyword">long</span>)arg;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">pthread_mutex_lock</span>(&amp;g_mutex);</span><br><span class="line">		<span class="keyword">while</span>(nready == <span class="number">0</span>) &#123;<span class="comment">//条件不满足则等待 </span></span><br><span class="line">			<span class="comment">//解锁，等待其他线程改变nready的值 </span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;consumer %d begin wait a condition...\n&quot;</span>, num);</span><br><span class="line">			<span class="built_in">pthread_cond_wait</span>(&amp;g_cond, &amp;g_mutex);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;consumer %d end wait a condition...\n&quot;</span>, num);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;consumer %d begin consume product...\n&quot;</span>, num);</span><br><span class="line">		--nready;</span><br><span class="line">		<span class="built_in">pthread_mutex_unlock</span>(&amp;g_mutex);</span><br><span class="line">		<span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">produce</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> num = (<span class="keyword">long</span>)arg;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">pthread_mutex_lock</span>(&amp;g_mutex);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;producer %d begin produce product...\n&quot;</span>, num);</span><br><span class="line">		++nready;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;producer %d end produce product...\n&quot;</span>, num);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;producer %d signal...\n&quot;</span>, num);</span><br><span class="line">		<span class="built_in">pthread_cond_signal</span>(&amp;g_cond);</span><br><span class="line">		<span class="built_in">pthread_mutex_unlock</span>(&amp;g_mutex);</span><br><span class="line">		<span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">pthread_mutex_init</span>(&amp;g_mutex, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">pthread_cond_init</span>(&amp;g_cond, <span class="literal">NULL</span>);</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; CONSUMERS_COUNT; ++i)</span><br><span class="line">		<span class="built_in">pthread_create</span>(&amp;g_thread[i], <span class="literal">NULL</span>, consume, (<span class="keyword">void</span>*)(<span class="keyword">long</span>)i);</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">sleep</span>(<span class="number">1</span>); </span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; PRODUCERS_COUNT; ++i)</span><br><span class="line">		<span class="built_in">pthread_create</span>(&amp;g_thread[CONSUMERS_COUNT + i], <span class="literal">NULL</span>, produce, (<span class="keyword">void</span>*)(<span class="keyword">long</span>)i);	</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; CONSUMERS_COUNT + PRODUCERS_COUNT; ++i)</span><br><span class="line">		<span class="built_in">pthread_join</span>(g_thread[i], <span class="literal">NULL</span>);	</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">pthread_mutex_destroy</span>(&amp;g_mutex);</span><br><span class="line">	<span class="built_in">pthread_cond_destroy</span>(&amp;g_cond);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="简单的线程池实现"><a href="#简单的线程池实现" class="headerlink" title="简单的线程池实现"></a>简单的线程池实现</h2><p><strong>condition.h</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _CONDITION_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CONDITION_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">condition</span> &#123;</span></span><br><span class="line">	<span class="keyword">pthread_mutex_t</span> pmutex;</span><br><span class="line">	<span class="keyword">pthread_cond_t</span> pcond;</span><br><span class="line">&#125; <span class="keyword">condition_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_init</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_lock</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_unlock</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_wait</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_timedwait</span><span class="params">(<span class="keyword">condition_t</span> *cond, <span class="keyword">const</span> struct timespec *abstime)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_signal</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_broadcast</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_destroy</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _CONDITION_H_ */</span></span></span><br></pre></td></tr></table></figure>
<p><strong>condition.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;condition.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_init</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> status;</span><br><span class="line">	<span class="keyword">if</span>((status = <span class="built_in">pthread_mutex_init</span>(&amp;cond-&gt;pmutex, <span class="literal">NULL</span>)))</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>((status = <span class="built_in">pthread_cond_init</span>(&amp;cond-&gt;pcond, <span class="literal">NULL</span>)))</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_lock</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">pthread_mutex_lock</span>(&amp;cond-&gt;pmutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_unlock</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">pthread_mutex_unlock</span>(&amp;cond-&gt;pmutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_wait</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">pthread_cond_wait</span>(&amp;cond-&gt;pcond, &amp;cond-&gt;pmutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_timedwait</span><span class="params">(<span class="keyword">condition_t</span> *cond, <span class="keyword">const</span> struct timespec *abstime)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">pthread_cond_timedwait</span>(&amp;cond-&gt;pcond, &amp;cond-&gt;pmutex, abstime);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_signal</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">pthread_cond_signal</span>(&amp;cond-&gt;pcond);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_broadcast</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">pthread_cond_broadcast</span>(&amp;cond-&gt;pcond);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_destroy</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> status;</span><br><span class="line">	<span class="keyword">if</span>((status = <span class="built_in">pthread_mutex_destroy</span>(&amp;cond-&gt;pmutex)))</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">if</span>((status = <span class="built_in">pthread_cond_destroy</span>(&amp;cond-&gt;pcond)))</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>threadpool.h</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _THREAD_POOL_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _THREAD_POOL_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;condition.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">task</span> &#123;</span></span><br><span class="line">	<span class="keyword">void</span> *(*run)(<span class="keyword">void</span> *arg); <span class="comment">//任务回调函数</span></span><br><span class="line">	<span class="keyword">void</span> *arg;               <span class="comment">//回调函数参数</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task</span> *<span class="title">next</span>;</span> </span><br><span class="line">&#125; <span class="keyword">task_t</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">threadpool</span> &#123;</span></span><br><span class="line">	<span class="keyword">condition_t</span> ready; <span class="comment">//任务准备就绪或者线程池销毁通知</span></span><br><span class="line">	<span class="keyword">task_t</span> *first;     <span class="comment">//任务队列头指针</span></span><br><span class="line">	<span class="keyword">task_t</span> *last;      <span class="comment">//任务队列尾指针</span></span><br><span class="line">	<span class="keyword">int</span> counter;       <span class="comment">//线程池中当前线程数</span></span><br><span class="line">	<span class="keyword">int</span> idle;          <span class="comment">//线程池中当前正在等待任务的线程数</span></span><br><span class="line">	<span class="keyword">int</span> max_treads;    <span class="comment">//线程池中最大允许的线程数</span></span><br><span class="line">	<span class="keyword">int</span> quit;          <span class="comment">//销毁线程池的时候置1 </span></span><br><span class="line">&#125; <span class="keyword">threadpool_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化线程池 </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadpool_init</span><span class="params">(<span class="keyword">threadpool_t</span> *pool, <span class="keyword">int</span> threads)</span></span>;</span><br><span class="line"><span class="comment">//往线程池中添加任务</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadpool_add_task</span><span class="params">(<span class="keyword">threadpool_t</span> *pool, <span class="keyword">void</span> *(*run)(<span class="keyword">void</span> *arg), <span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="comment">//销毁线程池</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadpool_destroy</span><span class="params">(<span class="keyword">threadpool_t</span> *pool)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _THREAD_POOL_H_ */</span> </span></span><br></pre></td></tr></table></figure>
<p><strong>threadpool.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;threadpool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_routine</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">abstime</span>;</span></span><br><span class="line">	<span class="keyword">int</span> timeout;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x is starting\n&quot;</span>, (<span class="keyword">int</span>)<span class="built_in">pthread_self</span>());</span><br><span class="line">	<span class="keyword">threadpool_t</span> *pool = (<span class="keyword">threadpool_t</span> *)arg;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		timeout = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">condition_lock</span>(&amp;pool-&gt;ready);</span><br><span class="line">		pool-&gt;idle++;</span><br><span class="line">		<span class="comment">//等待队列有任务到来或者线程池销毁通知</span></span><br><span class="line">		<span class="keyword">while</span>(pool-&gt;first == <span class="literal">NULL</span> &amp;&amp; !pool-&gt;quit) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x is waiting\n&quot;</span>, (<span class="keyword">int</span>)<span class="built_in">pthread_self</span>());</span><br><span class="line">			<span class="built_in">clock_gettime</span>(CLOCK_REALTIME, &amp;abstime);</span><br><span class="line">			abstime.tv_sec += <span class="number">2</span>;</span><br><span class="line">			<span class="keyword">int</span> status = <span class="built_in">condition_timedwait</span>(&amp;pool-&gt;ready, &amp;abstime);</span><br><span class="line">			<span class="keyword">if</span>(status == ETIMEDOUT) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x is wait timed out\n&quot;</span>, (<span class="keyword">int</span>)<span class="built_in">pthread_self</span>());</span><br><span class="line">				timeout = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="comment">//等待到条件，处于工作状态 </span></span><br><span class="line">		pool-&gt;idle--;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//等待到任务 </span></span><br><span class="line">		<span class="keyword">if</span>(pool-&gt;first != <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="comment">//从队头取出任务 </span></span><br><span class="line">			<span class="keyword">task_t</span> *t = pool-&gt;first; </span><br><span class="line">			pool-&gt;first = t-&gt;next;</span><br><span class="line">			<span class="comment">//执行任务需要一定时间，所以要先解锁，以便生产者进程</span></span><br><span class="line">			<span class="comment">//能够往队列中添加新任务，其他消费者进程能够进入等待任务 </span></span><br><span class="line">			<span class="built_in">condition_unlock</span>(&amp;pool-&gt;ready);</span><br><span class="line">			t-&gt;<span class="built_in">run</span>(t-&gt;arg);</span><br><span class="line">			<span class="built_in">free</span>(t);</span><br><span class="line">			<span class="built_in">condition_lock</span>(&amp;pool-&gt;ready);</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="comment">//如果等待到线程池销毁通知，且任务都执行完毕 </span></span><br><span class="line">		<span class="keyword">if</span>(pool-&gt;quit &amp;&amp; pool-&gt;first == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			pool-&gt;counter--;</span><br><span class="line">			<span class="keyword">if</span>(pool-&gt;counter == <span class="number">0</span>)</span><br><span class="line">				<span class="built_in">condition_signal</span>(&amp;pool-&gt;ready);</span><br><span class="line">			<span class="comment">//跳出循环之前要基带解锁 </span></span><br><span class="line">			<span class="built_in">condition_unlock</span>(&amp;pool-&gt;ready);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(timeout &amp;&amp; pool-&gt;first == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			pool-&gt;counter--;</span><br><span class="line">			<span class="comment">//跳出循环之前要基带解锁 </span></span><br><span class="line">			<span class="built_in">condition_unlock</span>(&amp;pool-&gt;ready);</span><br><span class="line">			<span class="keyword">break</span>;	</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">condition_unlock</span>(&amp;pool-&gt;ready);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x is exiting\n&quot;</span>, (<span class="keyword">int</span>)<span class="built_in">pthread_self</span>());</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化线程池 </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadpool_init</span><span class="params">(<span class="keyword">threadpool_t</span> *pool, <span class="keyword">int</span> threads)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//对线程池中的各个字段初始化 </span></span><br><span class="line">	<span class="built_in">condition_init</span>(&amp;pool-&gt;ready);</span><br><span class="line">	pool-&gt;first = <span class="literal">NULL</span>;</span><br><span class="line">	pool-&gt;last = <span class="literal">NULL</span>;</span><br><span class="line">	pool-&gt;counter = <span class="number">0</span>;</span><br><span class="line">	pool-&gt;idle = <span class="number">0</span>;</span><br><span class="line">	pool-&gt;max_treads = threads;</span><br><span class="line">	pool-&gt;quit = <span class="number">0</span>;</span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"><span class="comment">//往线程池中添加任务</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadpool_add_task</span><span class="params">(<span class="keyword">threadpool_t</span> *pool, <span class="keyword">void</span> *(*run)(<span class="keyword">void</span> *arg), <span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//生成新任务 </span></span><br><span class="line">	<span class="keyword">task_t</span> *newtask = (<span class="keyword">task_t</span> *)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">task_t</span>));</span><br><span class="line">	newtask-&gt;run = run;</span><br><span class="line">	newtask-&gt;arg = arg;</span><br><span class="line">	newtask-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">condition_lock</span>(&amp;pool-&gt;ready);</span><br><span class="line">	<span class="comment">//将任务添加到队列</span></span><br><span class="line">	<span class="keyword">if</span>(pool-&gt;first == <span class="literal">NULL</span>)</span><br><span class="line">		pool-&gt;first = newtask;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	 	pool-&gt;last-&gt;next = newtask;</span><br><span class="line">	pool-&gt;last = newtask;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//如果有等待线程，则唤醒其中一个 </span></span><br><span class="line">	<span class="keyword">if</span>(pool-&gt;idle &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">condition_signal</span>(&amp;pool-&gt;ready);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(pool-&gt;counter &lt; pool-&gt;max_treads) &#123;</span><br><span class="line">		<span class="comment">//没有等待线程，并且当前线程数不超过最大线程数，则创建一个新线程</span></span><br><span class="line">		<span class="keyword">pthread_t</span> tid;</span><br><span class="line">		<span class="built_in">pthread_create</span>(&amp;tid, <span class="literal">NULL</span>, thread_routine, pool);</span><br><span class="line">		pool-&gt;counter++;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">condition_unlock</span>(&amp;pool-&gt;ready);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//销毁线程池</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadpool_destroy</span><span class="params">(<span class="keyword">threadpool_t</span> *pool)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(pool-&gt;quit) </span><br><span class="line">		<span class="keyword">return</span>; </span><br><span class="line">		</span><br><span class="line">	<span class="built_in">condition_lock</span>(&amp;pool-&gt;ready);	</span><br><span class="line">	pool-&gt;quit = <span class="number">1</span>;	</span><br><span class="line">	<span class="keyword">if</span>(pool-&gt;counter &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>(pool-&gt;idle &gt; <span class="number">0</span>) </span><br><span class="line">			<span class="built_in">condition_broadcast</span>(&amp;pool-&gt;ready);</span><br><span class="line">			</span><br><span class="line">		<span class="comment">//处于执行任务状态中的线程，不会收到广播 </span></span><br><span class="line">		<span class="comment">//线程池需要等待执行任务状态中的线程全部退出 	</span></span><br><span class="line">		<span class="keyword">while</span>(pool-&gt;counter &gt; <span class="number">0</span>) </span><br><span class="line">			<span class="built_in">condition_wait</span>(&amp;pool-&gt;ready);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">condition_unlock</span>(&amp;pool-&gt;ready);</span><br><span class="line">	<span class="built_in">condition_destroy</span>(&amp;pool-&gt;ready);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>main.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;threadpool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">mytask</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x is working on task %d\n&quot;</span>, (<span class="keyword">int</span>)<span class="built_in">pthread_self</span>(), *(<span class="keyword">int</span>*)arg);</span><br><span class="line">	<span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">free</span>(arg);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">threadpool_t</span> pool;</span><br><span class="line">	<span class="built_in">threadpool_init</span>(&amp;pool, <span class="number">3</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">		<span class="keyword">int</span> *arg = (<span class="keyword">int</span>*)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>));</span><br><span class="line">		*arg = i;</span><br><span class="line">		<span class="built_in">threadpool_add_task</span>(&amp;pool, mytask, arg);		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">threadpool_destroy</span>(&amp;pool);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>Makefile</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">OBJS = main.o threadpool.o condition.o</span><br><span class="line">main: $(OBJS)</span><br><span class="line">	g++ $(OBJS) -o main -lpthread -lrt</span><br><span class="line">main.o: main.cpp threadpool.h condition.h</span><br><span class="line">	g++ -c main.cpp -o main.o</span><br><span class="line">threadpool.o: threadpool.cpp threadpool.h condition.h</span><br><span class="line">	g++ -c threadpool.cpp -o threadpool.o</span><br><span class="line">condition.o: condition.cpp condition.h</span><br><span class="line">	g++ -c condition.cpp -o condition.o</span><br><span class="line">clean:</span><br><span class="line">	rm -rf *.o main</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/29/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Albert -W">
      <meta itemprop="description" content="更不更新看心情">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不先进摸鱼研究所">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/29/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%91/" class="post-title-link" itemprop="url">数据结构-树</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-08-29 22:25:03 / Modified: 22:58:44" itemprop="dateCreated datePublished" datetime="2021-08-29T22:25:03+08:00">2021-08-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="二叉树的基本结构"><a href="#二叉树的基本结构" class="headerlink" title="二叉树的基本结构"></a>二叉树的基本结构</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> tree *treeNode</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tree</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line">    treeNode* left;</span><br><span class="line">    treeNode* right;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="二叉树的遍历"><a href="#二叉树的遍历" class="headerlink" title="二叉树的遍历"></a>二叉树的遍历</h1><h2 id="递归方法的先序遍历"><a href="#递归方法的先序遍历" class="headerlink" title="递归方法的先序遍历"></a>递归方法的先序遍历</h2><ol>
<li>先序方法。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PreOrdertravelSal</span><span class="params">(binTree BT)</span></span>&#123;</span><br><span class="line">    cout&lt;&lt;BT-&gt;data;</span><br><span class="line">    <span class="built_in">PreOrderTravelSal</span>(BT-&gt;left);    <span class="comment">//向下遍历左子树</span></span><br><span class="line">    <span class="built_in">PreOrderTravelSal</span>(BT-&gt;right);   <span class="comment">//向下遍历右子树</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>中序方法。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InOrderTravelsal</span><span class="params">(binTree BT)</span></span>&#123;</span><br><span class="line">    <span class="built_in">InOrderTravelsal</span>(BT-&gt;left);</span><br><span class="line">    cout&lt;&lt;BT-&gt;data;</span><br><span class="line">    <span class="built_in">InOrderTravelsal</span>(BT-&gt;right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="非递归方法的先序遍历"><a href="#非递归方法的先序遍历" class="headerlink" title="非递归方法的先序遍历"></a>非递归方法的先序遍历</h2><p>需要考虑使用堆栈。<br>利用堆栈模拟递归过程。<br>具体方法如下：(以中序遍历为例):</p>
<ol>
<li>遇到一个节点,压栈,遍历左子树；</li>
<li>左子树遍历结束，从栈顶依次弹出，并print；</li>
<li>按转向右指针，重复1.之后</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inOrderTraversal</span><span class="params">(bin BT)</span></span>&#123;</span><br><span class="line">    bin T = BT;</span><br><span class="line">    stact S = <span class="built_in">creatStack</span>(maxSize);  <span class="comment">//建栈</span></span><br><span class="line">    <span class="keyword">while</span>(T || !<span class="built_in">isEmpty</span>(S))&#123;        <span class="comment">//子树为空或者栈为空时停止操作。</span></span><br><span class="line">        <span class="keyword">while</span>(T)&#123;</span><br><span class="line">            <span class="built_in">push</span>(S,T);          <span class="comment">//将当前节点压入堆栈</span></span><br><span class="line">            T = T-&gt;left;        <span class="comment">//向左访问</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">isEmpty</span>(S))&#123;            <span class="comment">//从栈顶依次弹出</span></span><br><span class="line">            T = <span class="built_in">pop</span>(S);</span><br><span class="line">            cout&lt;&lt;T-&gt;data;</span><br><span class="line">            T=T-&gt;right;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="层序遍历"><a href="#层序遍历" class="headerlink" title="层序遍历"></a>层序遍历</h2><ol>
<li>根节点入队</li>
<li>节点出队——子节点入队——队列出队</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">levelOrderTraversal</span><span class="params">(bin BT)</span></span>&#123;</span><br><span class="line">    queue Q;</span><br><span class="line">    bin T = BT;</span><br><span class="line">    <span class="keyword">if</span>(!BT) <span class="keyword">return</span>; <span class="comment">//空树，直接返回</span></span><br><span class="line">    Q = <span class="built_in">createQueue</span>(maxSize);</span><br><span class="line">    <span class="built_in">addQ</span>( Q , BT); <span class="comment">//根节点入队</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">isEmptyQ</span>(Q))&#123;</span><br><span class="line">        T = <span class="built_in">delectQ</span>(Q);</span><br><span class="line">        cout&lt;&lt;T-&gt;data;                  <span class="comment">//根节点出队</span></span><br><span class="line">        <span class="keyword">if</span>(T-&gt;left) <span class="built_in">Add</span>(Q,T-&gt;left);     <span class="comment">//子节点入队</span></span><br><span class="line">        <span class="keyword">if</span>(T-&gt;right) <span class="built_in">Add</span>(Q,T-&gt;right);   <span class="comment">//子节点入队</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><h3 id="输出二叉树的叶节点"><a href="#输出二叉树的叶节点" class="headerlink" title="输出二叉树的叶节点"></a>输出二叉树的叶节点</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">leave</span><span class="params">(bin BT)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!(BT-&gt;left||BT-&gt;right)) cout&lt;&lt;BT-&gt;data;</span><br><span class="line">    <span class="built_in">leave</span>(BT-&gt;left);</span><br><span class="line">    <span class="built_in">leave</span>(BT-&gt;right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="求二叉树的高度"><a href="#求二叉树的高度" class="headerlink" title="求二叉树的高度"></a>求二叉树的高度</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">height</span><span class="params">(bin BT)</span></span>&#123;</span><br><span class="line">   <span class="keyword">int</span> HL,HR,maxH;</span><br><span class="line">   <span class="keyword">if</span>(BT)&#123;</span><br><span class="line">       HL = <span class="built_in">height</span>(BT-&gt;left);</span><br><span class="line">       HR = <span class="built_in">height</span>(BT-&gt;right);</span><br><span class="line">       maxH = (HL&gt;HR)?HL:HR;</span><br><span class="line">       <span class="keyword">return</span> (maxH +<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="根据先序和中序遍历重建二叉树"><a href="#根据先序和中序遍历重建二叉树" class="headerlink" title="根据先序和中序遍历重建二叉树"></a>根据先序和中序遍历重建二叉树</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">buildTree</span><span class="params">(vector&lt;<span class="keyword">int</span>&gt;&amp; preorder, vector&lt;<span class="keyword">int</span>&gt;&amp; inorder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;preorder = preorder;</span><br><span class="line">        <span class="comment">//建立前中序对应关系。</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;inorder.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">            map[inorder[i]] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        TreeNode* res = <span class="built_in">recur</span>(<span class="number">0</span>,<span class="number">0</span>,preorder.<span class="built_in">size</span>()<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    unordered_map&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt; map;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; preorder;</span><br><span class="line">    <span class="function">TreeNode* <span class="title">recur</span><span class="params">(<span class="keyword">int</span> root,<span class="keyword">int</span> left,<span class="keyword">int</span> right)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(left&gt;right) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        TreeNode* res = <span class="keyword">new</span> <span class="built_in">TreeNode</span>(preorder[root]);</span><br><span class="line">        <span class="keyword">int</span> pos = map[preorder[root]];      <span class="comment">//根节点在中序遍历的位置</span></span><br><span class="line">        <span class="keyword">int</span> leftSize = pos - left;          <span class="comment">//左子树的长度</span></span><br><span class="line">        res-&gt;left = <span class="built_in">recur</span>(root+<span class="number">1</span>,left,pos<span class="number">-1</span>);<span class="comment">//</span></span><br><span class="line">        res-&gt;right = <span class="built_in">recur</span>(root+leftSize+<span class="number">1</span>,pos+<span class="number">1</span>,right);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="二叉树的侧视图"><a href="#二叉树的侧视图" class="headerlink" title="二叉树的侧视图"></a>二叉树的侧视图</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * struct TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode *left;</span></span><br><span class="line"><span class="comment"> *     TreeNode *right;</span></span><br><span class="line"><span class="comment"> *     TreeNode() : val(0), left(nullptr), right(nullptr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) : val(x), left(nullptr), right(nullptr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x, TreeNode *left, TreeNode *right) : val(x), left(left), right(right) &#123;&#125;</span></span><br><span class="line"><span class="comment"> * &#125;;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="keyword">int</span>&gt; <span class="title">rightSideView</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">        queue&lt;TreeNode*&gt; queue;</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">nullptr</span>) <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        queue.<span class="built_in">push</span>(root);</span><br><span class="line">        <span class="keyword">while</span>(!queue.<span class="built_in">empty</span>())&#123;</span><br><span class="line">            <span class="keyword">int</span> right = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i =  queue.<span class="built_in">size</span>(); i &gt; <span class="number">0</span>; i--)&#123;</span><br><span class="line">                root = queue.<span class="built_in">front</span>();</span><br><span class="line">                queue.<span class="built_in">pop</span>();</span><br><span class="line">                <span class="keyword">if</span>(root-&gt;left != <span class="literal">nullptr</span>) queue.<span class="built_in">push</span>(root-&gt;left);</span><br><span class="line">                <span class="keyword">if</span>(root-&gt;right != <span class="literal">nullptr</span>) queue.<span class="built_in">push</span>(root-&gt;right);</span><br><span class="line">                right = root-&gt;val;</span><br><span class="line">            &#125;</span><br><span class="line">            res.<span class="built_in">push_back</span>(right);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="二叉树的序列化和反序列化"><a href="#二叉树的序列化和反序列化" class="headerlink" title="二叉树的序列化和反序列化"></a>二叉树的序列化和反序列化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * struct TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     TreeNode *left;</span></span><br><span class="line"><span class="comment"> *     TreeNode *right;</span></span><br><span class="line"><span class="comment"> *     TreeNode(int x) : val(x), left(NULL), right(NULL) &#123;&#125;</span></span><br><span class="line"><span class="comment"> * &#125;;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Codec</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    string data;</span><br><span class="line">    <span class="comment">// Encodes a tree to a single string.</span></span><br><span class="line">    <span class="function">string <span class="title">serialize</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">recur_Serialize</span>(root);</span><br><span class="line">        <span class="keyword">return</span> data;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Decodes your encoded data to tree.</span></span><br><span class="line">    <span class="function">TreeNode* <span class="title">deserialize</span><span class="params">(string data)</span> </span>&#123;</span><br><span class="line">        list&lt;string&gt; dataAry;</span><br><span class="line">        string single;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">char</span> ch:data)&#123;</span><br><span class="line">            <span class="keyword">if</span>(ch ==<span class="string">&#x27;,&#x27;</span>)&#123;</span><br><span class="line">                dataAry.<span class="built_in">push_back</span>(single);</span><br><span class="line">                single.<span class="built_in">clear</span>();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                single.<span class="built_in">push_back</span>(ch);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(single.<span class="built_in">size</span>() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            dataAry.<span class="built_in">push_back</span>(single);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">recur_Deserialize</span>(dataAry);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">recur_Serialize</span><span class="params">(TreeNode* root)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(root == <span class="literal">nullptr</span>)&#123;</span><br><span class="line">            data += <span class="string">&quot;null,&quot;</span>;            <span class="comment">//如果遇到空节点，那么就输入null标识符，这样遍历的序列就是唯一的。</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            data += <span class="built_in">to_string</span>(root-&gt;val) + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">            <span class="built_in">recur_Serialize</span>(root-&gt;left);</span><br><span class="line">            <span class="built_in">recur_Serialize</span>(root-&gt;right);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">TreeNode* <span class="title">recur_Deserialize</span><span class="params">(list&lt;string&gt; &amp;dataAry)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(dataAry.<span class="built_in">front</span>() == <span class="string">&quot;null&quot;</span>)&#123;</span><br><span class="line">            dataAry.<span class="built_in">erase</span>(dataAry.<span class="built_in">begin</span>());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            TreeNode* root = <span class="keyword">new</span> <span class="built_in">TreeNode</span>( <span class="built_in">stoi</span>(dataAry.<span class="built_in">front</span>()) );</span><br><span class="line">            dataAry.<span class="built_in">erase</span>(dataAry.<span class="built_in">begin</span>());</span><br><span class="line">            root-&gt;left = <span class="built_in">recur_Deserialize</span>(dataAry);</span><br><span class="line">            root-&gt;right = <span class="built_in">recur_Deserialize</span>(dataAry);</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Your Codec object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment">// Codec ser, deser;</span></span><br><span class="line"><span class="comment">// TreeNode* ans = deser.deserialize(ser.serialize(root));</span></span><br></pre></td></tr></table></figure>
<h1 id="二叉搜索树"><a href="#二叉搜索树" class="headerlink" title="二叉搜索树"></a>二叉搜索树</h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>BST的定义：</p>
<ol>
<li>非空左子树的所有键值小于其根节点的键值</li>
<li>非空右子树的所有键值大于其根节点的键值</li>
<li>左右子树皆为BST。</li>
</ol>
<p>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">position <span class="title">find</span><span class="params">(<span class="keyword">float</span> x,bin BST)</span></span>;</span><br><span class="line"><span class="function">position <span class="title">findMin</span><span class="params">(bin BST)</span></span>;</span><br><span class="line"><span class="function">position <span class="title">findMax</span><span class="params">(bin BST)</span></span>;</span><br><span class="line"><span class="function">bin <span class="title">insert</span><span class="params">(<span class="keyword">float</span> x,bin BST)</span></span>;</span><br><span class="line"><span class="function">bin <span class="title">delect</span><span class="params">(<span class="keyword">float</span> x, bin BST)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="查找操作"><a href="#查找操作" class="headerlink" title="查找操作"></a>查找操作</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">position <span class="title">find</span><span class="params">(<span class="keyword">float</span> x,bin BST)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!BST) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>(x &lt; BST-&gt;data)<span class="built_in">find</span>(x,BST-&gt;left);</span><br><span class="line">    <span class="keyword">if</span>(x &gt; BST-&gt;data)<span class="built_in">find</span>(x,BST-&gt;right);</span><br><span class="line">    <span class="keyword">if</span>(x == BST-&gt;data) <span class="keyword">return</span> BST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>非递归的情况：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">position <span class="title">iterfind</span><span class="params">(<span class="keyword">float</span> x,bin BST)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!BST) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span>(BST)&#123;         <span class="comment">//BST不为空的时候</span></span><br><span class="line">        <span class="keyword">if</span>(x &lt; BST-&gt;data) BST = BST-&gt;left;</span><br><span class="line">        <span class="keyword">if</span>(x &gt; BST-&gt;data) BST = BST-&gt;right;</span><br><span class="line">        <span class="keyword">if</span>(x == BST-&gt;data) <span class="keyword">return</span> BST;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>搜索树查找的效率取决于树的高度。<br>查找最大和最小的元素：</p>
<ol>
<li>最大元素处于最右端；</li>
<li>最小元素处于最左端。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">position <span class="title">findMax</span><span class="params">(bin BST)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!BST) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span>(BST-&gt;right)&#123;</span><br><span class="line">        BST = BST-&gt;right;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BST;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">position <span class="title">findMIn</span><span class="params">(bin BST)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!BST) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">while</span>(BST-&gt;left)&#123;</span><br><span class="line">        BST = BST-&gt;left;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h2><p>二叉树的插入：插在最近叶子节点的左边或右边。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">bin <span class="title">insert</span><span class="params">(<span class="keyword">float</span> x,bin BT)</span></span>&#123;</span><br><span class="line">    bin <span class="keyword">new</span>;</span><br><span class="line">    <span class="keyword">while</span>(BT-&gt;left||BT-&gt;right)&#123;</span><br><span class="line">        <span class="keyword">if</span>(x &lt; BT) BT = BT-&gt;left;</span><br><span class="line">        <span class="keyword">if</span>(x &gt; BT) BT = BT-&gt;right;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">new</span> = (bin)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(bin))  <span class="comment">//为新的节点申请内存</span></span><br><span class="line">    <span class="keyword">new</span>-&gt;data = x</span><br><span class="line">    <span class="keyword">if</span>(x&lt;BT) BT-&gt;left = <span class="keyword">new</span>;</span><br><span class="line">    <span class="keyword">if</span>(x&gt;=BT) BT-&gt;right = <span class="keyword">new</span>;</span><br><span class="line">    <span class="keyword">return</span> BT</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//删除</span></span><br><span class="line">bin <span class="built_in">delect</span>(<span class="keyword">float</span> x,bin BT)&#123;</span><br><span class="line">    BT = <span class="built_in">find</span>(x,BT);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><p>考虑三种情况：</p>
<ol>
<li>如果是叶节点：直接删除，并令其父节点为NULL</li>
<li>如果度为1：  父节点指向子节点</li>
<li>度为2：用另外一个节点替代被删除的结点。取右子树的最小元素或者左子树的最大元素。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">bin <span class="title">delect</span><span class="params">(<span class="keyword">int</span> val; bin BST)</span></span>&#123;</span><br><span class="line">    bin *temp;          <span class="comment">//临时指针</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//查找树</span></span><br><span class="line">    <span class="keyword">if</span>(!BST)cout&lt;&lt;<span class="string">&quot;empty&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(val &lt; BST-&gt;data)&#123;</span><br><span class="line">        BST-&gt;left = <span class="built_in">delect</span>(val,BST-&gt;left);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(val &gt; BST-&gt;data)&#123;</span><br><span class="line">        BST-&gt;right = <span class="built_in">delect</span>(val,BST-&gt;right);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;              <span class="comment">//找到了目标节点，开始进行删除过程</span></span><br><span class="line">       <span class="keyword">if</span>(BST-&gt;left &amp;&amp; BST-&gt;right)&#123;</span><br><span class="line">           temp = <span class="built_in">findMin</span>(BST-&gt;right);</span><br><span class="line">           BST-&gt;data = temp-&gt;data;</span><br><span class="line">           BST-&gt;right = <span class="built_in">delect</span>(BST-&gt;data,BST-&gt;right);</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           temp = BST;</span><br><span class="line">           <span class="keyword">if</span>(!BST-&gt;left) BST = BST-&gt;right;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span>(!BST-&gt;right) BST=BST-&gt;left;</span><br><span class="line">           <span class="built_in">free</span>(temp);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="平衡二叉树"><a href="#平衡二叉树" class="headerlink" title="平衡二叉树"></a>平衡二叉树</h1><p>平衡因子：</p>
<script type="math/tex; mode=display">
BF(T) = h_L-h_R</script><p>平衡二叉树（AVL树）：任一节点左右子树高度差的绝对值不超过1.<br>平衡二叉树的最大高度：<br>高度和节点之间的关系</p>
<script type="math/tex; mode=display">
n_h = n_{h-1}+n_{h-2}+1</script><script type="math/tex; mode=display">
n_h = F_{h+2}-1          

    = \frac{1}{\sqrt{5}}(\frac{1+\sqrt{5}}{2})^{h+2} -1</script><script type="math/tex; mode=display">
h=O(log_2n)</script><p>与完全二叉树类似。</p>
<h1 id="huffmann树"><a href="#huffmann树" class="headerlink" title="huffmann树"></a>huffmann树</h1><h2 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h2><p>1。 带权路径长度*(WPL): 设二叉树有n个叶节点，每个叶节点的权值是<code>$w_k$</code>,从根到叶的长度是<code>$l_K$</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WPL = \Sigma^&#123;n&#125;_&#123;k=1&#125;w_k l_k</span><br></pre></td></tr></table></figure></p>
<ol>
<li>Huffmann树具有最小的WPL  </li>
</ol>
<h2 id="构造"><a href="#构造" class="headerlink" title="构造"></a>构造</h2><p>构造方法：每次把权值最小的两棵二叉树合并，并形成一个新的二叉树<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">treeNode</span> *<span class="title">HuffmanTree</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">treeNode</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> weight;</span><br><span class="line">    huffmanTree left,right;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">huffmanTree <span class="title">huffman</span><span class="params">(minHeap H)</span></span>&#123;<span class="comment">//根据最小堆搭建hoffman树</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    huffmanTree T;</span><br><span class="line">    H.<span class="built_in">build</span>();</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">1</span>;i&lt;H-&gt;size;i++)&#123;</span><br><span class="line">        T = <span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(struct treeNode));</span><br><span class="line">        T-&gt;left = H.delectMin;</span><br><span class="line">        T-&gt;right = H.delectMin;</span><br><span class="line">        T-&gt;weight = T-&gt;left-&gt;weight + T-&gt;right-&gt;weight;</span><br><span class="line">        H.<span class="built_in">insert</span>(T);</span><br><span class="line">    &#125;</span><br><span class="line">    T = H.delectMin;</span><br><span class="line">    <span class="keyword">return</span> T;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="特征"><a href="#特征" class="headerlink" title="特征"></a>特征</h2><ol>
<li>没有度为1的 节点；</li>
<li>n个叶节点的huffman树一共具有2n-1个节点；</li>
<li>Huffman的任意非叶节点的左右子树交换后仍然是Huffman树</li>
<li>对于一组权值${w_1,w_2,…,w_n}$,其Huffman树是唯一的</li>
</ol>
<h2 id="Huffman编码"><a href="#Huffman编码" class="headerlink" title="Huffman编码"></a>Huffman编码</h2><p>对字符串进行编码，使得该字符串的编码存储空间最少。</p>
<ol>
<li>不等长编码技术：高频字长度小，低频字长度大；</li>
<li>避免二义性：所有的字符都在二叉树的叶节点上。左为0，右为1<br>利用Huffman树构造的字符串编码即为Huffman编码</li>
</ol>
<h1 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>是一种具有优先级的队列，出队的顺序依照优先级排序，而不是简单的先入先出模式。</p>
<h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">maxHeap <span class="title">create</span><span class="params">(<span class="keyword">int</span> maxSize)</span></span>;</span><br><span class="line"><span class="function">boolean <span class="title">isFul</span><span class="params">(maxHeap H)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(maxHeap H,<span class="keyword">int</span> item)</span></span>;</span><br><span class="line"><span class="function">boolean <span class="title">isEmpty</span><span class="params">(maxHeap H)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">delectMax</span><span class="params">(maxHeap H)</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="如何实现"><a href="#如何实现" class="headerlink" title="如何实现"></a>如何实现</h2><ol>
<li>采用二叉搜索树——完全二叉树进行存储。     </li>
<li>父节点永远大于两个子节点。</li>
</ol>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><ol>
<li>最大堆；父节点是最大的</li>
<li>最小堆；父节点是最小的<br><strong>堆应当是有序的</strong>。这就是说，从根节点指定一条路径到叶节点，节点值应该是在递减的。      </li>
</ol>
<h2 id="5操作如何实现"><a href="#5操作如何实现" class="headerlink" title="5操作如何实现"></a>5操作如何实现</h2><h3 id="堆的数据结构"><a href="#堆的数据结构" class="headerlink" title="堆的数据结构"></a>堆的数据结构</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">heapStruct</span> *<span class="title">maxHeap</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">heapStruct</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> *val;        <span class="comment">//储存堆元素的数组</span></span><br><span class="line">    <span class="keyword">int</span> Size;        <span class="comment">//堆当前元素的个数</span></span><br><span class="line">    <span class="keyword">int</span> capacity;    <span class="comment">//堆的最大容量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="堆的建立"><a href="#堆的建立" class="headerlink" title="堆的建立"></a>堆的建立</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">maxHeap <span class="title">create</span><span class="params">(<span class="keyword">int</span> maxSize)</span></span>&#123;</span><br><span class="line">    maxHeap H = (maxHeap)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(struct heapStruct));</span><br><span class="line">    H-&gt;val = <span class="built_in">malloc</span>((maxSize+<span class="number">1</span>) * <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>));</span><br><span class="line">    H-&gt;size = <span class="number">0</span>;</span><br><span class="line">    H-&gt;capacity = maxSize;</span><br><span class="line">    H-&gt;val[<span class="number">0</span>] = maxData;            <span class="comment">//哨兵位，这里是堆的最大值。</span></span><br><span class="line">    <span class="keyword">return</span> H;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//利用递归实现最大堆的插入:让当前元素与其父节点交换。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(maxHeap H,<span class="keyword">int</span> val)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">isFull</span>(H)&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;最大堆已满&quot;</span>&lt;&lt;endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    i = ++H-&gt;size;  <span class="comment">//i应当指向插入后堆中的最后一个元素的位置。哨兵位。</span></span><br><span class="line">    <span class="keyword">for</span> ( ;H-&gt;val[i/<span class="number">2</span>]&lt;item; i/=<span class="number">2</span>)&#123;     <span class="comment">//父节点是i/2,父子换位</span></span><br><span class="line">        H-&gt;val[i] = H-&gt;val[i/<span class="number">2</span>]; <span class="comment">//向下过滤结点</span></span><br><span class="line">    &#125;</span><br><span class="line">    H-&gt;val[i] = item;       <span class="comment">//插入</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//最大堆删除过程：用下面的数组向上进行替补。</span></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">delectMax</span>(maxHeap H)&#123;</span><br><span class="line">    <span class="keyword">int</span> parent,chile;</span><br><span class="line">    <span class="keyword">int</span> maxItem,temp;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">isEmpty</span>(H))&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;堆已空&quot;</span>&lt;&lt;endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    maxItem = H-&gt;Elements[<span class="number">1</span>];</span><br><span class="line">    temp = H-&gt;Elemnts[H-&gt;Size--];</span><br><span class="line">    <span class="comment">//为temp寻找一个位置</span></span><br><span class="line">    <span class="keyword">for</span>(parent = <span class="number">1</span>; parent*<span class="number">2</span>&lt;= H-&gt;size; Parent=Child)&#123;</span><br><span class="line">        child = parent*<span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span>((child!=H-&gt;size) &amp;&amp;  (H-&gt;val[child] &lt; H-&gt;val[child+<span class="number">1</span>]) child ++;</span><br><span class="line">        <span class="keyword">if</span>(temp &gt;= H-&gt;val[child]) <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            H-&gt;val[parent] = H-&gt;val[child];</span><br><span class="line">    &#125;</span><br><span class="line">    H-&gt;val[parent] = temp;</span><br><span class="line">    <span class="keyword">return</span> maxItem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最大堆的建立过程有两个方法：</p>
<ol>
<li>利用插入函数void insert将每个元素依次插入到堆中去。其时间复杂度是<code>$O(NlogN)$</code></li>
<li>线性化的方法：<ol>
<li>将N个元素按照输入顺序存入，首先满足<strong>结构特性</strong></li>
<li>调整各个节点的位置，使之满足<strong>有序特性</strong>——向前调节的过程。</li>
</ol>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/29/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E9%9D%A2%E7%BB%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Albert -W">
      <meta itemprop="description" content="更不更新看心情">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不先进摸鱼研究所">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/29/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E9%9D%A2%E7%BB%8F/" class="post-title-link" itemprop="url">操作系统-面经</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-08-29 22:23:25 / Modified: 22:23:50" itemprop="dateCreated datePublished" datetime="2021-08-29T22:23:25+08:00">2021-08-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9D%A2%E7%BB%8F/" itemprop="url" rel="index"><span itemprop="name">面经</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>[toc]</p>
<h2 id="操作系统的基本概念"><a href="#操作系统的基本概念" class="headerlink" title="操作系统的基本概念"></a>操作系统的基本概念</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>操作系统是运行在计算机上最重要的一种软件，它管理计算机的资源和进程以及所有的硬件和软件。它为计算机硬件和软件提供了一种中间层</p>
<p><img src="https://pic.leetcode-cn.com/1612667552-sYGAdX-os8-0.png" alt="image"></p>
<p>通常情况下，计算机上会运行着许多应用程序，它们都需要对内存和 CPU 进行交互，操作系统的目的就是为了保证这些访问和交互能够准确无误的进行。</p>
<h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><ul>
<li>管理计算机资源，这些资源包括 CPU、内存、磁盘驱动器、打印机等。</li>
<li>提供一种图形界面，就像我们前面描述的那样，它提供了用户和计算机之间的桥梁。</li>
<li>为其他软件提供服务，操作系统与软件进行交互，以便为其分配运行所需的任何必要资源。</li>
</ul>
<h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p><img src="https://mmbiz.qpic.cn/mmbiz_png/J0g14CUwaZcrrw2Viat1D5a2tKCcAB3p0qjbgAWHPb9cEWoUuvDaX10CNnDlemF2aXiayiauQgYt5EvjA7o6SOTyA/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="image"></p>
<h4 id="单体系统"><a href="#单体系统" class="headerlink" title="单体系统"></a>单体系统</h4><p><img src="https://pic.leetcode-cn.com/1612667555-PjcHRt-os8-1.png" alt="image"></p>
<h4 id="分层系统"><a href="#分层系统" class="headerlink" title="分层系统"></a>分层系统</h4><p><img src="https://pic.leetcode-cn.com/1612667560-oKBJCb-os8-2.png" alt="image"></p>
<h4 id="微内核"><a href="#微内核" class="headerlink" title="微内核"></a>微内核</h4><p><img src="https://pic.leetcode-cn.com/1612667563-gDSXga-os8-3.png" alt="image"><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/2yiZZPjKmmFdoIlHC-jjxw">linux内核与Windows内核</a></p>
<h4 id="客户-服务器模式"><a href="#客户-服务器模式" class="headerlink" title="客户-服务器模式"></a>客户-服务器模式</h4><p><img src="https://pic.leetcode-cn.com/1612667567-TCNgmS-os8-4.png" alt="image"></p>
<h2 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h2><h2 id="进程之间的通信"><a href="#进程之间的通信" class="headerlink" title="进程之间的通信"></a>进程之间的通信</h2><h3 id="通信概念"><a href="#通信概念" class="headerlink" title="通信概念"></a>通信概念</h3><p><img src="https://pic.leetcode-cn.com/1612667581-skmJvk-os8-9.png" alt="image"></p>
<ul>
<li><p><strong>竞态条件</strong>：即两个或多个线程同时对一共享数据进行修改，从而影响程序运行的正确性时，这种就被称为竞态条件(race condition)。</p>
</li>
<li><p><strong>临界区</strong>：不仅共享资源会造成竞态条件，事实上共享文件、共享内存也会造成竞态条件、那么该如何避免呢？或许一句话可以概括说明：禁止一个或多个进程在同一时刻对共享资源（包括共享内存、共享文件等）进行读写。换句话说，我们需要一种 互斥(mutual exclusion) 条件，这也就是说，如果一个进程在某种方式下使用共享变量和文件的话，除该进程之外的其他进程就禁止做这种事（访问统一资源）。</p>
</li>
</ul>
<p>一个好的解决方案，应该包含下面四种条件</p>
<ol>
<li>任何时候两个进程不能同时处于临界区</li>
<li>不应对 CPU 的速度和数量做任何假设</li>
<li>位于临界区外的进程不得阻塞其他进程</li>
<li>不能使任何进程无限等待进入临界区</li>
</ol>
<ul>
<li><strong>忙等互斥</strong>：当一个进程在对资源进行修改时，其他进程必须进行等待，进程之间要具有互斥性，我们讨论的解决方案其实都是基于忙等互斥提出的。<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><img src="https://pic.leetcode-cn.com/1612667584-BSuuNg-os8-10.png" alt="image"></li>
<li><strong>消息传递</strong>：消息传递是进程间实现通信和同步等待的机制，使用消息传递，进程间的交流不需要共享变量，直接就可以进行通信；消息传递分为发送方和接收方</li>
<li><strong>先进先出队列</strong>：先进先出队列指的是两个不相关联进程间的通信，两个进程之间可以彼此相互进程通信，这是一种全双工通信方式</li>
<li><strong>管道</strong>：管道用于两个相关进程之间的通信，这是一种半双工的通信方式，如果需要全双工，需要另外一个管道。</li>
<li><strong>直接通信</strong>：在这种进程通信的方式中，进程与进程之间只存在一条链接，进程间要明确通信双方的命名。</li>
<li><strong>间接通信</strong>：间接通信是通信双方不会直接建立连接，而是找到一个中介者，这个中介者可能是个对象等等，进程可以在其中放置消息，并且可以从中删除消息，以此达到进程间通信的目的。</li>
<li><strong>消息队列</strong>：消息队列是内核中存储消息的链表，它由消息队列标识符进行标识，这种方式能够在不同的进程之间提供全双工的通信连接。</li>
<li><strong>共享内存</strong>：共享内存是使用所有进程之间的内存来建立连接，这种类型需要同步进程访问来相互保护。</li>
</ul>
<h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><p>死锁的出现需要同时满足下面四个条件</p>
<ul>
<li><strong>互斥(Mutual Exclusion)</strong>：一次只能有一个进程使用资源。如果另一个进程请求该资源，则必须延迟请求进程，直到释放该资源为止。</li>
<li><strong>保持并等待(Hold and Wait)</strong>：必须存在一个进程，该进程至少持有一个资源，并且正在等待获取其他进程当前所持有的资源。</li>
<li><strong>无抢占(No Preemption)</strong>：资源不能被抢占，也就是说，在进程完成其任务之后，只能由拥有它的进程自动释放资源。</li>
<li><strong>循环等待(Circular Wait)</strong> ：必须存在一组 {p0，p1，….. pn} 的等待进程，使 p0 等待 p1 持有的资源，p1 等待由 p2 持有的资源， pn-1 正在等待由 pn 持有的资源，而 pn 正在等待由 p0 持有的资源。</li>
</ul>
<h2 id="RAID"><a href="#RAID" class="headerlink" title="RAID"></a>RAID</h2><p>RAID 称为 磁盘冗余阵列，简称磁盘阵列。利用虚拟化技术把多个硬盘结合在一起，成为一个或多个磁盘阵列组，目的是提升性能或数据冗余。</p>
<h3 id="RAID的级别："><a href="#RAID的级别：" class="headerlink" title="RAID的级别："></a>RAID的级别：</h3><ul>
<li>RAID 0 - 无容错的条带化磁盘阵列</li>
<li>RAID 1 - 镜像和双工</li>
<li>RAID 2 - 内存式纠错码</li>
<li>RAID 3 - 比特交错奇偶校验</li>
<li>RAID 4 - 块交错奇偶校验</li>
<li>RAID 5 - 块交错分布式奇偶校验</li>
<li>RAID 6 - P + Q冗余</li>
</ul>
<h3 id="RAID的三个功能："><a href="#RAID的三个功能：" class="headerlink" title="RAID的三个功能："></a>RAID的三个功能：</h3><ol>
<li>通过对磁盘上的数据进行条带化，实现对数据成块存取，减少磁盘的机械寻道时间，提高了数据存取速度。 [3] </li>
<li>通过对一个阵列中的几块磁盘同时读取，减少了磁盘的机械寻道时间，提高数据存取速度。 [3] </li>
<li>通过镜像或者存储奇偶校验信息的方式，实现了对数据的冗余保护。</li>
</ol>
<h2 id="进程之间的状态"><a href="#进程之间的状态" class="headerlink" title="进程之间的状态"></a>进程之间的状态</h2><p><img src="https://pic.leetcode-cn.com/1612667586-uBtHVk-os8-11.png" alt="image"><br>图中会涉及三种状态</p>
<ul>
<li>运行态，运行态指的就是进程实际占用 CPU 时间片运行时</li>
<li>就绪态，就绪态指的是可运行，但因为其他进程正在运行而处于就绪状态</li>
<li>阻塞态，除非某种外部事件发生，否则进程不能运行</li>
</ul>
<p>逻辑上来说，运行态和就绪态是很相似的。这两种情况下都表示进程可运行，但是第二种情况没有获得 CPU 时间分片。第三种状态与前两种状态不同的原因是这个进程不能运行，CPU 空闲时也不能运行。</p>
<p>三种状态会涉及四种状态间的切换，在操作系统发现进程不能继续执行时会发生状态1的轮转，在某些系统中进程执行系统调用，例如 pause，来获取一个阻塞的状态。在其他系统中包括 UNIX，当进程从管道或特殊文件（例如终端）中读取没有可用的输入时，该进程会被自动终止。</p>
<p>转换 2 和转换 3 都是由进程调度程序（操作系统的一部分）引起的，进程本身不知道调度程序的存在。转换 2 的出现说明进程调度器认定当前进程已经运行了足够长的时间，是时候让其他进程运行 CPU 时间片了。当所有其他进程都运行过后，这时候该是让第一个进程重新获得 CPU 时间片的时候了，就会发生转换 3。</p>
<p>程序调度指的是，决定哪个进程优先被运行和运行多久，这是很重要的一点。已经设计出许多算法来尝试平衡系统整体效率与各个流程之间的竞争需求。</p>
<p>当进程等待的一个外部事件发生时（如从外部输入一些数据后），则发生转换 4。如果此时没有其他进程在运行，则立刻触发转换 3，该进程便开始运行，否则该进程会处于就绪阶段，等待 CPU 空闲后再轮到它运行。</p>
<h2 id="调度算法"><a href="#调度算法" class="headerlink" title="调度算法"></a>调度算法</h2><h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><ol>
<li>批处理中的调度 </li>
<li>交互系统中的调度</li>
<li>实时系统中的调度<h3 id="批处理中调度"><a href="#批处理中调度" class="headerlink" title="批处理中调度"></a>批处理中调度</h3><h4 id="FCFS-先来先服务"><a href="#FCFS-先来先服务" class="headerlink" title="FCFS-先来先服务"></a>FCFS-先来先服务</h4><img src="https://pic.leetcode-cn.com/1612667589-KeikWR-os8-12.png" alt="image"><br>很像是先到先得。。。可能最简单的非抢占式调度算法的设计就是 先来先服务(first-come,first-serverd)。使用此算法，将按照请求顺序为进程分配 CPU。最基本的，会有一个就绪进程的等待队列。当第一个任务从外部进入系统时，将会立即启动并允许运行任意长的时间。它不会因为运行时间太长而中断。当其他作业进入时，它们排到就绪队列尾部。当正在运行的进程阻塞，处于等待队列的第一个进程就开始运行。当一个阻塞的进程重新处于就绪态时，它会像一个新到达的任务，会排在队列的末尾，即排在所有进程最后</li>
</ol>
<h4 id="最短作业优先"><a href="#最短作业优先" class="headerlink" title="最短作业优先"></a>最短作业优先</h4><p><img src="https://pic.leetcode-cn.com/1612667592-hZRUqJ-os8-13.png" alt="image"></p>
<h4 id="最短剩余实现优先"><a href="#最短剩余实现优先" class="headerlink" title="最短剩余实现优先"></a>最短剩余实现优先</h4><p>最短作业优先的抢占式版本被称作为 最短剩余时间优先(Shortest Remaining Time Next) 算法。使用这个算法，调度程序总是选择剩余运行时间最短的那个进程运行。当一个新作业到达时，其整个时间同当前进程的剩余时间做比较。如果新的进程比当前运行进程需要更少的时间，当前进程就被挂起，而运行新的进程。这种方式能够使短期作业获得良好的服务。</p>
<h3 id="交互系统中的调度"><a href="#交互系统中的调度" class="headerlink" title="交互系统中的调度"></a>交互系统中的调度</h3><h4 id="轮询调度"><a href="#轮询调度" class="headerlink" title="轮询调度"></a>轮询调度</h4><p>一种最古老、最简单、最公平并且最广泛使用的算法就是 轮询算法(round-robin)。每个进程都会被分配一个时间段，称为时间片(quantum)，在这个时间片内允许进程运行。如果时间片结束时进程还在运行的话，则抢占一个 CPU 并将其分配给另一个进程。如果进程在时间片结束前阻塞或结束，则 CPU 立即进行切换。轮询算法比较容易实现。调度程序所做的就是维护一个可运行进程的列表，就像下图中的 a，当一个进程用完时间片后就被移到队列的末尾，就像下图的 b。</p>
<p><img src="https://pic.leetcode-cn.com/1612667595-cifojX-os8-14.png" alt="image"></p>
<h4 id="优先级调度"><a href="#优先级调度" class="headerlink" title="优先级调度"></a>优先级调度</h4><p>事实情况是不是所有的进程都是优先级相等的。例如，在一所大学中的等级制度，首先是院长，然后是教授、秘书、后勤人员，最后是学生。这种将外部情况考虑在内就实现了优先级调度(priority scheduling)</p>
<p><img src="https://pic.leetcode-cn.com/1612667598-lpcwQN-os8-15.png" alt="image"></p>
<p>它的基本思想很明确，每个进程都被赋予一个优先级，优先级高的进程优先运行。</p>
<p>但是也不意味着高优先级的进程能够永远一直运行下去，调度程序会在每个时钟中断期间降低当前运行进程的优先级。如果此操作导致其优先级降低到下一个最高进程的优先级以下，则会发生进程切换。或者，可以为每个进程分配允许运行的最大时间间隔。当时间间隔用完后，下一个高优先级的进程会得到运行的机会。</p>
<h4 id="最短进程优先"><a href="#最短进程优先" class="headerlink" title="最短进程优先"></a>最短进程优先</h4><p>对于批处理系统而言，由于最短作业优先常常伴随着最短响应时间，一种方式是根据进程过去的行为进行推测，并执行估计运行时间最短的那一个。假设每个终端上每条命令的预估运行时间为 T0，现在假设测量到其下一次运行时间为 T1，可以用两个值的加权来改进估计时间，即aT0+ (1- 1)T1。通过选择 a 的值，可以决定是尽快忘掉老的运行时间，还是在一段长时间内始终记住它们。当 a = 1/2 时，可以得到下面这个序列</p>
<p><img src="https://pic.leetcode-cn.com/1612667601-NmEskJ-os8-16.png" alt="image"></p>
<p>可以看到，在三轮过后，T0 在新的估计值中所占比重下降至 1/8。</p>
<p>有时把这种通过当前测量值和先前估计值进行加权平均从而得到下一个估计值的技术称作 老化(aging)。这种方法会使用很多预测值基于当前值的情况。</p>
<h4 id="彩票调度"><a href="#彩票调度" class="headerlink" title="彩票调度"></a>彩票调度</h4><p>有一种既可以给出预测结果而又有一种比较简单的实现方式的算法，就是 彩票调度(lottery scheduling)算法。他的基本思想为进程提供各种系统资源的彩票。当做出一个调度决策的时候，就随机抽出一张彩票，拥有彩票的进程将获得资源。比如在 CPU 进行调度时，系统可以每秒持有 50 次抽奖，每个中奖进程会获得额外运行时间的奖励。</p>
<h4 id="公平分享调度"><a href="#公平分享调度" class="headerlink" title="公平分享调度"></a>公平分享调度</h4><p>如果用户 1 启动了 9 个进程，而用户 2 启动了一个进程，使用轮转或相同优先级调度算法，那么用户 1 将得到 90 % 的 CPU 时间，而用户 2 将之得到 10 % 的 CPU 时间。</p>
<p>为了阻止这种情况的出现，一些系统在调度前会把进程的拥有者考虑在内。在这种模型下，每个用户都会分配一些CPU 时间，而调度程序会选择进程并强制执行。因此如果两个用户每个都会有 50% 的 CPU 时间片保证，那么无论一个用户有多少个进程，都将获得相同的 CPU 份额。</p>
<h2 id="影响调度程序的指标"><a href="#影响调度程序的指标" class="headerlink" title="影响调度程序的指标"></a>影响调度程序的指标</h2><div class="table-container">
<table>
<thead>
<tr>
<th>指标</th>
<th>释义</th>
</tr>
</thead>
<tbody>
<tr>
<td>CPU使用率</td>
<td>CPU 正在执行任务（即不处于空闲状态）的时间百分比。</td>
</tr>
<tr>
<td>等待时间</td>
<td>这是进程轮流执行的时间，也就是进程切换的时间</td>
</tr>
<tr>
<td>吞吐量</td>
<td>单位时间内完成进程的数量</td>
</tr>
<tr>
<td>响应时间</td>
<td>这是从提交流程到获得有用输出所经过的时间。</td>
</tr>
<tr>
<td>周转时间</td>
<td>从提交流程到完成流程所经过的时间。</td>
</tr>
</tbody>
</table>
</div>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/29/LINUX%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Albert -W">
      <meta itemprop="description" content="更不更新看心情">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不先进摸鱼研究所">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/29/LINUX%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B-1/" class="post-title-link" itemprop="url">LINUX网络编程-多线程编程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-08-29 22:20:01" itemprop="dateCreated datePublished" datetime="2021-08-29T22:20:01+08:00">2021-08-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/29/LINUX%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-IO%E5%A4%8D%E7%94%A8-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Albert -W">
      <meta itemprop="description" content="更不更新看心情">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不先进摸鱼研究所">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/29/LINUX%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-IO%E5%A4%8D%E7%94%A8-1/" class="post-title-link" itemprop="url">LINUX网络编程-IO复用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-08-29 22:19:50" itemprop="dateCreated datePublished" datetime="2021-08-29T22:19:50+08:00">2021-08-29</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-09-17 20:49:02" itemprop="dateModified" datetime="2021-09-17T20:49:02+08:00">2021-09-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">网络编程</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="select"><a href="#select" class="headerlink" title="select"></a>select</h1><h2 id="函数原型"><a href="#函数原型" class="headerlink" title="函数原型"></a>函数原型</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> nfds, fd_set* readfds, fd_set* writefds, fd_set* exceptfds, struct tiumeval* timeout)</span></span>;</span><br></pre></td></tr></table></figure>
<p>各个参数的意义：<br>参数|意义<br>—-|—-<br>nfds|文件描述符的总数<br>readfds|可读事件对应的文件描述符<br>writefds|可写事件对应的文件描述符<br>exceptfds|异常事件对应的文件描述符<br>timeout|select函数的超时时限</p>
<p>这三个参数是fd_set指针类型。其定义如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;typesizes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __FD_SETSIZE 1024</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FD_SETSIZE __FD_SETSIZE</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">int</span> __fd_mask;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> __NFDBITS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NFDBITS ( 8 * (int)sizeof(__fd_mask) )</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __USE_XOPEN</span></span><br><span class="line">        __fd_mask __fds_bits[__FD_SETSIZE /  __NFDBITS];</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> __FDS_BITS(set) ((set) -&gt; fds_bits);</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        __fd_mask __fds_bits[__FD_SETSIZE / __NFDBITS];</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> __FDS_BITS(set) ((set) -&gt; fds_bts);    </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>;</span></span><br><span class="line">&#125; fd_set;</span><br></pre></td></tr></table></figure>
<p>fd_set结构体仅包含一个整形数组<code>__fds_bits</code>,这个数组的<strong>每个元素</strong> 的<strong>每一位</strong>都标记着一个文件描述符。<br>采用一系列宏来访问<code>fd_set</code>结构体中的位：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="built_in">FD_ZERO</span>(fd_set *fdset);</span><br><span class="line"><span class="built_in">FD_SET</span>(<span class="keyword">int</span> fd, fd_set *fdset);</span><br><span class="line"><span class="built_in">FD_CLR</span>(<span class="keyword">int</span> fd, fd_set *fdset);</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FD_ISSET</span><span class="params">(<span class="keyword">int</span> fd, fd_set *fdset)</span></span>;</span><br></pre></td></tr></table></figure><br>用一个结构体来描述timeval位：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> tv_sec;            <span class="comment">//秒</span></span><br><span class="line">    <span class="keyword">long</span> tv_usec;           <span class="comment">//微秒</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="文件描述符的就绪条件"><a href="#文件描述符的就绪条件" class="headerlink" title="文件描述符的就绪条件"></a>文件描述符的就绪条件</h2><p>socket可读的时候，文件描述符就绪。包括：</p>
<p><img src="https://z3.ax1x.com/2021/09/17/4MlyYF.png" alt="image"></p>
<h2 id="处理带外数据"><a href="#处理带外数据" class="headerlink" title="处理带外数据"></a>处理带外数据</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<h1 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h1><p>poll在指定时间内轮询一定数量的文件描述符，以测试其中是否有就绪者。其原型如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">poll</span><span class="params">(struct pollfd* fds, <span class="keyword">nfds_t</span> nfds)</span></span></span><br></pre></td></tr></table></figure>
<p>pollfd的定义如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> fd;             <span class="comment">//文件描述符</span></span><br><span class="line">    <span class="keyword">short</span> events;       <span class="comment">//注册的事件</span></span><br><span class="line">    <span class="keyword">short</span> revents;      <span class="comment">//实际发生的事件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>events用来告诉poll监听fd上的那些事件，它是一系列事件的安慰或。revents成员由内核修改，以通知fd上实际发生了什么事件。<br>poll事件类型如下：<br><img src="https://z3.ax1x.com/2021/09/17/4M3gq1.png" alt="image"><br><img src="https://z3.ax1x.com/2021/09/17/4MGw3F.png" alt="image"></p>
<p>nfds参数用于指定被监听事件集fds的大小。其类型定义如下：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef unsigned long int nfds_t;</span><br></pre></td></tr></table></figure></p>
<p>timeout参数用于指定poll的超时值。单位是ms。timeout = -1时，poll调用将永远阻塞;timeout = 0时,poll会立刻返回</p>
<h1 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h1><h2 id="内核事件表"><a href="#内核事件表" class="headerlink" title="内核事件表"></a>内核事件表</h2><p>epoll使用一组函数来完成仍无。它会将文件描述符上的事件放到内核里的时间表中。<br>epoll需要额外使用一个文件描述符来标识事件表。用epoll_create来操作。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_create</span><span class="params">(<span class="keyword">int</span> size)</span></span></span><br></pre></td></tr></table></figure></p>
<p>内核事件表可以用以下方法操作：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="keyword">int</span> epfd, <span class="keyword">int</span> op, <span class="keyword">int</span> fd, struct epoll_event *event)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>epoll_event的定义如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> &#123;</span></span><br><span class="line">    <span class="keyword">__uint32_t</span> events;      <span class="comment">//epoll事件</span></span><br><span class="line">    epoll <span class="keyword">_data_t</span> data;     <span class="comment">//用户数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>epoll_data如此定义：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">epoll_data</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">uint32_t</span> u32;</span><br><span class="line">    <span class="keyword">uint64_t</span> u64;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">epoll_data_t</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="epoll-wait函数"><a href="#epoll-wait函数" class="headerlink" title="epoll_wait函数"></a>epoll_wait函数</h2><p>在一段超市事件内等待一组文件描述符上的事件。原型如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="keyword">int</span> epfd, struct epoll_event* events, <span class="keyword">int</span> maxevents, <span class="keyword">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/daaikuaichuan/article/details/88777274">详细介绍</a></p>
<h2 id="LT和ET模式"><a href="#LT和ET模式" class="headerlink" title="LT和ET模式"></a>LT和ET模式</h2><p>epoll对文件描述符的操作由两种模式。包括：</p>
<ul>
<li>LT—电平出发</li>
<li>ET—边沿出发</li>
</ul>
<p>ET模式可以在很大程度上降低同一个epoll被重复出发的次数。</p>
<h1 id="三组IO复用函数的比较"><a href="#三组IO复用函数的比较" class="headerlink" title="三组IO复用函数的比较"></a>三组IO复用函数的比较</h1><p><img src="https://z3.ax1x.com/2021/09/17/4MrcVS.png" alt="image"></p>
<h1 id="高级应用"><a href="#高级应用" class="headerlink" title="高级应用"></a>高级应用</h1><h2 id="非阻塞的connect"><a href="#非阻塞的connect" class="headerlink" title="非阻塞的connect"></a>非阻塞的connect</h2><h2 id="聊天室程序"><a href="#聊天室程序" class="headerlink" title="聊天室程序"></a>聊天室程序</h2><h2 id="同时处理tcp和udp服务"><a href="#同时处理tcp和udp服务" class="headerlink" title="同时处理tcp和udp服务"></a>同时处理tcp和udp服务</h2><h1 id="xinetd"><a href="#xinetd" class="headerlink" title="xinetd"></a>xinetd</h1>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/29/LINUX%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-libevent-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Albert -W">
      <meta itemprop="description" content="更不更新看心情">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不先进摸鱼研究所">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/29/LINUX%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-libevent-1/" class="post-title-link" itemprop="url">LINUX网络编程-libevent</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-08-29 22:19:22" itemprop="dateCreated datePublished" datetime="2021-08-29T22:19:22+08:00">2021-08-29</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-09-17 22:20:42" itemprop="dateModified" datetime="2021-09-17T22:20:42+08:00">2021-09-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">网络编程</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="I-O框架库概述"><a href="#I-O框架库概述" class="headerlink" title="I-O框架库概述"></a>I-O框架库概述</h1><p><img src="https://z3.ax1x.com/2021/09/17/4MoJNn.png" alt="image"></p>
<p><img src="https://z3.ax1x.com/2021/09/17/4Mo641.png" alt="image"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/27/LINUX%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Albert -W">
      <meta itemprop="description" content="更不更新看心情">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不先进摸鱼研究所">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/27/LINUX%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" class="post-title-link" itemprop="url">LINUX网络编程-多线程编程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-08-27 22:54:48" itemprop="dateCreated datePublished" datetime="2021-08-27T22:54:48+08:00">2021-08-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-08-29 22:18:19" itemprop="dateModified" datetime="2021-08-29T22:18:19+08:00">2021-08-29</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">网络编程</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/27/LINUX%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E4%BF%A1%E5%8F%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Albert -W">
      <meta itemprop="description" content="更不更新看心情">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不先进摸鱼研究所">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/27/LINUX%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E4%BF%A1%E5%8F%B7/" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-08-27 20:48:17" itemprop="dateCreated datePublished" datetime="2021-08-27T20:48:17+08:00">2021-08-27</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Albert -W</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
