<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","version":"8.5.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta name="description" content="Socket网络编程TCP客户&#x2F;服务器模型回射客户&#x2F;服务器模型echosrv.cpp 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283">
<meta property="og:type" content="article">
<meta property="og:title" content="网络编程的所有源码">
<meta property="og:url" content="http://example.com/2021/08/29/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E7%9A%84%E6%89%80%E6%9C%89%E6%BA%90%E7%A0%81/index.html">
<meta property="og:site_name" content="不先进摸鱼研究所">
<meta property="og:description" content="Socket网络编程TCP客户&#x2F;服务器模型回射客户&#x2F;服务器模型echosrv.cpp 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-08-29T15:08:12.000Z">
<meta property="article:modified_time" content="2021-08-29T15:08:57.911Z">
<meta property="article:author" content="Albert -W">
<meta property="article:tag" content="网络编程">
<meta property="article:tag" content="源码">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2021/08/29/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E7%9A%84%E6%89%80%E6%9C%89%E6%BA%90%E7%A0%81/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2021/08/29/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E7%9A%84%E6%89%80%E6%9C%89%E6%BA%90%E7%A0%81/","path":"2021/08/29/网络编程的所有源码/","title":"网络编程的所有源码"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>网络编程的所有源码 | 不先进摸鱼研究所</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">不先进摸鱼研究所</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">在hexo上的分站</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a></li>
        <li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Socket%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">Socket网络编程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#TCP%E5%AE%A2%E6%88%B7-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.1.</span> <span class="nav-text">TCP客户&#x2F;服务器模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9E%E5%B0%84%E5%AE%A2%E6%88%B7-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.1.1.</span> <span class="nav-text">回射客户&#x2F;服务器模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%82%B9%E5%AF%B9%E7%82%B9%E8%81%8A%E5%A4%A9%E7%A8%8B%E5%BA%8F%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.1.2.</span> <span class="nav-text">点对点聊天程序实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%B9%E8%BF%9B%E5%9B%9E%E5%B0%84%E5%AE%A2%E6%88%B7-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.1.3.</span> <span class="nav-text">改进回射客户&#x2F;服务器模型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%9C%AC%E6%9C%BAip%E5%9C%B0%E5%9D%80"><span class="nav-number">1.2.</span> <span class="nav-text">获取本机ip地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E4%B8%AA%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6-I-O-%E7%9A%84%E7%AE%A1%E7%90%86"><span class="nav-number">1.3.</span> <span class="nav-text">多个文件描述符(I&#x2F;O)的管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#select%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%8D%95%E8%BF%9B%E7%A8%8B%E4%B8%8B%E5%A4%9A%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B9%B6%E5%8F%91"><span class="nav-number">1.3.1.</span> <span class="nav-text">select函数实现单进程下多个客户端并发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#poll%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%8D%95%E8%BF%9B%E7%A8%8B%E4%B8%8B%E5%A4%9A%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B9%B6%E5%8F%91"><span class="nav-number">1.3.2.</span> <span class="nav-text">poll函数实现单进程下多个客户端并发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#epoll%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%8D%95%E8%BF%9B%E7%A8%8B%E4%B8%8B%E5%A4%9A%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B9%B6%E5%8F%91"><span class="nav-number">1.3.3.</span> <span class="nav-text">epoll函数实现单进程下多个客户端并发</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UDP%E5%AE%A2%E6%88%B7-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.4.</span> <span class="nav-text">UDP客户&#x2F;服务器模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UDP%E8%81%8A%E5%A4%A9%E5%AE%A4%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.4.1.</span> <span class="nav-text">UDP聊天室实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="nav-number">1.5.</span> <span class="nav-text">多线程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8B%E7%9A%84%E5%9B%9E%E5%B0%84%E5%AE%A2%E6%88%B7-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.5.1.</span> <span class="nav-text">多线程下的回射客户&#x2F;服务器模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E9%87%8F-%E4%BA%92%E6%96%A5%E9%94%81%E5%AE%9E%E7%8E%B0%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.5.2.</span> <span class="nav-text">信号量+互斥锁实现生产者-消费者模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F-%E4%BA%92%E6%96%A5%E9%94%81%E5%AE%9E%E7%8E%B0%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B"><span class="nav-number">1.5.3.</span> <span class="nav-text">条件变量+互斥锁实现生产者-消费者模型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.6.</span> <span class="nav-text">简单的线程池实现</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Albert -W"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Albert -W</p>
  <div class="site-description" itemprop="description">更不更新看心情</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">61</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="mailto:jackwjiong@126.com" title="E-Mail → mailto:jackwjiong@126.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



          </div>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/29/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E7%9A%84%E6%89%80%E6%9C%89%E6%BA%90%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Albert -W">
      <meta itemprop="description" content="更不更新看心情">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不先进摸鱼研究所">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          网络编程的所有源码
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-08-29 23:08:12 / Modified: 23:08:57" itemprop="dateCreated datePublished" datetime="2021-08-29T23:08:12+08:00">2021-08-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">网络编程</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Socket网络编程"><a href="#Socket网络编程" class="headerlink" title="Socket网络编程"></a>Socket网络编程</h1><h2 id="TCP客户-服务器模型"><a href="#TCP客户-服务器模型" class="headerlink" title="TCP客户/服务器模型"></a>TCP客户/服务器模型</h2><h3 id="回射客户-服务器模型"><a href="#回射客户-服务器模型" class="headerlink" title="回射客户/服务器模型"></a>回射客户/服务器模型</h3><p><strong>echosrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_service</span><span class="params">(<span class="keyword">int</span> conn)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//接收</span></span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">read</span>(conn, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">write</span>(conn, recvbuf, ret);</span><br><span class="line">	&#125; 	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">pid_t</span> pid; </span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ip=%s port=%d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">		</span><br><span class="line">		pid = fork();</span><br><span class="line">		<span class="keyword">if</span>(pid == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//子进程不需要处理监听 </span></span><br><span class="line">			<span class="built_in">close</span>(listenfd);</span><br><span class="line">			<span class="built_in">do_service</span>(conn);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="comment">//父进程不需要处理连接 </span></span><br><span class="line">			<span class="built_in">close</span>(conn);</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>echocli.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">connect</span>(sock, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">fgets</span>(sendbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf), stdin) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">write</span>(sock, sendbuf, <span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">		<span class="built_in">read</span>(sock, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf)); </span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="点对点聊天程序实现"><a href="#点对点聊天程序实现" class="headerlink" title="点对点聊天程序实现"></a>点对点聊天程序实现</h3><p><strong>p2pcrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;recv a sig = %d\n&quot;</span>, sig);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>((conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;ip = %s  port = %d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	pid = fork();</span><br><span class="line">	<span class="keyword">if</span>(pid == <span class="number">-1</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//子进程用于发送数据</span></span><br><span class="line">		<span class="built_in">signal</span>(SIGUSR1, handler); </span><br><span class="line">		<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">		<span class="keyword">while</span>(<span class="built_in">fgets</span>(sendbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf), stdin) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">write</span>(conn, sendbuf, <span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">			<span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf));</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;child close\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//父进程用于接收数据 </span></span><br><span class="line">		<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">		<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">			<span class="keyword">int</span> ret = <span class="built_in">read</span>(conn, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">			<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">				<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;peer close\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		&#125; 	</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;parent close\n&quot;</span>);</span><br><span class="line">		<span class="built_in">kill</span>(pid, SIGUSR1);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_SUCCESS);		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">close</span>(conn);</span><br><span class="line">	<span class="built_in">close</span>(listenfd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>p2pcli.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;recv a sig = %d\n&quot;</span>, sig);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">connect</span>(sock, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	pid = fork();</span><br><span class="line">	<span class="keyword">if</span>(pid == <span class="number">-1</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">//子进程用于接收数据 </span></span><br><span class="line">		<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">		<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">			<span class="keyword">int</span> ret = <span class="built_in">read</span>(sock, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">			<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">				<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;peer close\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;	</span><br><span class="line">			<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;child close\n&quot;</span>);</span><br><span class="line">		<span class="built_in">close</span>(sock);	</span><br><span class="line">		<span class="built_in">kill</span>(<span class="built_in">getppid</span>(), SIGUSR1);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//父进程用于发送数据 </span></span><br><span class="line">		<span class="built_in">signal</span>(SIGUSR1, handler);</span><br><span class="line">		<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;; </span><br><span class="line">		<span class="keyword">while</span>(<span class="built_in">fgets</span>(sendbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf), stdin) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">write</span>(sock, sendbuf, <span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">			<span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf)); </span><br><span class="line">		&#125; 	</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;parent close\n&quot;</span>);</span><br><span class="line">		<span class="built_in">close</span>(sock);</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="改进回射客户-服务器模型"><a href="#改进回射客户-服务器模型" class="headerlink" title="改进回射客户/服务器模型"></a>改进回射客户/服务器模型</h3><p><strong>封装定长接收readn函数、定长发送writen函数、自定义协议解决TCP的粘包问题</strong></p>
<p><strong>echosrv1.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> len;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_service</span><span class="params">(<span class="keyword">int</span> conn)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//接收</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet</span> <span class="title">recvbuf</span>;</span></span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">readn</span>(conn, &amp;recvbuf.len, <span class="number">4</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret &lt; <span class="number">4</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		n = <span class="built_in">ntohl</span>(recvbuf.len);</span><br><span class="line">		ret = <span class="built_in">readn</span>(conn, recvbuf.buf, n);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret &lt; n) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf.buf, stdout);</span><br><span class="line">		<span class="built_in">writen</span>(conn, &amp;recvbuf, <span class="number">4</span> + n);</span><br><span class="line">	&#125; 	</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">pid_t</span> pid; </span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ip=%s port=%d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">		</span><br><span class="line">		pid = fork();</span><br><span class="line">		<span class="keyword">if</span>(pid == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//子进程不需要处理监听 </span></span><br><span class="line">			<span class="built_in">close</span>(listenfd);</span><br><span class="line">			<span class="built_in">do_service</span>(conn);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="comment">//父进程不需要处理连接 </span></span><br><span class="line">			<span class="built_in">close</span>(conn);</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>echocli1.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> len;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">connect</span>(sock, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet</span> <span class="title">sendbuf</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet</span> <span class="title">recvbuf</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf));</span><br><span class="line">	<span class="built_in">memset</span>(&amp;recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">fgets</span>(sendbuf.buf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf.buf), stdin) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		n = <span class="built_in">strlen</span>(sendbuf.buf);</span><br><span class="line">		sendbuf.len = <span class="built_in">htonl</span>(n);</span><br><span class="line">		<span class="built_in">writen</span>(sock, &amp;sendbuf, <span class="number">4</span> + n);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">readn</span>(sock, &amp;recvbuf.len, <span class="number">4</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret &lt; <span class="number">4</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		n = <span class="built_in">ntohl</span>(recvbuf.len);</span><br><span class="line">		ret = <span class="built_in">readn</span>(sock, recvbuf.buf, n);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret &lt; n) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf.buf, stdout);</span><br><span class="line">		<span class="built_in">memset</span>(&amp;sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf));</span><br><span class="line">		<span class="built_in">memset</span>(&amp;recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>利用readline函数解决TCP粘包问题</strong></p>
<p><strong>echosrv2.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recv_peek</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span> </span>&#123;<span class="comment">//接收数据后不将数据从缓冲区移除 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">recv</span>(sockfd, buf, len, MSG_PEEK);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readline</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span> </span>&#123;<span class="comment">//只能用于套接口 </span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">	<span class="keyword">int</span> nleft = maxline;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		ret = <span class="built_in">recv_peek</span>(sockfd, bufp, nleft);</span><br><span class="line">		<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)<span class="comment">//不用再进行中断判断，因为recv_peek函数内部已经进行了 </span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>)<span class="comment">//对方关闭</span></span><br><span class="line">			<span class="keyword">return</span> ret; </span><br><span class="line">		nread = ret;</span><br><span class="line">		<span class="keyword">int</span> i;<span class="comment">//判断已接收到的缓冲区中是否有\n </span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(bufp[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">				ret = <span class="built_in">readn</span>(sockfd, bufp, i + <span class="number">1</span>);<span class="comment">//将数据从缓冲区移除 </span></span><br><span class="line">				<span class="keyword">if</span>(ret != i + <span class="number">1</span>) </span><br><span class="line">					<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(nread &gt; nleft)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		</span><br><span class="line">		nleft -= nread;</span><br><span class="line">		ret = <span class="built_in">readn</span>(sockfd, bufp, nread);<span class="comment">//还没遇到\n的数据也从缓冲区移除</span></span><br><span class="line">		<span class="keyword">if</span>(ret != nread) </span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			</span><br><span class="line">		bufp += nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_srv</span><span class="params">(<span class="keyword">int</span> conn)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//接收</span></span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">readline</span>(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">writen</span>(conn, recvbuf, <span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">	&#125; 	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">pid_t</span> pid; </span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ip=%s port=%d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">		</span><br><span class="line">		pid = fork();</span><br><span class="line">		<span class="keyword">if</span>(pid == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">//子进程不需要处理监听 </span></span><br><span class="line">			<span class="built_in">close</span>(listenfd);</span><br><span class="line">			<span class="built_in">echo_srv</span>(conn);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="comment">//父进程不需要处理连接 </span></span><br><span class="line">			<span class="built_in">close</span>(conn);</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>echocli2.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recv_peek</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span> </span>&#123;<span class="comment">//接收数据后不将数据从缓冲区移除 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">recv</span>(sockfd, buf, len, MSG_PEEK);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readline</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span> </span>&#123;<span class="comment">//只能用于套接口 </span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">	<span class="keyword">int</span> nleft = maxline;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		ret = <span class="built_in">recv_peek</span>(sockfd, bufp, nleft);</span><br><span class="line">		<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)<span class="comment">//不用再进行中断判断，因为recv_peek函数内部已经进行了 </span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>)<span class="comment">//对方关闭</span></span><br><span class="line">			<span class="keyword">return</span> ret; </span><br><span class="line">		nread = ret;</span><br><span class="line">		<span class="keyword">int</span> i;<span class="comment">//判断已接收到的缓冲区中是否有\n </span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(bufp[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">				ret = <span class="built_in">readn</span>(sockfd, bufp, i + <span class="number">1</span>);<span class="comment">//将数据从缓冲区移除 </span></span><br><span class="line">				<span class="keyword">if</span>(ret != i + <span class="number">1</span>) </span><br><span class="line">					<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(nread &gt; nleft)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		</span><br><span class="line">		nleft -= nread;</span><br><span class="line">		ret = <span class="built_in">readn</span>(sockfd, bufp, nread);<span class="comment">//还没遇到\n的数据也从缓冲区移除</span></span><br><span class="line">		<span class="keyword">if</span>(ret != nread) </span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			</span><br><span class="line">		bufp += nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_cli</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">fgets</span>(sendbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf), stdin) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">writen</span>(sock, sendbuf, <span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">readline</span>(sock, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf));</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>); </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">connect</span>(sock, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">localaddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> addrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(localaddr);</span><br><span class="line">	<span class="keyword">if</span>((<span class="built_in">getsockname</span>(sock, (struct sockaddr*)&amp;localaddr, &amp;addrlen)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;getsockname&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;ip = %s  port = %d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(localaddr.sin_addr), <span class="built_in">ntohs</span>(localaddr.sin_port));</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">echo_cli</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h2 id="获取本机ip地址"><a href="#获取本机ip地址" class="headerlink" title="获取本机ip地址"></a>获取本机ip地址</h2><p><strong>gethost.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">struct hostent &#123;</span></span><br><span class="line"><span class="comment">	char  *h_name;</span></span><br><span class="line"><span class="comment">	char **h_aliases;</span></span><br><span class="line"><span class="comment">	int    h_addrtype;</span></span><br><span class="line"><span class="comment">	int    h_length;</span></span><br><span class="line"><span class="comment">	char **h_addr_list;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getlocalip</span><span class="params">(<span class="keyword">char</span> *ip)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> host[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="comment">//获取本机主机名 </span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">gethostname</span>(host, <span class="built_in"><span class="keyword">sizeof</span></span>(host)) &lt; <span class="number">0</span>) </span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">hp</span>;</span></span><br><span class="line">	<span class="keyword">if</span>((hp = <span class="built_in">gethostbyname</span>(host)) == <span class="literal">NULL</span>) </span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="built_in">strcpy</span>(ip, <span class="built_in">inet_ntoa</span>(*(struct in_addr*)hp-&gt;h_addr));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> host[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="comment">//获取本机主机名 </span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">gethostname</span>(host, <span class="built_in"><span class="keyword">sizeof</span></span>(host)) &lt; <span class="number">0</span>) </span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;gethostname&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//获取主机中所有ip</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">hp</span>;</span></span><br><span class="line">	<span class="keyword">if</span>((hp = <span class="built_in">gethostbyname</span>(host)) == <span class="literal">NULL</span>) </span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;gethostbyname&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(hp-&gt;h_addr_list[i] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, <span class="built_in">inet_ntoa</span>(*(struct in_addr*)hp-&gt;h_addr_list[i]));</span><br><span class="line">		++i;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">char</span> ip[<span class="number">100</span>];</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">getlocalip</span>(ip) &lt; <span class="number">0</span>) </span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;getlocalip&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;localip = %s\n&quot;</span>, ip);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="多个文件描述符-I-O-的管理"><a href="#多个文件描述符-I-O-的管理" class="headerlink" title="多个文件描述符(I/O)的管理"></a>多个文件描述符(I/O)的管理</h2><h3 id="select函数实现单进程下多个客户端并发"><a href="#select函数实现单进程下多个客户端并发" class="headerlink" title="select函数实现单进程下多个客户端并发"></a>select函数实现单进程下多个客户端并发</h3><p><strong>echosrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recv_peek</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span> </span>&#123;<span class="comment">//接收数据后不将数据从缓冲区移除 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">recv</span>(sockfd, buf, len, MSG_PEEK);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readline</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span> </span>&#123;<span class="comment">//只能用于套接口 </span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">	<span class="keyword">int</span> nleft = maxline;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		ret = <span class="built_in">recv_peek</span>(sockfd, bufp, nleft);</span><br><span class="line">		<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)<span class="comment">//不用再进行中断判断，因为recv_peek函数内部已经进行了 </span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>)<span class="comment">//对方关闭</span></span><br><span class="line">			<span class="keyword">return</span> ret; </span><br><span class="line">		nread = ret;</span><br><span class="line">		<span class="keyword">int</span> i;<span class="comment">//判断已接收到的缓冲区中是否有\n </span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(bufp[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">				ret = <span class="built_in">readn</span>(sockfd, bufp, i + <span class="number">1</span>);<span class="comment">//将数据从缓冲区移除 </span></span><br><span class="line">				<span class="keyword">if</span>(ret != i + <span class="number">1</span>) </span><br><span class="line">					<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(nread &gt; nleft)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		</span><br><span class="line">		nleft -= nread;</span><br><span class="line">		ret = <span class="built_in">readn</span>(sockfd, bufp, nread);<span class="comment">//还没遇到\n的数据也从缓冲区移除</span></span><br><span class="line">		<span class="keyword">if</span>(ret != nread) </span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			</span><br><span class="line">		bufp += nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_srv</span><span class="params">(<span class="keyword">int</span> conn)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//接收</span></span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">readline</span>(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">writen</span>(conn, recvbuf, <span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">	&#125; 	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_sigchld</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//捕获子进程的初始状态</span></span><br><span class="line">	<span class="comment">//wait(NULL); </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">waitpid</span>(<span class="number">-1</span>, <span class="literal">NULL</span>, WNOHANG) &gt; <span class="number">0</span>);<span class="comment">//可以等待所有子进程，大于0表示等待到了一个子进程 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//signal(SIGCHLD, SIG_IGN);</span></span><br><span class="line">	<span class="built_in">signal</span>(SIGCHLD, handle_sigchld);</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen;</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> i; </span><br><span class="line">	<span class="keyword">int</span> client[FD_SETSIZE];<span class="comment">//保存多个客户端连接信息</span></span><br><span class="line">	<span class="keyword">int</span> maxi = <span class="number">0</span>;<span class="comment">//最大的不空闲的位置 </span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; FD_SETSIZE; ++i)</span><br><span class="line">		client[i] = <span class="number">-1</span>;<span class="comment">//-1表示空闲的 </span></span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">int</span> nready;<span class="comment">//检测到的事件个数 </span></span><br><span class="line">	<span class="keyword">int</span> maxfd = listenfd; </span><br><span class="line">	fd_set rset;</span><br><span class="line">	fd_set allset;</span><br><span class="line">	<span class="built_in">FD_ZERO</span>(&amp;rset);</span><br><span class="line">	<span class="built_in">FD_ZERO</span>(&amp;allset);</span><br><span class="line">	<span class="built_in">FD_SET</span>(listenfd, &amp;allset);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		rset = allset;</span><br><span class="line">		nready = <span class="built_in">select</span>(maxfd + <span class="number">1</span>, &amp;rset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">-1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;select&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">0</span>)<span class="comment">//超时，现在timeout设置为NULL，故不可能发生</span></span><br><span class="line">			<span class="keyword">continue</span>; </span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(listenfd, &amp;rset)) &#123;</span><br><span class="line">			peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);<span class="comment">//必须设置一个初始值 </span></span><br><span class="line">			conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen);</span><br><span class="line">			<span class="keyword">if</span>(conn == <span class="number">-1</span>)</span><br><span class="line">				<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line">			<span class="comment">//保存到某个空闲位置 </span></span><br><span class="line">			<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; FD_SETSIZE; ++i) &#123;</span><br><span class="line">				<span class="keyword">if</span>(client[i] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">					client[i] = conn;</span><br><span class="line">					<span class="keyword">if</span>(i &gt; maxi)</span><br><span class="line">						maxi = i;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;		</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="keyword">if</span>(i == FD_SETSIZE) &#123;</span><br><span class="line">				<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;too mang clients\n&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ip=%s port=%d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">			</span><br><span class="line">			<span class="built_in">FD_SET</span>(conn, &amp;allset);</span><br><span class="line">			<span class="keyword">if</span>(conn &gt; maxfd)</span><br><span class="line">				maxfd = conn;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(--nready &lt;= <span class="number">0</span>)<span class="comment">//检测到的事件已经处理完了，应继续监听，没必要处理下面的代码 </span></span><br><span class="line">				<span class="keyword">continue</span>;	</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//已连接套接口产生了数据</span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt;= maxi; ++i) &#123;</span><br><span class="line">			conn = client[i];</span><br><span class="line">			<span class="keyword">if</span>(conn == <span class="number">-1</span>)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(conn, &amp;rset)) &#123;</span><br><span class="line">				<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">				<span class="keyword">int</span> ret = <span class="built_in">readline</span>(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">				<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">					<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">				<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">					<span class="built_in">FD_CLR</span>(conn, &amp;allset);</span><br><span class="line">					client[i] = <span class="number">-1</span>;</span><br><span class="line">                    <span class="built_in">close</span>(conn);</span><br><span class="line">				&#125; </span><br><span class="line">				</span><br><span class="line">				<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">				<span class="built_in">writen</span>(conn, recvbuf, <span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">if</span>(--nready &lt;= <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;	</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>echocli.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recv_peek</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span> </span>&#123;<span class="comment">//接收数据后不将数据从缓冲区移除 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">recv</span>(sockfd, buf, len, MSG_PEEK);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readline</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span> </span>&#123;<span class="comment">//只能用于套接口 </span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">	<span class="keyword">int</span> nleft = maxline;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		ret = <span class="built_in">recv_peek</span>(sockfd, bufp, nleft);</span><br><span class="line">		<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)<span class="comment">//不用再进行中断判断，因为recv_peek函数内部已经进行了 </span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>)<span class="comment">//对方关闭</span></span><br><span class="line">			<span class="keyword">return</span> ret; </span><br><span class="line">		nread = ret;</span><br><span class="line">		<span class="keyword">int</span> i;<span class="comment">//判断已接收到的缓冲区中是否有\n </span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(bufp[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">				ret = <span class="built_in">readn</span>(sockfd, bufp, i + <span class="number">1</span>);<span class="comment">//将数据从缓冲区移除 </span></span><br><span class="line">				<span class="keyword">if</span>(ret != i + <span class="number">1</span>) </span><br><span class="line">					<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(nread &gt; nleft)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		</span><br><span class="line">		nleft -= nread;</span><br><span class="line">		ret = <span class="built_in">readn</span>(sockfd, bufp, nread);<span class="comment">//还没遇到\n的数据也从缓冲区移除</span></span><br><span class="line">		<span class="keyword">if</span>(ret != nread) </span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			</span><br><span class="line">		bufp += nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_cli</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">	fd_set rset;</span><br><span class="line">	<span class="built_in">FD_ZERO</span>(&amp;rset);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//循环检测是否产生了可读事件</span></span><br><span class="line">	<span class="keyword">int</span> nready;</span><br><span class="line">	<span class="keyword">int</span> maxfd;</span><br><span class="line">	<span class="keyword">int</span> fd_stdin = <span class="built_in">fileno</span>(stdin);<span class="comment">//标准输入的文件描述符 </span></span><br><span class="line">	<span class="keyword">if</span>(fd_stdin &gt; sock)</span><br><span class="line">		maxfd = fd_stdin;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		maxfd = sock;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> stdineof = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(stdineof == <span class="number">0</span>) </span><br><span class="line">            <span class="built_in">FD_SET</span>(fd_stdin, &amp;rset);</span><br><span class="line">		<span class="built_in">FD_SET</span>(sock, &amp;rset);</span><br><span class="line">		nready = <span class="built_in">select</span>(maxfd + <span class="number">1</span>, &amp;rset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;select&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(sock, &amp;rset)) &#123;</span><br><span class="line">			<span class="keyword">int</span> ret = <span class="built_in">readline</span>(sock, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">			<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">				<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;server close\n&quot;</span>);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125; </span><br><span class="line">			</span><br><span class="line">			<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">			<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));	</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(fd_stdin, &amp;rset)) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">fgets</span>(sendbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf), stdin) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                stdineof = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="built_in">writen</span>(sock, sendbuf, <span class="built_in">strlen</span>(sendbuf));	</span><br><span class="line">			<span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">connect</span>(sock, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">localaddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> addrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(localaddr);</span><br><span class="line">	<span class="keyword">if</span>((<span class="built_in">getsockname</span>(sock, (struct sockaddr*)&amp;localaddr, &amp;addrlen)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;getsockname&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;ip = %s  port = %d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(localaddr.sin_addr), <span class="built_in">ntohs</span>(localaddr.sin_port));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">echo_cli</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="poll函数实现单进程下多个客户端并发"><a href="#poll函数实现单进程下多个客户端并发" class="headerlink" title="poll函数实现单进程下多个客户端并发"></a>poll函数实现单进程下多个客户端并发</h3><p><strong>pollsrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recv_peek</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span> </span>&#123;<span class="comment">//接收数据后不将数据从缓冲区移除 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">recv</span>(sockfd, buf, len, MSG_PEEK);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readline</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span> </span>&#123;<span class="comment">//只能用于套接口 </span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">	<span class="keyword">int</span> nleft = maxline;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		ret = <span class="built_in">recv_peek</span>(sockfd, bufp, nleft);</span><br><span class="line">		<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)<span class="comment">//不用再进行中断判断，因为recv_peek函数内部已经进行了 </span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>)<span class="comment">//对方关闭</span></span><br><span class="line">			<span class="keyword">return</span> ret; </span><br><span class="line">		nread = ret;</span><br><span class="line">		<span class="keyword">int</span> i;<span class="comment">//判断已接收到的缓冲区中是否有\n </span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(bufp[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">				ret = <span class="built_in">readn</span>(sockfd, bufp, i + <span class="number">1</span>);<span class="comment">//将数据从缓冲区移除 </span></span><br><span class="line">				<span class="keyword">if</span>(ret != i + <span class="number">1</span>) </span><br><span class="line">					<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(nread &gt; nleft)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		</span><br><span class="line">		nleft -= nread;</span><br><span class="line">		ret = <span class="built_in">readn</span>(sockfd, bufp, nread);<span class="comment">//还没遇到\n的数据也从缓冲区移除</span></span><br><span class="line">		<span class="keyword">if</span>(ret != nread) </span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			</span><br><span class="line">		bufp += nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_srv</span><span class="params">(<span class="keyword">int</span> conn)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//接收</span></span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">readline</span>(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">writen</span>(conn, recvbuf, <span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">	&#125; 	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_sigchld</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//捕获子进程的初始状态</span></span><br><span class="line">	<span class="comment">//wait(NULL); </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">waitpid</span>(<span class="number">-1</span>, <span class="literal">NULL</span>, WNOHANG) &gt; <span class="number">0</span>);<span class="comment">//可以等待所有子进程，大于0表示等待到了一个子进程 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_sigpipe</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;recv a sig = %d\n&quot;</span>, sig);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//signal(SIGPIPE, SIG_IGN);</span></span><br><span class="line">	<span class="built_in">signal</span>(SIGPIPE, handle_sigpipe);</span><br><span class="line">	<span class="comment">//signal(SIGCHLD, SIG_IGN);</span></span><br><span class="line">	<span class="built_in">signal</span>(SIGCHLD, handle_sigchld);</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen;</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	struct pollfd &#123;</span></span><br><span class="line"><span class="comment">		int   fd;//文件描述符</span></span><br><span class="line"><span class="comment">		short events;//请求事件/感兴趣事件 </span></span><br><span class="line"><span class="comment">		short revents;//返回事件 </span></span><br><span class="line"><span class="comment">	&#125;;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> i; </span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">client</span>[2048];</span><span class="comment">//保存多个客户端连接信息</span></span><br><span class="line">	<span class="keyword">int</span> maxi = <span class="number">0</span>;<span class="comment">//最大的不空闲的位置 </span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">2048</span>; ++i)</span><br><span class="line">		client[i].fd = <span class="number">-1</span>;<span class="comment">//-1表示空闲的 </span></span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">int</span> nready;<span class="comment">//检测到的事件个数 </span></span><br><span class="line">	client[<span class="number">0</span>].fd = listenfd;</span><br><span class="line">	client[<span class="number">0</span>].events = POLLIN;<span class="comment">//对可读事件感兴趣 </span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		nready = <span class="built_in">poll</span>(client, maxi + <span class="number">1</span>, <span class="number">-1</span>); </span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">-1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">0</span>)<span class="comment">//超时，现在timeout设置为NULL，故不可能发生</span></span><br><span class="line">			<span class="keyword">continue</span>; </span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(client[<span class="number">0</span>].revents &amp; POLLIN) &#123;</span><br><span class="line">			peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);<span class="comment">//必须设置一个初始值 </span></span><br><span class="line">			conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen);</span><br><span class="line">			<span class="keyword">if</span>(conn == <span class="number">-1</span>)</span><br><span class="line">				<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line">			<span class="comment">//保存到某个空闲位置 </span></span><br><span class="line">			<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">2048</span>; ++i) &#123;</span><br><span class="line">				<span class="keyword">if</span>(client[i].fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">					client[i].fd = conn;</span><br><span class="line">					<span class="keyword">if</span>(i &gt; maxi)</span><br><span class="line">						maxi = i;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;		</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="keyword">if</span>(i == <span class="number">2048</span>) &#123;</span><br><span class="line">				<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;too mang clients\n&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ip=%s port=%d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">			</span><br><span class="line">			client[i].events = POLLIN; </span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(--nready &lt;= <span class="number">0</span>)<span class="comment">//检测到的事件已经处理完了，应继续监听，没必要处理下面的代码 </span></span><br><span class="line">				<span class="keyword">continue</span>;	</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//已连接套接口产生了数据</span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">1</span>; i &lt;= maxi; ++i) &#123;</span><br><span class="line">			conn = client[i].fd;</span><br><span class="line">			<span class="keyword">if</span>(conn == <span class="number">-1</span>)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">if</span>(client[i].events &amp; POLLIN) &#123;</span><br><span class="line">				<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">				<span class="keyword">int</span> ret = <span class="built_in">readline</span>(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">				<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">					<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">				<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">					client[i].fd = <span class="number">-1</span>;</span><br><span class="line">					<span class="built_in">close</span>(conn);</span><br><span class="line">				&#125; </span><br><span class="line">				</span><br><span class="line">				<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">				<span class="built_in">writen</span>(conn, recvbuf, <span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">if</span>(--nready &lt;= <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;	</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="epoll函数实现单进程下多个客户端并发"><a href="#epoll函数实现单进程下多个客户端并发" class="headerlink" title="epoll函数实现单进程下多个客户端并发"></a>epoll函数实现单进程下多个客户端并发</h3><p><strong>epollsrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> std::vector&lt;struct epoll_event&gt; EventList;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">activate_nonblock</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> flags = <span class="built_in">fcntl</span>(fd, F_GETFL);</span><br><span class="line">	<span class="keyword">if</span>(flags == <span class="number">-1</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;fcntl&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	flags |= O_NONBLOCK;</span><br><span class="line">	ret = <span class="built_in">fcntl</span>(fd, F_SETFL, flags);</span><br><span class="line">	<span class="keyword">if</span>(ret == <span class="number">-1</span>) </span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;fcntl&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readn</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;<span class="comment">//ssize_t 有符号整数  size_t 无符号整数 </span></span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nread;<span class="comment">//已接收的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nread = <span class="built_in">read</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nread == <span class="number">0</span>)<span class="comment">//对等方关闭了 </span></span><br><span class="line">			<span class="keyword">return</span> count - nleft;</span><br><span class="line">		bufp += nread; </span><br><span class="line">		nleft -= nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">writen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> nleft = count;<span class="comment">//剩余要发送的字节数 </span></span><br><span class="line">	<span class="keyword">ssize_t</span> nwritten;<span class="comment">//已发送的字节数 </span></span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span>*)buf;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(nleft &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((nwritten = <span class="built_in">write</span>(fd, bufp, nleft)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断 </span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(nwritten == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		bufp += nwritten; </span><br><span class="line">		nleft -= nwritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> count;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">recv_peek</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span> </span>&#123;<span class="comment">//接收数据后不将数据从缓冲区移除 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">recv</span>(sockfd, buf, len, MSG_PEEK);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span> &amp;&amp; errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">readline</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> maxline)</span> </span>&#123;<span class="comment">//只能用于套接口 </span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">int</span> nread;</span><br><span class="line">	<span class="keyword">char</span> *bufp = (<span class="keyword">char</span> *)buf;</span><br><span class="line">	<span class="keyword">int</span> nleft = maxline;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		ret = <span class="built_in">recv_peek</span>(sockfd, bufp, nleft);</span><br><span class="line">		<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)<span class="comment">//不用再进行中断判断，因为recv_peek函数内部已经进行了 </span></span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>)<span class="comment">//对方关闭</span></span><br><span class="line">			<span class="keyword">return</span> ret; </span><br><span class="line">		nread = ret;</span><br><span class="line">		<span class="keyword">int</span> i;<span class="comment">//判断已接收到的缓冲区中是否有\n </span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nread; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(bufp[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">				ret = <span class="built_in">readn</span>(sockfd, bufp, i + <span class="number">1</span>);<span class="comment">//将数据从缓冲区移除 </span></span><br><span class="line">				<span class="keyword">if</span>(ret != i + <span class="number">1</span>) </span><br><span class="line">					<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(nread &gt; nleft)</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		</span><br><span class="line">		nleft -= nread;</span><br><span class="line">		ret = <span class="built_in">readn</span>(sockfd, bufp, nread);<span class="comment">//还没遇到\n的数据也从缓冲区移除</span></span><br><span class="line">		<span class="keyword">if</span>(ret != nread) </span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">			</span><br><span class="line">		bufp += nread;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_srv</span><span class="params">(<span class="keyword">int</span> conn)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//接收</span></span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">readline</span>(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">writen</span>(conn, recvbuf, <span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">	&#125; 	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_sigchld</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//捕获子进程的初始状态</span></span><br><span class="line">	<span class="comment">//wait(NULL); </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">waitpid</span>(<span class="number">-1</span>, <span class="literal">NULL</span>, WNOHANG) &gt; <span class="number">0</span>);<span class="comment">//可以等待所有子进程，大于0表示等待到了一个子进程 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_sigpipe</span><span class="params">(<span class="keyword">int</span> sig)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;recv a sig = %d\n&quot;</span>, sig);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">signal</span>(SIGPIPE, handle_sigpipe);</span><br><span class="line">	<span class="built_in">signal</span>(SIGCHLD, handle_sigchld);</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	std::vector&lt;<span class="keyword">int</span>&gt; clients;</span><br><span class="line">	<span class="keyword">int</span> epollfd;</span><br><span class="line">	<span class="comment">//创建一个epoll实例，EPOLL_CLOEXEC表示当进程被替换时文件描述符会关闭</span></span><br><span class="line">	epollfd = <span class="built_in">epoll_create1</span>(EPOLL_CLOEXEC); </span><br><span class="line">	</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	typedef union epoll_data &#123;</span></span><br><span class="line"><span class="comment">		void         *ptr;</span></span><br><span class="line"><span class="comment">		int          fd;</span></span><br><span class="line"><span class="comment">		__uint32_t   u32;</span></span><br><span class="line"><span class="comment">		__uint64_t   u64;</span></span><br><span class="line"><span class="comment">	&#125; epoll_data_t;//大小为8个字节 </span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	struct epoll_event &#123;</span></span><br><span class="line"><span class="comment">		__uint32_t   events;//Epoll事件 </span></span><br><span class="line"><span class="comment">		epoll_data_t data;//用户数据变量 ，数据类型为共用体 </span></span><br><span class="line"><span class="comment">	&#125;;</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">event</span>;</span></span><br><span class="line">	event.data.fd = listenfd;</span><br><span class="line">	event.events = EPOLLIN | EPOLLET;<span class="comment">//EPOLLET表示边沿方式触发 </span></span><br><span class="line">	<span class="comment">//将感兴趣的文件描述符加入epoll进行管理 </span></span><br><span class="line">	<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, listenfd, &amp;event);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接</span></span><br><span class="line">	<span class="function">EventList <span class="title">events</span><span class="params">(<span class="number">16</span>)</span></span>;	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen;</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	<span class="keyword">int</span> i; </span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">int</span> nready;<span class="comment">//检测到的事件个数 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		nready = <span class="built_in">epoll_wait</span>(epollfd, &amp;*events.<span class="built_in">begin</span>(), <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(events.<span class="built_in">size</span>()), <span class="number">-1</span>);</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">-1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)<span class="comment">//被信号中断</span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;poll_wait&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">0</span>)<span class="comment">//超时，现在timeout设置为NULL，故不可能发生</span></span><br><span class="line">			<span class="keyword">continue</span>; </span><br><span class="line">			</span><br><span class="line">		<span class="keyword">if</span>((<span class="keyword">size_t</span>)nready == events.<span class="built_in">size</span>())</span><br><span class="line">			events.<span class="built_in">resize</span>(events.<span class="built_in">size</span>() * <span class="number">2</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//遍历返回的事件</span></span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nready; ++i) &#123;</span><br><span class="line">			<span class="keyword">if</span>(events[i].data.fd == listenfd) &#123;</span><br><span class="line">				peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);<span class="comment">//必须设置一个初始值 </span></span><br><span class="line">				conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen);</span><br><span class="line">				<span class="keyword">if</span>(conn == <span class="number">-1</span>)</span><br><span class="line">					<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line"></span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;ip=%s port=%d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;count = %d\n&quot;</span>, ++count);</span><br><span class="line">				clients.<span class="built_in">push_back</span>(conn);</span><br><span class="line">				</span><br><span class="line">				<span class="built_in">activate_nonblock</span>(conn);</span><br><span class="line">				</span><br><span class="line">				event.data.fd = conn;</span><br><span class="line">				event.events = EPOLLIN | EPOLLET;</span><br><span class="line">				<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, conn, &amp;event);				</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(events[i].events &amp; EPOLLIN) &#123;</span><br><span class="line">				conn = events[i].data.fd;</span><br><span class="line">				<span class="keyword">if</span>(conn &lt; <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">				<span class="keyword">int</span> ret = <span class="built_in">readline</span>(conn, recvbuf, <span class="number">1024</span>);</span><br><span class="line">				<span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">					<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line">				<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">					<span class="built_in">close</span>(conn);</span><br><span class="line">					event = events[i];</span><br><span class="line">					<span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_DEL, conn, &amp;event);</span><br><span class="line">					clients.<span class="built_in">erase</span>(std::<span class="built_in">remove</span>(clients.<span class="built_in">begin</span>(), clients.<span class="built_in">end</span>(), conn), clients.<span class="built_in">end</span>());</span><br><span class="line">				&#125; </span><br><span class="line">				</span><br><span class="line">				<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">				<span class="built_in">writen</span>(conn, recvbuf, <span class="built_in">strlen</span>(recvbuf));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h2 id="UDP客户-服务器模型"><a href="#UDP客户-服务器模型" class="headerlink" title="UDP客户/服务器模型"></a>UDP客户/服务器模型</h2><p><strong>echosrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_in</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_srv</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen;</span><br><span class="line">	<span class="keyword">int</span> n;<span class="comment">//接收到的字节数 </span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		n = <span class="built_in">recvfrom</span>(sock, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf), <span class="number">0</span>, (struct sockaddr*)&amp;peeraddr, &amp;peerlen);</span><br><span class="line">		<span class="keyword">if</span>(n == <span class="number">-1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;recvfrom&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(n &gt; <span class="number">0</span>) &#123;<span class="comment">//回射回去 </span></span><br><span class="line">			<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">			<span class="built_in">sendto</span>(sock, recvbuf, n, <span class="number">0</span>, (struct sockaddr*)&amp;peeraddr, peerlen);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_DGRAM, <span class="number">0</span>)) &lt; <span class="number">0</span>)<span class="comment">//SOCK_DGRAM代表UDP</span></span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	<span class="comment">//初始化地址</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span>  <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(sock, (struct sockaddr*)&amp; servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">echo_srv</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>echocli.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span><span class="comment">//sockaddr_in</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo_cli</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span>  <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">fgets</span>(sendbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf), stdin) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">sendto</span>(sock, sendbuf, <span class="built_in">strlen</span>(sendbuf), <span class="number">0</span>, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">		<span class="built_in">recvfrom</span>(sock, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf));</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_DGRAM, <span class="number">0</span>)) &lt; <span class="number">0</span>)<span class="comment">//SOCK_DGRAM代表UDP</span></span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">echo_cli</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="UDP聊天室实现"><a href="#UDP聊天室实现" class="headerlink" title="UDP聊天室实现"></a>UDP聊天室实现</h3><p><strong>chatsrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pub.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line">USER_LIST client_list;<span class="comment">//聊天室成员列表 </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_login</span><span class="params">(MESSAGE&amp; msg, <span class="keyword">int</span> sock, struct sockaddr_in *cliaddr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_logout</span><span class="params">(MESSAGE&amp; msg, <span class="keyword">int</span> sock, struct sockaddr_in *cliaddr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_sendlist</span><span class="params">(<span class="keyword">int</span> sock, struct sockaddr_in *cliaddr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chat_srv</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">cliaddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> clilen;</span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">	MESSAGE msg;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(msg));</span><br><span class="line">		clilen = <span class="built_in"><span class="keyword">sizeof</span></span>(cliaddr);</span><br><span class="line">		n = <span class="built_in">recvfrom</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)&amp;cliaddr,&amp;clilen);</span><br><span class="line">		<span class="keyword">if</span>(n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span>(errno == EINTR)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;recvfrom&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> cmd = <span class="built_in">ntohl</span>(msg.cmd);</span><br><span class="line">		<span class="built_in"><span class="keyword">switch</span></span>(cmd) &#123;</span><br><span class="line">		<span class="keyword">case</span> C2S_LOGIN:</span><br><span class="line">			<span class="built_in">do_login</span>(msg, sock, &amp;cliaddr);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> C2S_LOGOUT:</span><br><span class="line">			<span class="built_in">do_logout</span>(msg, sock, &amp;cliaddr);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> C2S_ONLINE_USER:</span><br><span class="line">			<span class="built_in">do_sendlist</span>(sock, &amp;cliaddr);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_login</span><span class="params">(MESSAGE&amp; msg, <span class="keyword">int</span> sock, struct sockaddr_in *cliaddr)</span> </span>&#123;</span><br><span class="line">	USER_INFO user;</span><br><span class="line">	<span class="built_in">strcpy</span>(user.username, msg.body);</span><br><span class="line">	user.ip = cliaddr-&gt;sin_addr.s_addr;</span><br><span class="line">	user.port = cliaddr-&gt;sin_port;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//查找用户</span></span><br><span class="line">	USER_LIST::iterator it;</span><br><span class="line">	<span class="keyword">for</span>(it = client_list.<span class="built_in">begin</span>(); it != client_list.<span class="built_in">end</span>(); ++it) </span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">strcmp</span>(it-&gt;username, msg.body) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(it == client_list.<span class="built_in">end</span>()) &#123;<span class="comment">//没找到用户 </span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;has a user login : %s &lt;-&gt; %s:%d\n&quot;</span>, msg.body, <span class="built_in">inet_ntoa</span>(cliaddr-&gt;sin_addr), cliaddr-&gt;sin_port);</span><br><span class="line">		client_list.<span class="built_in">push_back</span>(user); </span><br><span class="line">		</span><br><span class="line">		<span class="comment">//登录成功应答</span></span><br><span class="line">		MESSAGE reply_msg;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;reply_msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(reply_msg));</span><br><span class="line">		reply_msg.cmd = <span class="built_in">htonl</span>(S2C_LOGIN_OK);</span><br><span class="line">		<span class="built_in">sendto</span>(sock, &amp;reply_msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)cliaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*cliaddr));</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">int</span> count = <span class="built_in">htonl</span>((<span class="keyword">int</span>)client_list.<span class="built_in">size</span>());</span><br><span class="line">		<span class="comment">//发送在线人数</span></span><br><span class="line">		<span class="built_in">sendto</span>(sock, &amp;count, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>), <span class="number">0</span>, (struct sockaddr*)cliaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*cliaddr));</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//发送在线列表 </span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;sending user list informatio to:%s &lt;-&gt; %s:%d\n&quot;</span>,msg.body, <span class="built_in">inet_ntoa</span>(cliaddr-&gt;sin_addr), cliaddr-&gt;sin_port);</span><br><span class="line">	 	<span class="keyword">for</span>(it = client_list.<span class="built_in">begin</span>(); it != client_list.<span class="built_in">end</span>(); ++it) </span><br><span class="line">			<span class="built_in">sendto</span>(sock, &amp;*it, <span class="built_in"><span class="keyword">sizeof</span></span>(USER_INFO), <span class="number">0</span>, (struct sockaddr*)cliaddr,<span class="built_in"><span class="keyword">sizeof</span></span>(*cliaddr));</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//向其他用户通知有新用户登录</span></span><br><span class="line">		<span class="keyword">for</span>(it = client_list.<span class="built_in">begin</span>(); it != client_list.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">strcmp</span>(it-&gt;username, msg.body) == <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">			<span class="built_in">memset</span>(&amp;peeraddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr));</span><br><span class="line">			peeraddr.sin_family = AF_INET;</span><br><span class="line">			peeraddr.sin_port = it-&gt;port;</span><br><span class="line">			peeraddr.sin_addr.s_addr = it-&gt;ip;</span><br><span class="line">			</span><br><span class="line">			msg.cmd = <span class="built_in">htonl</span>(S2C_SOMEONE_LOGIN);</span><br><span class="line">			<span class="built_in">memcpy</span>(msg.body, &amp;user, <span class="built_in"><span class="keyword">sizeof</span></span>(user));</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">sendto</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)&amp;peeraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr)) &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;sendto&quot;</span>);</span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;<span class="comment">//找到用户 </span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;user %s has already logined\n&quot;</span>, msg.body);</span><br><span class="line">		</span><br><span class="line">		MESSAGE reply_msg;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;reply_msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(reply_msg));</span><br><span class="line">		reply_msg.cmd = <span class="built_in">htonl</span>(S2C_ALREADY_LOGINED);</span><br><span class="line">		<span class="built_in">sendto</span>(sock, &amp;reply_msg, <span class="built_in"><span class="keyword">sizeof</span></span>(reply_msg), <span class="number">0</span>, (struct sockaddr*)cliaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*cliaddr));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_logout</span><span class="params">(MESSAGE&amp; msg, <span class="keyword">int</span> sock, struct sockaddr_in *cliaddr)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;has a user logout : %s &lt;-&gt; %s:%d\n&quot;</span>, msg.body, <span class="built_in">inet_ntoa</span>(cliaddr-&gt;sin_addr), <span class="built_in">ntohs</span>(cliaddr-&gt;sin_port));</span><br><span class="line">	</span><br><span class="line">	USER_LIST::iterator it;</span><br><span class="line">	<span class="keyword">for</span>(it = client_list.<span class="built_in">begin</span>(); it != client_list.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">strcmp</span>(it-&gt;username, msg.body) == <span class="number">0</span>) &#123;</span><br><span class="line">			it = client_list.<span class="built_in">erase</span>(it); </span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125; </span><br><span class="line">			</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">		<span class="built_in">memset</span>(&amp;peeraddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr));</span><br><span class="line">		peeraddr.sin_family      = AF_INET;</span><br><span class="line">		peeraddr.sin_port        = it-&gt;port;</span><br><span class="line">		peeraddr.sin_addr.s_addr = it-&gt;ip;</span><br><span class="line">		</span><br><span class="line">		msg.cmd = <span class="built_in">htonl</span>(S2C_SOMEONE_LOGOUT);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">sendto</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)&amp;peeraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr)) &lt; <span class="number">0</span>) </span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;sendto&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_sendlist</span><span class="params">(<span class="keyword">int</span> sock, struct sockaddr_in *cliaddr)</span> </span>&#123;</span><br><span class="line">	MESSAGE msg;</span><br><span class="line">	msg.cmd = <span class="built_in">htonl</span>(S2C_ONLINE_USER);</span><br><span class="line">	<span class="built_in">sendto</span>(sock, (<span class="keyword">const</span> <span class="keyword">char</span>*)&amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)cliaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*cliaddr));</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> count = <span class="built_in">htonl</span>((<span class="keyword">int</span>)client_list.<span class="built_in">size</span>());</span><br><span class="line">	<span class="comment">//发送在线用户数</span></span><br><span class="line">	<span class="built_in">sendto</span>(sock, (<span class="keyword">const</span> <span class="keyword">char</span>*)&amp;count, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>), <span class="number">0</span>, (struct sockaddr*)cliaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*cliaddr));</span><br><span class="line">	<span class="comment">//发送在线用户列表</span></span><br><span class="line">	<span class="keyword">for</span>(USER_LIST::iterator it = client_list.<span class="built_in">begin</span>(); it != client_list.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">		<span class="built_in">sendto</span>(sock,&amp;*it, <span class="built_in"><span class="keyword">sizeof</span></span>(USER_INFO), <span class="number">0</span>, (struct sockaddr*)cliaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*cliaddr));</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_DGRAM, <span class="number">0</span>)) &lt; <span class="number">0</span>)<span class="comment">//SOCK_DGRAM代表UDP</span></span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="class"><span class="keyword">struct</span>  <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(sock, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">chat_srv</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>chatcli.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pub.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> username[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">USER_LIST client_list;<span class="comment">//聊天室成员列表</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_someone_login</span><span class="params">(MESSAGE&amp; msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_someone_logout</span><span class="params">(MESSAGE&amp; msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_getlist</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_chat</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">parse_cmd</span><span class="params">(<span class="keyword">char</span>* cmdline, <span class="keyword">int</span> sock, struct sockaddr_in *servaddr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">sendmsgto</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">char</span>* username, <span class="keyword">char</span>* msg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">parse_cmd</span><span class="params">(<span class="keyword">char</span>* cmdline, <span class="keyword">int</span> sock, struct sockaddr_in *servaddr)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> cmd[<span class="number">10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> *p;</span><br><span class="line">	p = <span class="built_in">strchr</span>(cmdline, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(p != <span class="literal">NULL</span>)</span><br><span class="line">		*p = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">strcpy</span>(cmd, cmdline);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd, <span class="string">&quot;exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">		MESSAGE msg;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(msg));</span><br><span class="line">		msg.cmd = <span class="built_in">htonl</span>(C2S_LOGOUT);</span><br><span class="line">		<span class="built_in">strcpy</span>(msg.body, username);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">sendto</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;sendto&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;user %s has logout server\n&quot;</span>, username);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd, <span class="string">&quot;send&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">char</span> peername[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">		<span class="keyword">char</span> msg[MSG_LEN] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/* send  user  msg */</span></span><br><span class="line">		<span class="comment">/*       p     p2  */</span></span><br><span class="line">		<span class="keyword">while</span>(*p++ == <span class="string">&#x27; &#x27;</span>) ;</span><br><span class="line">		<span class="keyword">char</span> *p2;</span><br><span class="line">		p2 = <span class="built_in">strchr</span>(p, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">		<span class="keyword">if</span>(p2 == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;bad command\n&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;\nCommands are:\n&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;send username msg\n&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;list\n&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		*p2 = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">		<span class="built_in">strcpy</span>(peername, p);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">while</span>(*p2++ == <span class="string">&#x27; &#x27;</span>) ;</span><br><span class="line">		<span class="built_in">strcpy</span>(msg, p2);</span><br><span class="line">		<span class="built_in">sendmsgto</span>(sock, peername, msg);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(cmd, <span class="string">&quot;list&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">		MESSAGE msg;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(msg));</span><br><span class="line">		msg.cmd = <span class="built_in">htonl</span>(C2S_ONLINE_USER);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">sendto</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;sendto&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;bad command\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\nCommands are:\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;send username msg\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;list\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">sendmsgto</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">char</span>* name, <span class="keyword">char</span>* msg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">strcmp</span>(name, username) == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t send message to self\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	USER_LIST::iterator it;</span><br><span class="line">	<span class="keyword">for</span>(it = client_list.<span class="built_in">begin</span>(); it != client_list.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">strcmp</span>(it-&gt;username, name) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(it == client_list.<span class="built_in">end</span>()) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;user %s has not logined server\n&quot;</span>, name);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	MESSAGE m;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;m, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(m));</span><br><span class="line">	m.cmd = <span class="built_in">htonl</span>(C2C_CHAT);</span><br><span class="line">	</span><br><span class="line">	CHAT_MSG cm;</span><br><span class="line">	<span class="built_in">strcpy</span>(cm.username, username);</span><br><span class="line">	<span class="built_in">strcpy</span>(cm.msg, msg);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">memcpy</span>(m.body, &amp;cm, <span class="built_in"><span class="keyword">sizeof</span></span>(cm));</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;peeraddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr));</span><br><span class="line">	peeraddr.sin_family      = AF_INET;</span><br><span class="line">	peeraddr.sin_addr.s_addr = it-&gt;ip;</span><br><span class="line">	peeraddr.sin_port        = it-&gt;port;</span><br><span class="line">	</span><br><span class="line">	in_addr tmp;</span><br><span class="line">	tmp.s_addr = it-&gt;ip;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;sending message [%s] to user [%s] &lt;-&gt; %s:%d\n&quot;</span>, msg, name, <span class="built_in">inet_ntoa</span>(tmp), it-&gt;port);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">sendto</span>(sock, (<span class="keyword">const</span> <span class="keyword">char</span>*)&amp;m, <span class="built_in"><span class="keyword">sizeof</span></span>(m), <span class="number">0</span>, (struct sockaddr*)&amp;peeraddr, <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr));</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_getlist</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> count;</span><br><span class="line">	<span class="built_in">recvfrom</span>(sock, &amp;count, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;has %d users logined server\n&quot;</span>, <span class="built_in">ntohl</span>(count));</span><br><span class="line">	client_list.<span class="built_in">clear</span>();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> n = <span class="built_in">ntohl</span>(count);</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">		USER_INFO user;</span><br><span class="line">		<span class="built_in">recvfrom</span>(sock, &amp;user, <span class="built_in"><span class="keyword">sizeof</span></span>(USER_INFO), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		in_addr tmp;</span><br><span class="line">		tmp.s_addr = user.ip;</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%s &lt;-&gt; %s:%d\n&quot;</span>, user.username, <span class="built_in">inet_ntoa</span>(tmp), <span class="built_in">ntohs</span>(user.port));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_someone_login</span><span class="params">(MESSAGE&amp; msg)</span> </span>&#123;</span><br><span class="line">	USER_INFO *user = (USER_INFO*)msg.body;</span><br><span class="line">	in_addr tmp;</span><br><span class="line">	tmp.s_addr = user-&gt;ip;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s &lt;-&gt; %s:%d has logined server\n&quot;</span>, user-&gt;username, <span class="built_in">inet_ntoa</span>(tmp), user-&gt;port);</span><br><span class="line">	client_list.<span class="built_in">push_back</span>(*user);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_someone_logout</span><span class="params">(MESSAGE&amp; msg)</span> </span>&#123;</span><br><span class="line">	USER_LIST::iterator it;</span><br><span class="line">	<span class="keyword">for</span>(it = client_list.<span class="built_in">begin</span>(); it != client_list.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">strcmp</span>(it-&gt;username, msg.body) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(it != client_list.<span class="built_in">end</span>())</span><br><span class="line">		client_list.<span class="built_in">erase</span>(it);</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;user %s has logout server\n&quot;</span>, msg.body);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_chat</span><span class="params">(<span class="keyword">const</span> MESSAGE&amp; msg)</span> </span>&#123;</span><br><span class="line">	CHAT_MSG *cm = (CHAT_MSG*)msg.body;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;recv a msg [%s] from [%s]\n&quot;</span>, cm-&gt;msg, cm-&gt;username);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">chat_cli</span><span class="params">(<span class="keyword">int</span> sock)</span> </span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span>  <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>);</span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen;</span><br><span class="line">	</span><br><span class="line">	MESSAGE msg;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(username, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(username));</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;please input your name:&quot;</span>);</span><br><span class="line">		<span class="built_in">fflush</span>(stdout);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, username);</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(msg));</span><br><span class="line">		msg.cmd = <span class="built_in">htonl</span>(C2S_LOGIN);</span><br><span class="line">		<span class="built_in">strcpy</span>(msg.body, username);</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">sendto</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(msg));</span><br><span class="line">		<span class="built_in">recvfrom</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">int</span> cmd = <span class="built_in">ntohl</span>(msg.cmd);</span><br><span class="line">		<span class="keyword">if</span>(cmd == S2C_ALREADY_LOGINED) </span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;user %s already logined server, please use another username\n&quot;</span>, username);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(cmd == S2C_LOGIN_OK) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;user %s already server\n&quot;</span>, username);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> count;</span><br><span class="line">	<span class="built_in">recvfrom</span>(sock, &amp;count, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> n = <span class="built_in">ntohl</span>(count);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;has %d user logined server\n&quot;</span>, n);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">		USER_INFO user;</span><br><span class="line">		<span class="built_in">recvfrom</span>(sock, &amp;user, <span class="built_in"><span class="keyword">sizeof</span></span>(USER_INFO), <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		client_list.<span class="built_in">push_back</span>(user);</span><br><span class="line">		in_addr tmp;</span><br><span class="line">		tmp.s_addr = user.ip;</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d %s &lt;-&gt; %s:%d\n&quot;</span>, i, user.username, <span class="built_in">inet_ntoa</span>(tmp), <span class="built_in">ntohs</span>(user.port));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\nCommands are:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;send username msg\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;list\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	fd_set rset;</span><br><span class="line">	<span class="built_in">FD_ZERO</span>(&amp;rset);</span><br><span class="line">	<span class="keyword">int</span> nready;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">FD_SET</span>(STDIN_FILENO, &amp;rset);</span><br><span class="line">		<span class="built_in">FD_SET</span>(sock, &amp;rset);</span><br><span class="line">		nready = <span class="built_in">select</span>(sock + <span class="number">1</span>, &amp;rset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;select&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span>(nready == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(sock, &amp;rset)) &#123;</span><br><span class="line">			peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);</span><br><span class="line">			<span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(msg));</span><br><span class="line">			<span class="built_in">recvfrom</span>(sock, &amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)&amp;peeraddr, &amp;peerlen);</span><br><span class="line">			<span class="keyword">int</span> cmd = <span class="built_in">ntohl</span>(msg.cmd);</span><br><span class="line">			<span class="built_in"><span class="keyword">switch</span></span>(cmd) &#123;</span><br><span class="line">			<span class="keyword">case</span> S2C_SOMEONE_LOGIN:</span><br><span class="line">				<span class="built_in">do_someone_login</span>(msg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> S2C_SOMEONE_LOGOUT:</span><br><span class="line">				<span class="built_in">do_someone_logout</span>(msg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> S2C_ONLINE_USER:</span><br><span class="line">				<span class="built_in">do_getlist</span>(sock);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> C2C_CHAT:</span><br><span class="line">				<span class="built_in">do_chat</span>(msg);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			defalut:</span><br><span class="line">				<span class="keyword">break</span>;	</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">FD_ISSET</span>(STDIN_FILENO, &amp;rset)) &#123;</span><br><span class="line">			<span class="keyword">char</span> cmdline[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">fgets</span>(cmdline, <span class="built_in"><span class="keyword">sizeof</span></span>(cmdline), stdin) == <span class="literal">NULL</span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">				</span><br><span class="line">			<span class="keyword">if</span>(cmdline[<span class="number">0</span>] == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			cmdline[<span class="built_in">strlen</span>(cmdline) - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">			<span class="built_in">parse_cmd</span>(cmdline, sock, &amp;servaddr);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(msg));</span><br><span class="line">	msg.cmd = <span class="built_in">htonl</span>(C2S_LOGOUT);</span><br><span class="line">	<span class="built_in">strcpy</span>(msg.body, username);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">sendto</span>(sock, (<span class="keyword">const</span> <span class="keyword">char</span>*)&amp;msg, <span class="built_in"><span class="keyword">sizeof</span></span>(msg), <span class="number">0</span>, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_DGRAM, <span class="number">0</span>)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">chat_cli</span>(sock);</span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h2><p><strong>thread.cpp</strong></p>
<p><strong>编译语句为：g++ thread.cpp -o thread -lpthread</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">thread_routine</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; ++i) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;B&quot;</span>);</span><br><span class="line">		<span class="built_in">fflush</span>(stdout);</span><br><span class="line">		<span class="built_in">usleep</span>(<span class="number">20</span>);</span><br><span class="line">		<span class="keyword">if</span>(i == <span class="number">3</span>)</span><br><span class="line">			<span class="built_in">pthread_exit</span>(<span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>*&gt;(<span class="string">&quot;ABC&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">pthread_t</span> tid;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">if</span>((ret = <span class="built_in">pthread_create</span>(&amp;tid, <span class="literal">NULL</span>, thread_routine, <span class="literal">NULL</span>)) != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;pthread_create:%s\n&quot;</span>, <span class="built_in">strerror</span>(ret));</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; ++i) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">		<span class="built_in">fflush</span>(stdout);</span><br><span class="line">		<span class="built_in">usleep</span>(<span class="number">20</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> *value;</span><br><span class="line">	<span class="keyword">if</span>((ret = <span class="built_in">pthread_join</span>(tid, &amp;value) != <span class="number">0</span>)) &#123;<span class="comment">//等待其他线程完成 </span></span><br><span class="line">		<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;pthread_join:%s\n&quot;</span>, <span class="built_in">strerror</span>(ret));</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\nreturn msg = %s\n&quot;</span>, (<span class="keyword">char</span>*)value);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多线程下的回射客户-服务器模型"><a href="#多线程下的回射客户-服务器模型" class="headerlink" title="多线程下的回射客户/服务器模型"></a>多线程下的回射客户/服务器模型</h3><p><strong>echosrv.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_service</span><span class="params">(<span class="keyword">int</span> conn)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//接收</span></span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="built_in">read</span>(conn, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;client close\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">write</span>(conn, recvbuf, ret);</span><br><span class="line">	&#125; 	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">thread_routine</span><span class="params">(<span class="keyword">void</span>* arg)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">pthread_detach</span>(<span class="built_in">pthread_self</span>());</span><br><span class="line">	<span class="keyword">int</span> conn = (<span class="keyword">int</span>)arg;</span><br><span class="line">	<span class="built_in">do_service</span>(conn);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;exiting thread……\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> listenfd;</span><br><span class="line">	<span class="keyword">if</span>((listenfd = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);<span class="comment">//绑定本机的任意地址 </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in"><span class="keyword">sizeof</span></span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//绑定</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">bind</span>(listenfd, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//监听</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//连接	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">peeraddr</span>;</span></span><br><span class="line">	<span class="keyword">socklen_t</span> peerlen = <span class="built_in"><span class="keyword">sizeof</span></span>(peeraddr);</span><br><span class="line">	<span class="keyword">int</span> conn;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>((conn = <span class="built_in">accept</span>(listenfd, (struct sockaddr*)&amp;peeraddr, &amp;peerlen)) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept&quot;</span>); </span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;ip=%s port=%d\n&quot;</span>, <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr), <span class="built_in">ntohs</span>(peeraddr.sin_port));</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">pthread_t</span> tid;</span><br><span class="line">		<span class="keyword">int</span> ret;</span><br><span class="line">		<span class="keyword">int</span> *p = <span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>));</span><br><span class="line">		*p = conn;</span><br><span class="line">		<span class="keyword">if</span>((ret = <span class="built_in">pthread_create</span>(&amp;tid, <span class="literal">NULL</span>, thread_routine, p)) != <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;pthread_create:%s\n&quot;</span>, <span class="built_in">strerror</span>(ret));</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>echocli.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建套接字 </span></span><br><span class="line">	<span class="keyword">int</span> sock;</span><br><span class="line">	<span class="keyword">if</span>((sock = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//地址初始化	</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span> <span class="comment">//IPv4地址结构</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr));</span><br><span class="line">	servaddr.sin_family = AF_INET;</span><br><span class="line">	servaddr.sin_port = <span class="built_in">htons</span>(<span class="number">5188</span>); </span><br><span class="line">	servaddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">connect</span>(sock, (struct sockaddr*)&amp;servaddr, <span class="built_in"><span class="keyword">sizeof</span></span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">ERR_EXIT</span>(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">char</span> sendbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> recvbuf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">while</span>(<span class="built_in">fgets</span>(sendbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf), stdin) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">write</span>(sock, sendbuf, <span class="built_in">strlen</span>(sendbuf));</span><br><span class="line">		<span class="built_in">read</span>(sock, recvbuf, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">		<span class="built_in">fputs</span>(recvbuf, stdout);</span><br><span class="line">		<span class="built_in">memset</span>(sendbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(sendbuf)); </span><br><span class="line">		<span class="built_in">memset</span>(recvbuf, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(recvbuf));</span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="built_in">close</span>(sock);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="信号量-互斥锁实现生产者-消费者模型"><a href="#信号量-互斥锁实现生产者-消费者模型" class="headerlink" title="信号量+互斥锁实现生产者-消费者模型"></a>信号量+互斥锁实现生产者-消费者模型</h3><p><strong>pctest.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONSUMERS_COUNT 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRODUCERS_COUNT 5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFSIZE 10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_buffer[BUFFSIZE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> in = <span class="number">0</span>;<span class="comment">//从0号位置开始存放 </span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> out = <span class="number">0</span>;<span class="comment">//从0号位置开始取走</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> produce_id = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> consumer_id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">sem_t</span> g_sem_full;</span><br><span class="line"><span class="keyword">sem_t</span> g_sem_empty;</span><br><span class="line"><span class="keyword">pthread_mutex_t</span> g_mutex;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_t</span> g_thread[CONSUMERS_COUNT + PRODUCERS_COUNT];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">consume</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> num = (<span class="keyword">long</span>)arg;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d wait buffer not empty\n&quot;</span>, num);</span><br><span class="line">		<span class="built_in">sem_wait</span>(&amp;g_sem_empty);</span><br><span class="line">		<span class="built_in">pthread_mutex_lock</span>(&amp;g_mutex);</span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; BUFFSIZE; ++i) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%02d &quot;</span>, i);</span><br><span class="line">			<span class="keyword">if</span>(g_buffer[i] == <span class="number">-1</span>)</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, <span class="string">&quot;null&quot;</span>);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, g_buffer[i]);</span><br><span class="line">			<span class="keyword">if</span>(i == out)</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;\t&lt;--consume&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> consume_id = g_buffer[out];</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d begin consume product %d\n&quot;</span>, num, consume_id);</span><br><span class="line">		g_buffer[out] = <span class="number">-1</span>;	</span><br><span class="line">		out = (out + <span class="number">1</span>) % BUFFSIZE;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d end consume product %d\n&quot;</span>, num, consume_id);</span><br><span class="line">		<span class="built_in">pthread_mutex_unlock</span>(&amp;g_mutex);</span><br><span class="line">		<span class="built_in">sem_post</span>(&amp;g_sem_full);	</span><br><span class="line">		<span class="built_in">sleep</span>(<span class="number">5</span>);	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">produce</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> num = (<span class="keyword">long</span>)arg;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d wait buffer not full\n&quot;</span>, num);</span><br><span class="line">		<span class="built_in">sem_wait</span>(&amp;g_sem_full);</span><br><span class="line">		<span class="built_in">pthread_mutex_lock</span>(&amp;g_mutex);</span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; BUFFSIZE; ++i) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%02d &quot;</span>, i);</span><br><span class="line">			<span class="keyword">if</span>(g_buffer[i] == <span class="number">-1</span>)</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, <span class="string">&quot;null&quot;</span>);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, g_buffer[i]);</span><br><span class="line">			<span class="keyword">if</span>(i == in)</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;\t&lt;--produce&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d begin produce product %d\n&quot;</span>, num, produce_id);</span><br><span class="line">		g_buffer[in] = produce_id;	</span><br><span class="line">		in = (in + <span class="number">1</span>) % BUFFSIZE;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d end produce product %d\n&quot;</span>, num, produce_id++);</span><br><span class="line">		<span class="built_in">pthread_mutex_unlock</span>(&amp;g_mutex);</span><br><span class="line">		<span class="built_in">sem_post</span>(&amp;g_sem_empty);	</span><br><span class="line">		<span class="built_in">sleep</span>(<span class="number">1</span>);	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; BUFFSIZE; ++i)</span><br><span class="line">		g_buffer[i] = <span class="number">-1</span>;</span><br><span class="line">	<span class="built_in">sem_init</span>(&amp;g_sem_full, <span class="number">0</span>, BUFFSIZE);</span><br><span class="line">	<span class="built_in">sem_init</span>(&amp;g_sem_empty, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">pthread_mutex_init</span>(&amp;g_mutex, <span class="literal">NULL</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; CONSUMERS_COUNT; ++i)</span><br><span class="line">		<span class="built_in">pthread_create</span>(&amp;g_thread[i], <span class="literal">NULL</span>, consume, (<span class="keyword">void</span>*)(<span class="keyword">long</span>)i);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; PRODUCERS_COUNT; ++i)</span><br><span class="line">		<span class="built_in">pthread_create</span>(&amp;g_thread[CONSUMERS_COUNT + i], <span class="literal">NULL</span>, produce, (<span class="keyword">void</span>*)(<span class="keyword">long</span>)i);	</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; CONSUMERS_COUNT + PRODUCERS_COUNT; ++i)</span><br><span class="line">		<span class="built_in">pthread_join</span>(g_thread[i], <span class="literal">NULL</span>);	</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">sem_destroy</span>(&amp;g_sem_full);</span><br><span class="line">	<span class="built_in">sem_destroy</span>(&amp;g_sem_empty);</span><br><span class="line">	<span class="built_in">pthread_mutex_destroy</span>(&amp;g_mutex);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="条件变量-互斥锁实现生产者-消费者模型"><a href="#条件变量-互斥锁实现生产者-消费者模型" class="headerlink" title="条件变量+互斥锁实现生产者-消费者模型"></a>条件变量+互斥锁实现生产者-消费者模型</h3><p><strong>pctest.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERR_EXIT(m) \</span></span><br><span class="line"><span class="meta">	do &#123; \</span></span><br><span class="line"><span class="meta">		perror(m); \</span></span><br><span class="line"><span class="meta">		exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">	&#125; while(0)</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONSUMERS_COUNT 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRODUCERS_COUNT 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_mutex_t</span> g_mutex;</span><br><span class="line"><span class="keyword">pthread_cond_t</span> g_cond;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_t</span> g_thread[CONSUMERS_COUNT + PRODUCERS_COUNT];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> nready = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">consume</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> num = (<span class="keyword">long</span>)arg;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">pthread_mutex_lock</span>(&amp;g_mutex);</span><br><span class="line">		<span class="keyword">while</span>(nready == <span class="number">0</span>) &#123;<span class="comment">//条件不满足则等待 </span></span><br><span class="line">			<span class="comment">//解锁，等待其他线程改变nready的值 </span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;consumer %d begin wait a condition...\n&quot;</span>, num);</span><br><span class="line">			<span class="built_in">pthread_cond_wait</span>(&amp;g_cond, &amp;g_mutex);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;consumer %d end wait a condition...\n&quot;</span>, num);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;consumer %d begin consume product...\n&quot;</span>, num);</span><br><span class="line">		--nready;</span><br><span class="line">		<span class="built_in">pthread_mutex_unlock</span>(&amp;g_mutex);</span><br><span class="line">		<span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">produce</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> num = (<span class="keyword">long</span>)arg;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">pthread_mutex_lock</span>(&amp;g_mutex);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;producer %d begin produce product...\n&quot;</span>, num);</span><br><span class="line">		++nready;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;producer %d end produce product...\n&quot;</span>, num);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;producer %d signal...\n&quot;</span>, num);</span><br><span class="line">		<span class="built_in">pthread_cond_signal</span>(&amp;g_cond);</span><br><span class="line">		<span class="built_in">pthread_mutex_unlock</span>(&amp;g_mutex);</span><br><span class="line">		<span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">pthread_mutex_init</span>(&amp;g_mutex, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="built_in">pthread_cond_init</span>(&amp;g_cond, <span class="literal">NULL</span>);</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; CONSUMERS_COUNT; ++i)</span><br><span class="line">		<span class="built_in">pthread_create</span>(&amp;g_thread[i], <span class="literal">NULL</span>, consume, (<span class="keyword">void</span>*)(<span class="keyword">long</span>)i);</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">sleep</span>(<span class="number">1</span>); </span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; PRODUCERS_COUNT; ++i)</span><br><span class="line">		<span class="built_in">pthread_create</span>(&amp;g_thread[CONSUMERS_COUNT + i], <span class="literal">NULL</span>, produce, (<span class="keyword">void</span>*)(<span class="keyword">long</span>)i);	</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; CONSUMERS_COUNT + PRODUCERS_COUNT; ++i)</span><br><span class="line">		<span class="built_in">pthread_join</span>(g_thread[i], <span class="literal">NULL</span>);	</span><br><span class="line">		</span><br><span class="line">	<span class="built_in">pthread_mutex_destroy</span>(&amp;g_mutex);</span><br><span class="line">	<span class="built_in">pthread_cond_destroy</span>(&amp;g_cond);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="简单的线程池实现"><a href="#简单的线程池实现" class="headerlink" title="简单的线程池实现"></a>简单的线程池实现</h2><p><strong>condition.h</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _CONDITION_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CONDITION_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">condition</span> &#123;</span></span><br><span class="line">	<span class="keyword">pthread_mutex_t</span> pmutex;</span><br><span class="line">	<span class="keyword">pthread_cond_t</span> pcond;</span><br><span class="line">&#125; <span class="keyword">condition_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_init</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_lock</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_unlock</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_wait</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_timedwait</span><span class="params">(<span class="keyword">condition_t</span> *cond, <span class="keyword">const</span> struct timespec *abstime)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_signal</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_broadcast</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_destroy</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _CONDITION_H_ */</span></span></span><br></pre></td></tr></table></figure>
<p><strong>condition.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;condition.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_init</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> status;</span><br><span class="line">	<span class="keyword">if</span>((status = <span class="built_in">pthread_mutex_init</span>(&amp;cond-&gt;pmutex, <span class="literal">NULL</span>)))</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>((status = <span class="built_in">pthread_cond_init</span>(&amp;cond-&gt;pcond, <span class="literal">NULL</span>)))</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_lock</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">pthread_mutex_lock</span>(&amp;cond-&gt;pmutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_unlock</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">pthread_mutex_unlock</span>(&amp;cond-&gt;pmutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_wait</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">pthread_cond_wait</span>(&amp;cond-&gt;pcond, &amp;cond-&gt;pmutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_timedwait</span><span class="params">(<span class="keyword">condition_t</span> *cond, <span class="keyword">const</span> struct timespec *abstime)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">pthread_cond_timedwait</span>(&amp;cond-&gt;pcond, &amp;cond-&gt;pmutex, abstime);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_signal</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">pthread_cond_signal</span>(&amp;cond-&gt;pcond);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_broadcast</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">pthread_cond_broadcast</span>(&amp;cond-&gt;pcond);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">condition_destroy</span><span class="params">(<span class="keyword">condition_t</span> *cond)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> status;</span><br><span class="line">	<span class="keyword">if</span>((status = <span class="built_in">pthread_mutex_destroy</span>(&amp;cond-&gt;pmutex)))</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">if</span>((status = <span class="built_in">pthread_cond_destroy</span>(&amp;cond-&gt;pcond)))</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>threadpool.h</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _THREAD_POOL_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _THREAD_POOL_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;condition.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">task</span> &#123;</span></span><br><span class="line">	<span class="keyword">void</span> *(*run)(<span class="keyword">void</span> *arg); <span class="comment">//任务回调函数</span></span><br><span class="line">	<span class="keyword">void</span> *arg;               <span class="comment">//回调函数参数</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task</span> *<span class="title">next</span>;</span> </span><br><span class="line">&#125; <span class="keyword">task_t</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">threadpool</span> &#123;</span></span><br><span class="line">	<span class="keyword">condition_t</span> ready; <span class="comment">//任务准备就绪或者线程池销毁通知</span></span><br><span class="line">	<span class="keyword">task_t</span> *first;     <span class="comment">//任务队列头指针</span></span><br><span class="line">	<span class="keyword">task_t</span> *last;      <span class="comment">//任务队列尾指针</span></span><br><span class="line">	<span class="keyword">int</span> counter;       <span class="comment">//线程池中当前线程数</span></span><br><span class="line">	<span class="keyword">int</span> idle;          <span class="comment">//线程池中当前正在等待任务的线程数</span></span><br><span class="line">	<span class="keyword">int</span> max_treads;    <span class="comment">//线程池中最大允许的线程数</span></span><br><span class="line">	<span class="keyword">int</span> quit;          <span class="comment">//销毁线程池的时候置1 </span></span><br><span class="line">&#125; <span class="keyword">threadpool_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化线程池 </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadpool_init</span><span class="params">(<span class="keyword">threadpool_t</span> *pool, <span class="keyword">int</span> threads)</span></span>;</span><br><span class="line"><span class="comment">//往线程池中添加任务</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadpool_add_task</span><span class="params">(<span class="keyword">threadpool_t</span> *pool, <span class="keyword">void</span> *(*run)(<span class="keyword">void</span> *arg), <span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"><span class="comment">//销毁线程池</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadpool_destroy</span><span class="params">(<span class="keyword">threadpool_t</span> *pool)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _THREAD_POOL_H_ */</span> </span></span><br></pre></td></tr></table></figure>
<p><strong>threadpool.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;threadpool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_routine</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">abstime</span>;</span></span><br><span class="line">	<span class="keyword">int</span> timeout;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x is starting\n&quot;</span>, (<span class="keyword">int</span>)<span class="built_in">pthread_self</span>());</span><br><span class="line">	<span class="keyword">threadpool_t</span> *pool = (<span class="keyword">threadpool_t</span> *)arg;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		timeout = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">condition_lock</span>(&amp;pool-&gt;ready);</span><br><span class="line">		pool-&gt;idle++;</span><br><span class="line">		<span class="comment">//等待队列有任务到来或者线程池销毁通知</span></span><br><span class="line">		<span class="keyword">while</span>(pool-&gt;first == <span class="literal">NULL</span> &amp;&amp; !pool-&gt;quit) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x is waiting\n&quot;</span>, (<span class="keyword">int</span>)<span class="built_in">pthread_self</span>());</span><br><span class="line">			<span class="built_in">clock_gettime</span>(CLOCK_REALTIME, &amp;abstime);</span><br><span class="line">			abstime.tv_sec += <span class="number">2</span>;</span><br><span class="line">			<span class="keyword">int</span> status = <span class="built_in">condition_timedwait</span>(&amp;pool-&gt;ready, &amp;abstime);</span><br><span class="line">			<span class="keyword">if</span>(status == ETIMEDOUT) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x is wait timed out\n&quot;</span>, (<span class="keyword">int</span>)<span class="built_in">pthread_self</span>());</span><br><span class="line">				timeout = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="comment">//等待到条件，处于工作状态 </span></span><br><span class="line">		pool-&gt;idle--;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//等待到任务 </span></span><br><span class="line">		<span class="keyword">if</span>(pool-&gt;first != <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="comment">//从队头取出任务 </span></span><br><span class="line">			<span class="keyword">task_t</span> *t = pool-&gt;first; </span><br><span class="line">			pool-&gt;first = t-&gt;next;</span><br><span class="line">			<span class="comment">//执行任务需要一定时间，所以要先解锁，以便生产者进程</span></span><br><span class="line">			<span class="comment">//能够往队列中添加新任务，其他消费者进程能够进入等待任务 </span></span><br><span class="line">			<span class="built_in">condition_unlock</span>(&amp;pool-&gt;ready);</span><br><span class="line">			t-&gt;<span class="built_in">run</span>(t-&gt;arg);</span><br><span class="line">			<span class="built_in">free</span>(t);</span><br><span class="line">			<span class="built_in">condition_lock</span>(&amp;pool-&gt;ready);</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="comment">//如果等待到线程池销毁通知，且任务都执行完毕 </span></span><br><span class="line">		<span class="keyword">if</span>(pool-&gt;quit &amp;&amp; pool-&gt;first == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			pool-&gt;counter--;</span><br><span class="line">			<span class="keyword">if</span>(pool-&gt;counter == <span class="number">0</span>)</span><br><span class="line">				<span class="built_in">condition_signal</span>(&amp;pool-&gt;ready);</span><br><span class="line">			<span class="comment">//跳出循环之前要基带解锁 </span></span><br><span class="line">			<span class="built_in">condition_unlock</span>(&amp;pool-&gt;ready);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; </span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(timeout &amp;&amp; pool-&gt;first == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			pool-&gt;counter--;</span><br><span class="line">			<span class="comment">//跳出循环之前要基带解锁 </span></span><br><span class="line">			<span class="built_in">condition_unlock</span>(&amp;pool-&gt;ready);</span><br><span class="line">			<span class="keyword">break</span>;	</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">condition_unlock</span>(&amp;pool-&gt;ready);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x is exiting\n&quot;</span>, (<span class="keyword">int</span>)<span class="built_in">pthread_self</span>());</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化线程池 </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadpool_init</span><span class="params">(<span class="keyword">threadpool_t</span> *pool, <span class="keyword">int</span> threads)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//对线程池中的各个字段初始化 </span></span><br><span class="line">	<span class="built_in">condition_init</span>(&amp;pool-&gt;ready);</span><br><span class="line">	pool-&gt;first = <span class="literal">NULL</span>;</span><br><span class="line">	pool-&gt;last = <span class="literal">NULL</span>;</span><br><span class="line">	pool-&gt;counter = <span class="number">0</span>;</span><br><span class="line">	pool-&gt;idle = <span class="number">0</span>;</span><br><span class="line">	pool-&gt;max_treads = threads;</span><br><span class="line">	pool-&gt;quit = <span class="number">0</span>;</span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"><span class="comment">//往线程池中添加任务</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadpool_add_task</span><span class="params">(<span class="keyword">threadpool_t</span> *pool, <span class="keyword">void</span> *(*run)(<span class="keyword">void</span> *arg), <span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//生成新任务 </span></span><br><span class="line">	<span class="keyword">task_t</span> *newtask = (<span class="keyword">task_t</span> *)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">task_t</span>));</span><br><span class="line">	newtask-&gt;run = run;</span><br><span class="line">	newtask-&gt;arg = arg;</span><br><span class="line">	newtask-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">condition_lock</span>(&amp;pool-&gt;ready);</span><br><span class="line">	<span class="comment">//将任务添加到队列</span></span><br><span class="line">	<span class="keyword">if</span>(pool-&gt;first == <span class="literal">NULL</span>)</span><br><span class="line">		pool-&gt;first = newtask;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	 	pool-&gt;last-&gt;next = newtask;</span><br><span class="line">	pool-&gt;last = newtask;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//如果有等待线程，则唤醒其中一个 </span></span><br><span class="line">	<span class="keyword">if</span>(pool-&gt;idle &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">condition_signal</span>(&amp;pool-&gt;ready);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(pool-&gt;counter &lt; pool-&gt;max_treads) &#123;</span><br><span class="line">		<span class="comment">//没有等待线程，并且当前线程数不超过最大线程数，则创建一个新线程</span></span><br><span class="line">		<span class="keyword">pthread_t</span> tid;</span><br><span class="line">		<span class="built_in">pthread_create</span>(&amp;tid, <span class="literal">NULL</span>, thread_routine, pool);</span><br><span class="line">		pool-&gt;counter++;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">condition_unlock</span>(&amp;pool-&gt;ready);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//销毁线程池</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">threadpool_destroy</span><span class="params">(<span class="keyword">threadpool_t</span> *pool)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(pool-&gt;quit) </span><br><span class="line">		<span class="keyword">return</span>; </span><br><span class="line">		</span><br><span class="line">	<span class="built_in">condition_lock</span>(&amp;pool-&gt;ready);	</span><br><span class="line">	pool-&gt;quit = <span class="number">1</span>;	</span><br><span class="line">	<span class="keyword">if</span>(pool-&gt;counter &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>(pool-&gt;idle &gt; <span class="number">0</span>) </span><br><span class="line">			<span class="built_in">condition_broadcast</span>(&amp;pool-&gt;ready);</span><br><span class="line">			</span><br><span class="line">		<span class="comment">//处于执行任务状态中的线程，不会收到广播 </span></span><br><span class="line">		<span class="comment">//线程池需要等待执行任务状态中的线程全部退出 	</span></span><br><span class="line">		<span class="keyword">while</span>(pool-&gt;counter &gt; <span class="number">0</span>) </span><br><span class="line">			<span class="built_in">condition_wait</span>(&amp;pool-&gt;ready);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">condition_unlock</span>(&amp;pool-&gt;ready);</span><br><span class="line">	<span class="built_in">condition_destroy</span>(&amp;pool-&gt;ready);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>main.cpp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;threadpool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">mytask</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x is working on task %d\n&quot;</span>, (<span class="keyword">int</span>)<span class="built_in">pthread_self</span>(), *(<span class="keyword">int</span>*)arg);</span><br><span class="line">	<span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">free</span>(arg);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">threadpool_t</span> pool;</span><br><span class="line">	<span class="built_in">threadpool_init</span>(&amp;pool, <span class="number">3</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">		<span class="keyword">int</span> *arg = (<span class="keyword">int</span>*)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>));</span><br><span class="line">		*arg = i;</span><br><span class="line">		<span class="built_in">threadpool_add_task</span>(&amp;pool, mytask, arg);		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">threadpool_destroy</span>(&amp;pool);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p><strong>Makefile</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">OBJS = main.o threadpool.o condition.o</span><br><span class="line">main: $(OBJS)</span><br><span class="line">	g++ $(OBJS) -o main -lpthread -lrt</span><br><span class="line">main.o: main.cpp threadpool.h condition.h</span><br><span class="line">	g++ -c main.cpp -o main.o</span><br><span class="line">threadpool.o: threadpool.cpp threadpool.h condition.h</span><br><span class="line">	g++ -c threadpool.cpp -o threadpool.o</span><br><span class="line">condition.o: condition.cpp condition.h</span><br><span class="line">	g++ -c condition.cpp -o condition.o</span><br><span class="line">clean:</span><br><span class="line">	rm -rf *.o main</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag"># 网络编程</a>
              <a href="/tags/%E6%BA%90%E7%A0%81/" rel="tag"># 源码</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/08/29/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A0%91/" rel="prev" title="数据结构-树">
                  <i class="fa fa-chevron-left"></i> 数据结构-树
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/09/05/VSCode-Depoly/" rel="next" title="VSCode的C++环境搭建">
                  VSCode的C++环境搭建 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Albert -W</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
